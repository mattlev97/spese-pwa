<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dettaglio Spesa</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
</head>
<body>
  <header>
    <h1>Dettaglio Spesa</h1>
    <nav class="top-nav">
      <a href="index.html">Dashboard</a>
      <a href="aggiungi.html">Aggiungi</a>
      <a href="archivio.html" class="nav-active">Archivio</a>
      <a href="impostazioni.html">Impostazioni</a>
    </nav>
  </header>

  <main>
    <section id="expenseHeader" style="margin-bottom:12px;"></section>

    <section>
      <h2>Prodotti</h2>
      <div id="productsContainer"></div>

      <h3 style="margin-top:14px;">Aggiungi prodotto dimenticato</h3>
      <div style="display:grid;gap:10px;grid-template-columns: 1fr 1fr;">
        <input id="newName" class="form-input" placeholder="Nome prodotto" />
        <select id="newCategory" class="form-input">
          <option value="">Seleziona tipologia</option>
          <option>Carne</option><option>Pesce</option><option>Verdura</option><option>Frutta</option>
          <option>Latticini</option><option>Pane</option><option>Bevande</option><option>Surgelati</option>
          <option>Dolci</option><option>Pulizia</option><option>Igiene</option><option>Altro</option>
        </select>
        <input id="newPrice" class="form-input" placeholder="Prezzo (‚Ç¨)" inputmode="decimal" />
        <input id="newNotes" class="form-input" placeholder="Note (opzionale)" />
      </div>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <button id="addNewProductBtn" class="btn">‚ûï Aggiungi prodotto</button>
        <button id="saveChangesBtn" class="btn">üíæ Salva modifiche</button>
        <a id="backToArchive" class="btn btn-secondary" href="archivio.html">‚óÄ Torna all'archivio</a>
      </div>
    </section>
  </main>

  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a class="nav-item" href="index.html" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a class="nav-item" href="aggiungi.html" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a class="nav-item" href="archivio.html" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a class="nav-item nav-active" href="impostazioni.html" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <script src="app.js"></script>
  <script>
    function q(sel, ctx=document) { return ctx.querySelector(sel); }
    function escapeHtml(text) { const d=document.createElement('div'); d.textContent = text||''; return d.innerHTML; }
    function getQueryParam(name) { const params = new URLSearchParams(location.search); return params.get(name); }

    const expenseId = getQueryParam('id');
    if (!expenseId) { location.href = 'archivio.html'; }

    function renderHeader(exp) {
      const container = document.getElementById('expenseHeader');
      if (!container) return;
      container.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div style="min-width:0">
            <strong>üè™ ${escapeHtml(exp.store)}</strong><br>
            <small style="color:var(--text-secondary)">üìÖ ${app.formatDate(exp.date)} ‚Ä¢ creato: ${new Date(exp.createdAt).toLocaleString()}</small>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:800; font-size:1.15rem;">${app.formatCurrency(exp.total)}</div>
            <div style="color:var(--text-secondary)">${(exp.products||[]).length} prodotti</div>
          </div>
        </div>
      `;
    }

    function renderProductsEditable(exp) {
      const container = document.getElementById('productsContainer');
      if (!container) return;
      const prods = Array.isArray(exp.products) ? exp.products.slice() : [];
      if (prods.length === 0) {
        container.innerHTML = '<div class="no-expenses">Nessun prodotto in questa spesa.</div>';
        return;
      }

      // Each product shows image (if available) on the left.
      container.innerHTML = prods.map((p, idx) => `
        <div class="product-item" data-idx="${idx}" style="display:grid;grid-template-columns: 64px 1fr 100px 40px; gap:8px; align-items:center; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.03);">
          <div>
            ${p.image ? `<img src="${escapeHtml(p.image)}" class="thumb" alt="${escapeHtml(p.name || '')}">` : `<div class="image-placeholder">No foto</div>`}
          </div>
          <div style="min-width:0;">
            <input class="prod-name form-input" value="${escapeHtml(p.name || '')}" />
            <input class="prod-notes form-input" style="margin-top:6px;" value="${escapeHtml(p.notes || '')}" placeholder="Note (opzionale)" />
          </div>
          <div>
            <input class="prod-price form-input" value="${Number(p.price||0).toFixed(2)}" inputmode="decimal" />
            <input class="prod-category form-input" style="margin-top:6px;" value="${escapeHtml(p.category || '')}" />
          </div>
          <div>
            <button class="remove-prod remove-btn" type="button" title="Rimuovi prodotto">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function loadExpenseAndRender() {
      const exp = app.getExpenseById(expenseId);
      if (!exp) { alert('Spesa non trovata.'); location.href = 'archivio.html'; return; }
      renderHeader(exp);
      renderProductsEditable(exp);
    }

    document.addEventListener('DOMContentLoaded', () => {
      (function syncBottomNavActive() {
        const path = location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('.bottom-nav .nav-item').forEach(a => {
          const href = a.getAttribute('href') || '';
          a.classList.toggle('nav-active', href.endsWith(path));
        });
      })();

      // remove product row
      document.addEventListener('click', (e) => {
        if (e.target && e.target.matches('.remove-prod')) {
          const row = e.target.closest('.product-item');
          if (!row) return;
          if (!confirm('Rimuovere questo prodotto?')) return;
          row.remove();
        }
      });

      document.getElementById('addNewProductBtn')?.addEventListener('click', (e) => {
        e.preventDefault();
        const name = (document.getElementById('newName')?.value || '').trim();
        const category = (document.getElementById('newCategory')?.value || '').trim() || 'Altro';
        const priceRaw = (document.getElementById('newPrice')?.value || '').trim();
        const price = parseFloat(priceRaw);
        const notes = (document.getElementById('newNotes')?.value || '').trim();

        if (!name || isNaN(price) || price < 0) {
          alert('Inserisci nome e prezzo valido per il prodotto.');
          return;
        }

        const container = document.getElementById('productsContainer');
        const idx = (container.querySelectorAll('.product-item').length) || 0;
        const newRow = document.createElement('div');
        newRow.className = 'product-item';
        newRow.dataset.idx = idx;
        newRow.style = 'display:grid;grid-template-columns: 64px 1fr 100px 40px; gap:8px; align-items:center; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.03);';

        newRow.innerHTML = `
          <div><div class="image-placeholder">No foto</div></div>
          <div style="min-width:0;">
            <input class="prod-name form-input" value="${escapeHtml(name)}" />
            <input class="prod-notes form-input" style="margin-top:6px;" value="${escapeHtml(notes)}" placeholder="Note (opzionale)" />
          </div>
          <div>
            <input class="prod-price form-input" value="${Number(price).toFixed(2)}" inputmode="decimal" />
            <input class="prod-category form-input" style="margin-top:6px;" value="${escapeHtml(category)}" />
          </div>
          <div>
            <button class="remove-prod remove-btn" type="button" title="Rimuovi prodotto">üóëÔ∏è</button>
          </div>
        `;
        container.appendChild(newRow);

        document.getElementById('newName').value = '';
        document.getElementById('newCategory').value = '';
        document.getElementById('newPrice').value = '';
        document.getElementById('newNotes').value = '';
      });

      document.getElementById('saveChangesBtn')?.addEventListener('click', (e) => {
        e.preventDefault();
        const container = document.getElementById('productsContainer');
        if (!container) return;
        const rows = container.querySelectorAll('.product-item');
        const products = [];
        for (const row of rows) {
          const name = row.querySelector('.prod-name')?.value?.trim() || '';
          const priceRaw = row.querySelector('.prod-price')?.value?.trim() || '';
          const price = parseFloat(priceRaw);
          const category = row.querySelector('.prod-category')?.value?.trim() || 'Altro';
          const notes = row.querySelector('.prod-notes')?.value?.trim() || '';
          // image: if original had img element, keep src
          const imgEl = row.querySelector('img.thumb');
          const image = imgEl ? imgEl.src : null;
          if (!name) { alert('Ogni prodotto deve avere un nome.'); return; }
          if (isNaN(price) || price < 0) { alert('Controlla i prezzi: assicurati siano numerici e >= 0.'); return; }
          products.push({ id: app.generateId(), name, price, category, notes, image });
        }
        const success = app.updateExpenseProducts(expenseId, products);
        if (!success) { alert('Errore salvataggio modifiche'); return; }
        alert('Modifiche salvate con successo.');
        loadExpenseAndRender();
        document.dispatchEvent(new CustomEvent('app:expenses-changed', { detail: app.expenses }));
      });

      loadExpenseAndRender();
    });
  </script>
</body>
</html>