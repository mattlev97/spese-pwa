<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dettaglio Spesa</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="" crossorigin="anonymous">

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Dettaglio Spesa</h1>
    <nav class="top-nav" role="navigation" aria-label="Menu principale">
      <a href="index.html">Dashboard</a>
      <a href="aggiungi.html">Aggiungi</a>
      <a href="archivio.html" class="nav-active">Archivio</a>
      <a href="impostazioni.html">Impostazioni</a>
    </nav>
  </header>

  <main>
    <section id="expenseHeader" style="margin-bottom:12px;"></section>

    <section>
      <h2>Prodotti</h2>
      <div id="productsContainer" aria-live="polite"></div>

      <h3 style="margin-top:14px;">Aggiungi prodotto dimenticato</h3>

      <div class="form-row" style="margin-bottom:8px;">
        <div class="form-group">
          <label for="newName">Nome prodotto</label>
          <input id="newName" class="form-input" type="text" placeholder="Es. Latte" aria-label="Nome prodotto" />
        </div>

        <div class="form-group">
          <label for="newCategory">Tipologia</label>
          <select id="newCategory" class="form-input" aria-label="Tipologia prodotto">
            <option value="">Seleziona tipologia</option>
            <option>Carne</option><option>Pesce</option><option>Verdura</option><option>Frutta</option>
            <option>Latticini</option><option>Pane</option><option>Bevande</option><option>Surgelati</option>
            <option>Dolci</option><option>Pulizia</option><option>Igiene</option><option>Altro</option>
          </select>
        </div>
      </div>

      <div class="form-row" style="margin-bottom:6px;">
        <div class="form-group">
          <label for="newPrice">Prezzo (‚Ç¨)</label>
          <input id="newPrice" class="form-input" type="number" step="0.01" min="0" placeholder="0.00" inputmode="decimal" aria-label="Prezzo prodotto" />
        </div>

        <div class="form-group">
          <label for="newNotes">Note (opzionale)</label>
          <input id="newNotes" class="form-input" type="text" placeholder="Note (opzionale)" aria-label="Note prodotto" />
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="addNewProductBtn" class="btn" type="button">‚ûï Aggiungi prodotto</button>
        <button id="saveChangesBtn" class="btn" type="button">üíæ Salva modifiche</button>
        <a id="backToArchive" class="btn btn-secondary" href="archivio.html">‚óÄ Torna all'archivio</a>
      </div>
    </section>
  </main>

  <!-- bottom navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a class="nav-item" href="index.html" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a class="nav-item" href="aggiungi.html" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a class="nav-item" href="archivio.html" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a class="nav-item nav-active" href="impostazioni.html" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <script src="app.js"></script>
  <script>
    // utilities
    function q(sel, ctx=document) { return ctx.querySelector(sel); }
    function qAll(sel, ctx=document) { return Array.from((ctx||document).querySelectorAll(sel)); }
    function escapeHtml(text) { const d=document.createElement('div'); d.textContent = text||''; return d.innerHTML; }

    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name);
    }

    const expenseId = getQueryParam('id');
    if (!expenseId) {
      // redirect back to archive if no id
      location.href = 'archivio.html';
    }

    function renderHeader(exp) {
      const container = document.getElementById('expenseHeader');
      if (!container) return;
      container.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <div style="min-width:0;flex:1;">
            <strong style="font-size:1.05rem;">üè™ ${escapeHtml(exp.store)}</strong><br>
            <small style="color:var(--text-secondary)">üìÖ ${app.formatDate(exp.date)} ‚Ä¢ creato: ${new Date(exp.createdAt).toLocaleString()}</small>
          </div>
          <div style="text-align:right; min-width:140px;">
            <div style="font-weight:800; font-size:1.18rem;">${app.formatCurrency(exp.total)}</div>
            <div style="color:var(--text-secondary)">${(exp.products||[]).length} prodotti</div>
          </div>
        </div>
      `;
    }

    function renderProductsEditable(exp) {
      const container = document.getElementById('productsContainer');
      if (!container) return;
      const prods = Array.isArray(exp.products) ? exp.products.slice() : [];
      if (prods.length === 0) {
        container.innerHTML = '<div class="no-expenses">Nessun prodotto in questa spesa.</div>';
        return;
      }

      container.innerHTML = prods.map((p, idx) => `
        <div class="product-item" data-idx="${idx}">
          <input class="prod-name" type="text" aria-label="Nome prodotto ${idx+1}" value="${escapeHtml(p.name || '')}" />
          <input class="prod-price" type="number" step="0.01" min="0" aria-label="Prezzo prodotto ${idx+1}" value="${Number(p.price||0).toFixed(2)}" inputmode="decimal" />
          <input class="prod-category" type="text" aria-label="Categoria prodotto ${idx+1}" value="${escapeHtml(p.category || '')}" />
          <button class="remove-prod remove-btn" type="button" title="Rimuovi prodotto">üóëÔ∏è</button>
          <div>
            <input class="prod-notes" type="text" aria-label="Note prodotto ${idx+1}" placeholder="Note (opzionale)" value="${escapeHtml(p.notes || '')}" />
          </div>
        </div>
      `).join('');
    }

    function loadExpenseAndRender() {
      const exp = (typeof app?.getExpenseById === 'function') ? app.getExpenseById(expenseId) : null;
      if (!exp) {
        alert('Spesa non trovata.');
        location.href = 'archivio.html';
        return;
      }
      renderHeader(exp);
      renderProductsEditable(exp);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // sync bottom-nav active item with the current path
      (function syncBottomNavActive() {
        const path = location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('.bottom-nav .nav-item').forEach(a => {
          const href = a.getAttribute('href') || '';
          a.classList.toggle('nav-active', href.endsWith(path));
        });
      })();

      // remove product row
      document.addEventListener('click', (e) => {
        if (e.target && e.target.matches('.remove-prod')) {
          const row = e.target.closest('.product-item');
          if (!row) return;
          if (!confirm('Rimuovere questo prodotto?')) return;
          row.remove();
        }
      });

      document.getElementById('addNewProductBtn')?.addEventListener('click', (e) => {
        e.preventDefault();
        const name = (document.getElementById('newName')?.value || '').trim();
        const category = (document.getElementById('newCategory')?.value || '').trim() || 'Altro';
        const priceRaw = (document.getElementById('newPrice')?.value || '').trim();
        const price = parseFloat(priceRaw);
        const notes = (document.getElementById('newNotes')?.value || '').trim();

        if (!name || isNaN(price) || price < 0) {
          alert('Inserisci nome e prezzo valido per il prodotto.');
          return;
        }

        const container = document.getElementById('productsContainer');
        const idx = (container.querySelectorAll('.product-item').length) || 0;
        const newRow = document.createElement('div');
        newRow.className = 'product-item';
        newRow.dataset.idx = idx;

        newRow.innerHTML = `
          <input class="prod-name" type="text" aria-label="Nome prodotto nuovo" value="${escapeHtml(name)}" />
          <input class="prod-price" type="number" step="0.01" min="0" aria-label="Prezzo prodotto nuovo" value="${Number(price).toFixed(2)}" inputmode="decimal" />
          <input class="prod-category" type="text" aria-label="Categoria prodotto nuovo" value="${escapeHtml(category)}" />
          <button class="remove-prod remove-btn" type="button" title="Rimuovi prodotto">üóëÔ∏è</button>
          <div>
            <input class="prod-notes" type="text" aria-label="Note prodotto nuovo" placeholder="Note (opzionale)" value="${escapeHtml(notes)}" />
          </div>
        `;
        container.appendChild(newRow);

        document.getElementById('newName').value = '';
        document.getElementById('newCategory').value = '';
        document.getElementById('newPrice').value = '';
        document.getElementById('newNotes').value = '';
      });

      document.getElementById('saveChangesBtn')?.addEventListener('click', (e) => {
        e.preventDefault();
        const container = document.getElementById('productsContainer');
        if (!container) return;

        const rows = container.querySelectorAll('.product-item');
        const products = [];
        for (const row of rows) {
          const name = row.querySelector('.prod-name')?.value?.trim() || '';
          const priceRaw = row.querySelector('.prod-price')?.value?.trim() || '';
          const price = parseFloat(priceRaw);
          const category = row.querySelector('.prod-category')?.value?.trim() || 'Altro';
          const notes = row.querySelector('.prod-notes')?.value?.trim() || '';

          if (!name) { alert('Ogni prodotto deve avere un nome.'); return; }
          if (isNaN(price) || price < 0) { alert('Controlla i prezzi: assicurati siano numerici e >= 0.'); return; }

          products.push({ id: (typeof app?.generateId === 'function' ? app.generateId() : String(Math.random())), name, price, category, notes });
        }

        // usa la funzione app.updateExpenseProducts se presente
        const success = (typeof app?.updateExpenseProducts === 'function') ? app.updateExpenseProducts(expenseId, products) : false;
        if (!success) {
          // se la funzione non esiste segnalalo ma non bloccare tutto (comportamento di fallback)
          if (typeof app?.updateExpenseProducts !== 'function') {
            alert('Salvataggio non disponibile: funzione mancante. Verifica app.js.');
          } else {
            alert('Errore salvataggio modifiche');
          }
          return;
        }

        alert('Modifiche salvate con successo.');
        loadExpenseAndRender();
        document.dispatchEvent(new CustomEvent('app:expenses-changed', { detail: app.expenses }));
      });

      // initial load
      loadExpenseAndRender();
    });
  </script>
</body>
</html>