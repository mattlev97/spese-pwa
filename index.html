<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GroceryHub - Dashboard</title>

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="FDE6748E-E787-40BF-B6FD-203C136F8138.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Stile principale (manteniamo style.css ma sovrascriviamo alcune variabili per la dashboard) -->
  <link rel="stylesheet" href="style.css?v=20250816">

  <style>
    /* Palette e override per la dashboard (bianco + salvia + senape + terracotta) */
    :root {
      --gh-bg: #ffffff;
      --gh-salvia: #7aa986;      /* salvia green */
      --gh-mustard: #d6a63f;    /* senape */
      --gh-terracotta: #c7683c; /* terracotta */
      --gh-terracotta-light: rgba(199,104,60,0.12);
      --gh-text-strong: #222428; /* grocery color (non troppo scuro) */
      --gh-muted: #5b5f63;
    }

    /* Override generali per questa pagina */
    body {
      background: var(--gh-bg) !important;
      color: var(--gh-text-strong);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    header {
      background: transparent;
      padding: 18px 18px 10px 18px;
      box-shadow: none;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* hamburger */
    .hamburger {
      width: 42px;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: rgba(0,0,0,0.04);
      cursor: pointer;
    }
    .hamburger i { color: var(--gh-text-strong); font-size: 18px; }

    /* Title left aligned */
    .title-wrap {
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
      flex: 1;
    }
    .title-row {
      display:flex;
      align-items:baseline;
      gap:8px;
    }
    .grocery {
      font-weight: 400;
      color: var(--gh-text-strong);
      font-size: 1.6rem;
      margin:0;
    }
    .hub {
      font-weight: 800;
      color: var(--gh-salvia);
      font-size: 1.6rem;
      margin:0;
    }
    .payoff {
      font-style: italic;
      color: var(--gh-muted);
      font-size: 0.95rem;
      margin-top: 2px;
    }

    main.dashboard {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Layout calendar */
    .calendar-wrap {
      margin-top: 10px;
      margin-bottom: 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .calendar-row {
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      padding: 6px 0;
    }

    .day-pill {
      min-width: 86px;
      max-width: 120px;
      padding: 12px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      border-radius: 24px;
      background: white;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      border: 1px solid rgba(0,0,0,0.04);
      cursor: pointer;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
    }
    .day-pill .day-num { font-size: 1.4rem; font-weight:700; color: var(--gh-text-strong); }
    .day-pill .day-name { font-size: 0.85rem; color: var(--gh-muted); text-transform: capitalize; }
    .day-pill .month { font-size: 0.82rem; color: var(--gh-muted); }

    /* selected (today or chosen) */
    .day-pill.selected {
      background: linear-gradient(180deg, var(--gh-terracotta), var(--gh-terracotta));
      color: #fff;
      border-color: rgba(0,0,0,0.05);
      box-shadow: 0 10px 30px rgba(199,104,60,0.14);
      transform: translateY(-4px);
    }
    .day-pill.selected .day-num,
    .day-pill.selected .day-name,
    .day-pill.selected .month { color: #fff; }

    /* dot indicator for days with expenses */
    .day-pill .has-expense-dot {
      width:8px; height:8px; border-radius:50%; background: var(--gh-salvia); margin-top:4px; opacity:0.95;
    }
    .day-pill .has-expense-dot.hidden { opacity:0; }

    /* summary drawer (terracotta light) */
    .day-summary {
      display:none;
      margin-top:6px;
      padding: 12px;
      background: var(--gh-terracotta-light);
      color: var(--gh-text-strong);
      border-radius: 10px;
    }
    .day-summary.show { display:block; }

    /* blocks (colored) */
    .blocks {
      display:flex;
      gap:12px;
      margin-top: 12px;
      align-items: stretch;
      flex-wrap:wrap;
    }
    .block {
      flex: 1 1 180px;
      border-radius: 12px;
      padding: 12px;
      color: #fff;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      min-height:84px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    .block .label { font-size:0.86rem; opacity:0.95; }
    .block .value { font-size:1.3rem; font-weight:800; }

    .block.total { background: var(--gh-salvia); }
    .block.max { background: var(--gh-mustard); color:#111; }
    .block.min { background: #ffa87f; } /* lighter terracotta-ish for min (fallback) */
    .block.count { background: var(--gh-terracotta); }

    /* inside total block: donut canvas */
    .donut-wrap { width:110px; height:110px; display:flex; align-items:center; justify-content:center; border-radius:8px; background: rgba(255,255,255,0.06); padding:8px; }

    /* charts section adapt palette */
    .charts-section .chart-container { background: transparent; border: none; box-shadow:none; padding:0; }
    .chart-legend { margin-top:8px; color:var(--gh-muted); }

    /* responsive */
    @media (max-width: 880px) {
      .day-pill { min-width:80px; }
      .donut-wrap { width:88px; height:88px; }
      .blocks { gap:10px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="hamburger" id="menuToggle" aria-label="Apri menu" title="Apri menu">
      <i class="fa-solid fa-bars"></i>
    </div>

    <div class="title-wrap" role="banner">
      <div class="title-row">
        <h1 class="grocery">Grocery</h1>
        <h1 class="hub">Hub</h1>
      </div>
      <div class="payoff">Controlla, risparmia, vivi meglio</div>
    </div>
  </header>

  <!-- simple off-canvas menu -->
  <nav id="sideMenu" style="display:none; position:fixed; left:0; top:0; bottom:0; width:78%; max-width:320px; background:#fff; z-index:2500; box-shadow: 6px 0 30px rgba(0,0,0,0.12); padding:18px;">
    <button id="menuClose" style="background:none;border:none;font-size:18px;display:block;margin-bottom:12px;">Chiudi ‚úï</button>
    <ul style="list-style:none;padding:0;margin:0;">
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="aggiungi.html">Aggiungi</a></li>
      <li><a href="archivio.html">Archivio</a></li>
      <li><a href="impostazioni.html">Impostazioni</a></li>
    </ul>
  </nav>

  <main class="dashboard" role="main">
    <!-- calendar -->
    <section class="calendar-wrap" aria-label="Selezione giorno">
      <div class="calendar-row" id="calendarRow" aria-hidden="false"></div>
      <div id="daySummary" class="day-summary" aria-live="polite"></div>
    </section>

    <!-- colored blocks with donut -->
    <section>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="font-weight:700;font-size:1.06rem;">Riepilogo</div>
        <div>
          <label for="periodSelect" style="margin-right:8px;color:var(--gh-muted);font-size:0.95rem;">Periodo</label>
          <select id="periodSelect" style="padding:6px 8px;border-radius:8px;border:1px solid #ddd;">
            <option value="settimana">Settimana</option>
            <option value="mese" selected>Mese</option>
            <option value="anno">Anno</option>
          </select>
        </div>
      </div>

      <div class="blocks">
        <div class="block total">
          <div>
            <div class="label">Totale spese</div>
            <div id="totalAmountBlock" class="value">‚Ç¨0.00</div>
          </div>
          <div class="donut-wrap">
            <canvas id="budgetChart" width="120" height="120" aria-hidden="true"></canvas>
          </div>
        </div>

        <div class="block max">
          <div>
            <div class="label">Spesa massima</div>
            <div id="maxAmountBlock" class="value">‚Ç¨0.00</div>
            <div style="font-size:0.85rem;color:rgba(0,0,0,0.7)" id="maxStoreBlock"></div>
          </div>
        </div>

        <div class="block min">
          <div>
            <div class="label">Spesa minima</div>
            <div id="minAmountBlock" class="value">‚Ç¨0.00</div>
            <div style="font-size:0.85rem;color:rgba(0,0,0,0.7)" id="minStoreBlock"></div>
          </div>
        </div>

        <div class="block count">
          <div>
            <div class="label">Numero spese</div>
            <div id="countBlock" class="value">0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- charts (kept existing) -->
    <section class="charts-section" aria-label="Grafici comparativi" style="margin-top:18px;">
      <div class="chart-container">
        <h3>üè™ Supermercati Pi√π Usati</h3>
        <canvas id="storeChart" width="300" height="300" role="img" aria-label="Grafico supermercati pi√π usati"></canvas>
        <div id="storeStats" class="chart-legend"></div>
      </div>

      <div class="chart-container">
        <h3>üõí Tipologie Prodotti</h3>
        <canvas id="categoryChart" width="300" height="300" role="img" aria-label="Grafico tipologie prodotti"></canvas>
        <div id="categoryStats" class="chart-legend"></div>
      </div>
    </section>

    <!-- recent -->
    <section style="margin-top:18px;">
      <h3>üïê Ultime Spese</h3>
      <div id="recentList" class="recent-list"></div>
    </section>
  </main>

  <!-- bottom nav (kept, style.css handles look) -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a href="index.html" class="nav-item nav-active">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a href="aggiungi.html" class="nav-item">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a href="archivio.html" class="nav-item">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a href="impostazioni.html" class="nav-item">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <script src="app.js"></script>

  <script>
    // === Helper: settings (budget) ===
    const SETTINGS_KEY = 'gh_settings';
    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (!raw) {
          const def = { weeklyBudget: 100 }; // default weekly budget (euros)
          localStorage.setItem(SETTINGS_KEY, JSON.stringify(def));
          return def;
        }
        return JSON.parse(raw);
      } catch (e) {
        return { weeklyBudget: 100 };
      }
    }
    function saveSettings(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s || {})); }
    function getBudgetForPeriod(period) {
      const s = loadSettings();
      const w = parseFloat(s.weeklyBudget) || 0;
      switch(period) {
        case 'settimana': return w;
        case 'mese': return w * 4;
        case 'anno': return w * 52;
        default: return w * 4;
      }
    }

    // === Calendar render + interaction ===
    const calendarRow = document.getElementById('calendarRow');
    const daySummary = document.getElementById('daySummary');
    let selectedDateKey = null; // YYYY-MM-DD

    function formatKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function shortDayName(d) {
      return d.toLocaleDateString('it-IT', { weekday: 'short' }); // e.g. "lun"
    }
    function shortMonth(d) {
      return d.toLocaleDateString('it-IT', { month: 'short' }); // e.g. "ago"
    }

    function getExpensesForKey(key) {
      return (app.expenses || []).filter(e => e.date === key);
    }

    function renderCalendar() {
      if (!calendarRow) return;
      calendarRow.innerHTML = '';
      // compute how many day-pill fit: try to fit at least 5, more if width allows
      const containerW = Math.max(document.documentElement.clientWidth, 360);
      const approxPill = 92; // pill width incl gap
      let visible = Math.floor(containerW / approxPill);
      if (visible < 3) visible = 3;
      if (visible % 2 === 0) visible = visible - 1; // make odd so can center
      const half = Math.floor(visible / 2);

      const today = new Date();
      const centerIdx = 0;
      for (let offset = -half; offset <= half; offset++) {
        const d = new Date();
        d.setDate(today.getDate() + offset);
        const key = formatKey(d);
        const isToday = (formatKey(today) === key);
        const hasExpenses = getExpensesForKey(key).length > 0;

        const pill = document.createElement('button');
        pill.className = 'day-pill';
        pill.dataset.key = key;
        pill.setAttribute('aria-pressed', 'false');
        pill.type = 'button';

        if (isToday && selectedDateKey === null) {
          pill.classList.add('selected');
          selectedDateKey = key;
        } else if (key === selectedDateKey) {
          pill.classList.add('selected');
        }

        pill.innerHTML = `
          <div class="day-num">${d.getDate()}</div>
          <div class="day-name">${shortDayName(d)}</div>
          <div class="month">${shortMonth(d)}</div>
          <div class="has-expense-dot ${hasExpenses ? '' : 'hidden'}" aria-hidden="true"></div>
        `;
        pill.addEventListener('click', () => onDayClick(key, pill));
        calendarRow.appendChild(pill);
      }

      // initially show summary for selected
      if (selectedDateKey) {
        showDaySummary(selectedDateKey);
      }
    }

    function onDayClick(key, pillEl) {
      // deselect previous
      const prev = document.querySelector('.day-pill.selected');
      if (prev && prev !== pillEl) prev.classList.remove('selected');
      pillEl.classList.add('selected');
      selectedDateKey = key;
      showDaySummary(key);
      // scroll page to summary area (smooth)
      daySummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function showDaySummary(key) {
      const exps = getExpensesForKey(key);
      if (!exps || exps.length === 0) {
        daySummary.classList.remove('show');
        daySummary.innerHTML = `<div style="color:var(--gh-muted)">Nessuna spesa registrata per ${key}</div>`;
        return;
      }
      const total = exps.reduce((s,e)=> s + (parseFloat(e.total)||0), 0);
      daySummary.classList.add('show');
      daySummary.innerHTML = `<strong>Hai fatto ${exps.length} spesa${exps.length>1?'e':''} spendendo un totale di ${app.formatCurrency(total)}</strong>
        <div style="margin-top:8px;color:var(--gh-muted);font-size:0.95rem">
          ${exps.map(e => `${app.formatDate(e.date)} ‚Äî ${e.store}: ${app.formatCurrency(e.total)}`).join('<br>')}
        </div>`;
    }

    // === Budget donut chart drawing ===
    function drawDonut(canvasId, percent, colors) {
      const c = document.getElementById(canvasId);
      if (!c) return;
      const ctx = c.getContext('2d');
      const w = c.width;
      const h = c.height;
      ctx.clearRect(0,0,w,h);
      const cx = w/2;
      const cy = h/2;
      const radius = Math.min(cx,cy) - 10;
      // background ring
      ctx.beginPath();
      ctx.arc(cx,cy,radius,0,2*Math.PI);
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.lineWidth = 12;
      ctx.stroke();

      // foreground arc
      const end = -Math.PI/2 + (percent/100) * 2*Math.PI;
      ctx.beginPath();
      ctx.arc(cx,cy,radius,-Math.PI/2,end);
      ctx.strokeStyle = colors[0] || '#7aa986';
      ctx.lineWidth = 12;
      ctx.lineCap = 'round';
      ctx.stroke();

      // center text
      ctx.fillStyle = 'rgba(0,0,0,0.8)';
      ctx.font = '700 14px system-ui,Segoe UI,Roboto,Arial';
      ctx.textAlign = 'center';
      ctx.fillText(Math.round(percent) + '%', cx, cy + 6);
    }

    // === Existing pie charts (reused) - with palette override ===
    function drawPieChart(canvasId, data, statsId, palette) {
      const canvas = document.getElementById(canvasId);
      const statsDiv = document.getElementById(statsId);
      if (!canvas || !statsDiv) return;
      const ctx = canvas.getContext('2d');
      const entries = Object.entries(data || {}).sort((a,b)=> b[1].total - a[1].total).slice(0, 6);
      if (entries.length === 0) {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#666';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Nessun dato', canvas.width/2, canvas.height/2);
        statsDiv.innerHTML = '<div style="text-align:center;color:#666">Nessun dato disponibile</div>';
        return;
      }
      const total = entries.reduce((s,[,d]) => s + d.total, 0);
      let currentAngle = -Math.PI/2;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const cx = canvas.width/2;
      const cy = canvas.height/2;
      const radius = Math.min(cx,cy) - 20;
      entries.forEach(([label,d], idx) => {
        const slice = (d.total / total) * 2*Math.PI;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,radius,currentAngle,currentAngle + slice);
        ctx.closePath();
        ctx.fillStyle = palette[idx % palette.length];
        ctx.fill();
        currentAngle += slice;
      });
      statsDiv.innerHTML = entries.map(([label,d], idx) =>
        `<div style="display:flex;justify-content:space-between;">
           <div><span style="color:${palette[idx % palette.length]};margin-right:6px">‚óè</span>${label}</div>
           <div>${app.formatCurrency(d.total)}</div>
         </div>`
      ).join('');
    }

    // === update all dashboard bits ===
    function updateDashboard() {
      const period = document.getElementById('periodSelect')?.value || 'mese';
      const filtered = app.filterByPeriod(period);
      const stats = app.getStats(filtered);
      // blocks
      document.getElementById('totalAmountBlock').textContent = app.formatCurrency(stats.total);
      document.getElementById('maxAmountBlock').textContent = app.formatCurrency(stats.max.amount);
      document.getElementById('minAmountBlock').textContent = app.formatCurrency(stats.min.amount);
      document.getElementById('countBlock').textContent = stats.count;
      document.getElementById('maxStoreBlock').textContent = stats.max.store || '';
      document.getElementById('minStoreBlock').textContent = stats.min.store || '';

      // budget donut
      const budget = getBudgetForPeriod(period);
      const percent = budget > 0 ? Math.min(100, (stats.total / budget) * 100) : 0;
      drawDonut('budgetChart', percent, [getComputedStyle(document.documentElement).getPropertyValue('--gh-text-strong') || '#7aa986']);

      // charts (palette from palette above)
      const palette = [getComputedStyle(document.documentElement).getPropertyValue('--gh-salvia').trim() || '#7aa986',
                       getComputedStyle(document.documentElement).getPropertyValue('--gh-mustard').trim() || '#d6a63f',
                       getComputedStyle(document.documentElement).getPropertyValue('--gh-terracotta').trim() || '#c7683c',
                       '#f6cfa7','#8fb9a0','#f3b25b'];

      drawPieChart('storeChart', stats.storeStats, 'storeStats', palette);
      drawPieChart('categoryChart', stats.categoryStats, 'categoryStats', palette);
    }

    // === Recent list ===
    function loadRecentExpenses(expenses) {
      const recentList = document.getElementById('recentList');
      if (!recentList) return;
      const recent = (expenses || []).slice(-6).reverse();
      if (!recent.length) {
        recentList.innerHTML = '<div class="no-expenses">Nessuna spesa recente</div>';
        return;
      }
      recentList.innerHTML = recent.map(exp => `
        <div class="recent-item" style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(0,0,0,0.04);">
          <div>
            <strong style="display:block">${exp.store}</strong>
            <small style="color:var(--gh-muted)">${app.formatDate(exp.date)} ‚Ä¢ ${exp.products?.length || 0} prodotti</small>
          </div>
          <div style="font-weight:700">${app.formatCurrency(exp.total)}</div>
        </div>
      `).join('');
    }

    // === Wiring ===
    document.addEventListener('DOMContentLoaded', () => {
      // menu open/close
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuClose = document.getElementById('menuClose');
      menuToggle?.addEventListener('click', () => { sideMenu.style.display = 'block'; });
      menuClose?.addEventListener('click', () => { sideMenu.style.display = 'none'; });

      // initial calendar + dashboard
      renderCalendar();
      updateDashboard();
      loadRecentExpenses(app.filterByPeriod(document.getElementById('periodSelect')?.value || 'mese'));

      // listeners
      window.addEventListener('resize', () => {
        // rerender calendar to adapt number of days visible
        renderCalendar();
      });

      document.getElementById('periodSelect')?.addEventListener('change', () => {
        updateDashboard();
      });

      // react to changes in the app data (expenses changed)
      document.addEventListener('app:expenses-changed', () => {
        renderCalendar();
        updateDashboard();
        loadRecentExpenses(app.filterByPeriod(document.getElementById('periodSelect')?.value || 'mese'));
      });

      // initial selection summary (if any)
      if (selectedDateKey) showDaySummary(selectedDateKey);
    });

  </script>
</body>
</html>