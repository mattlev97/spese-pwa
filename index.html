<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GroceryHub - Dashboard</title>

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="FDE6748E-E787-40BF-B6FD-203C136F8138.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Mantengo style.css per gli stili globali -->
  <link rel="stylesheet" href="style.css?v=20250816">

  <style>
    /* PAGE PALETTE OVERRIDES */
    :root{
      --gh-bg: #ffffff;
      --gh-salvia: #7aa986;
      --gh-mustard: #d6a63f;
      --gh-terracotta: #c7683c;
      --gh-terracotta-light: rgba(199,104,60,0.12);
      --gh-text-strong: #222428;
      --gh-muted: #5b5f63;
    }

    /* body / layout */
    body {
      background: var(--gh-bg) !important;
      color: var(--gh-text-strong);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* HEADER fixed */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 88px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      background: rgba(255,255,255,0.98);
      border-bottom: 1px solid rgba(0,0,0,0.04);
      z-index: 3000;
    }

    main.dashboard { 
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
      padding-top: calc(88px + 12px); /* spazio header fisso */
    }

    /* hamburger */
    .hamburger {
      width: 48px;
      height: 48px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      background: rgba(0,0,0,0.04);
      cursor:pointer;
      flex: 0 0 auto;
    }
    .hamburger i { color: var(--gh-text-strong); font-size:18px; }

    /* Title */
    .title-wrap { display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
    .title-row { display:flex; align-items:baseline; gap:10px; }
    .grocery { font-weight:400; color:var(--gh-text-strong); font-size:1.9rem; margin:0; line-height:1; }
    .hub { font-weight:800; color:var(--gh-salvia); font-size:1.9rem; margin:0; line-height:1; }
    .payoff { font-style:italic; color:var(--gh-muted); font-size:0.95rem; margin-top:2px; }

    /* Side menu (offcanvas) */
    #sideMenu {
      display:none;
      position:fixed;
      left:0;
      top:0;
      bottom:0;
      width:78%;
      max-width:360px;
      background:#fff;
      z-index:3500;
      box-shadow: 6px 0 30px rgba(0,0,0,0.12);
      padding:18px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    #sideMenu .menu-header { display:flex; gap:12px; align-items:center; margin-bottom:14px; }
    #sideMenu .avatar { width:52px; height:52px; border-radius:10px; background:var(--gh-salvia); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; }
    #sideMenu h4 { margin:0; font-size:1.06rem; color:var(--gh-text-strong); }
    #sideMenu p.sub { margin:4px 0 0 0; color:var(--gh-muted); font-size:0.92rem; }
    #sideMenu nav ul { list-style:none; padding:0; margin:12px 0; }
    #sideMenu nav li { padding:10px 6px; border-radius:8px; }
    #sideMenu nav a { text-decoration:none; color:var(--gh-text-strong); display:flex; justify-content:space-between; gap:8px; align-items:center; width:100%; }
    #sideMenu nav a small { color:var(--gh-muted); font-weight:500; }
    #sideMenu nav a:hover { background: rgba(0,0,0,0.03); }
    #sideMenu .menu-sep { height:1px; background: rgba(0,0,0,0.04); margin:12px 0; border-radius:1px; }

    /* overlay when menu open */
    #menuOverlay { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.35); z-index:3400; }

    /* calendar */
    .calendar-wrap { margin-top: 8px; margin-bottom:14px; display:flex; flex-direction:column; gap:8px; }
    .calendar-row { display:flex; gap:10px; align-items:center; justify-content:center; overflow:hidden; padding:8px 6px; }

    .day-pill {
      min-width:88px;
      max-width:130px;
      padding: 14px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      border-radius:28px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      border:1px solid rgba(0,0,0,0.04);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
      color: var(--gh-text-strong);
    }

    .day-pill .day-num { font-size:1.9rem; font-weight:800; color:var(--gh-text-strong); }
    .day-pill .day-name { font-size:1.05rem; font-weight:700; color:var(--gh-text-strong); text-transform:capitalize; }
    .day-pill .month { font-size:0.78rem; color:var(--gh-muted); text-transform:capitalize; }

    /* selected = white text on terracotta */
    .day-pill.selected {
      background: linear-gradient(180deg, var(--gh-terracotta), var(--gh-terracotta));
      color: #fff !important;
      border-color: rgba(0,0,0,0.06);
      box-shadow: 0 10px 30px rgba(199,104,60,0.12);
      transform: translateY(-4px);
    }
    .day-pill.selected .day-num,
    .day-pill.selected .day-name,
    .day-pill.selected .month {
      color: #fff !important;
    }
    .day-pill.selected .has-expense-dot { background: rgba(255,255,255,0.95) !important; }

    /* adjacent reductions */
    .day-pill.adjacent { padding:10px 8px; min-width:72px; }
    .day-pill.adjacent .day-num { font-size:1.45rem; }
    .day-pill.adjacent .day-name { font-size:0.92rem; }
    .day-pill.adjacent .month { font-size:0.7rem; }

    .day-pill.adjacent-2 { padding:8px 6px; min-width:64px; opacity:0.95; }
    .day-pill.adjacent-2 .day-num { font-size:1.15rem; font-weight:700; }
    .day-pill.adjacent-2 .day-name { font-size:0.82rem; }
    .day-pill.adjacent-2 .month { font-size:0.65rem; }

    .has-expense-dot { width:8px; height:8px; border-radius:50%; background:var(--gh-salvia); margin-top:4px; opacity:0.95; }
    .has-expense-dot.hidden { opacity:0; }

    /* day summary drawer */
    .day-summary { display:none; margin-top:8px; padding:12px; background:var(--gh-terracotta-light); color:var(--gh-text-strong); border-radius:10px; }
    .day-summary.show { display:block; }

    /* blocks */
    .blocks { display:flex; gap:12px; margin-top:12px; align-items:stretch; flex-wrap:wrap; }
    .block { flex:1 1 180px; border-radius:12px; padding:14px; color:#fff; display:flex; gap:8px; align-items:center; justify-content:space-between; min-height:100px; box-shadow:0 10px 30px rgba(0,0,0,0.06); }
    .block .label { font-size:0.86rem; opacity:0.95; }
    .block .value { font-size:1.3rem; font-weight:800; }

    .block.total { background:var(--gh-salvia); color:#fff; }
    .block.max { background:var(--gh-mustard); color:#111; }
    .block.min { background:#f1a386; color:#111; }
    .block.count { background:var(--gh-terracotta); color:#fff; }

    /* charts: style legend */
    .charts-section .chart-container h3 { font-weight:700; color:var(--gh-text-strong); margin:0 0 8px 0; }
    .chart-legend { margin-top:8px; color:var(--gh-muted); }

    /* recent */
    .recent-list .recent-item strong { display:block; color:var(--gh-text-strong); }
    .recent-list .recent-item small { color:var(--gh-muted); display:block; }

    /* responsive tweaks */
    @media (max-width: 880px) {
      .day-pill { min-width:76px; }
      header { height:96px; }
      main { padding-top: 110px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="hamburger" id="menuToggle" aria-label="Apri menu" title="Apri menu" tabindex="0">
      <i class="fa-solid fa-bars" aria-hidden="true"></i>
    </div>

    <div class="title-wrap" role="banner" aria-hidden="false">
      <div class="title-row" aria-hidden="false">
        <h1 class="grocery">Grocery</h1>
        <h1 class="hub">Hub</h1>
      </div>
      <div class="payoff">Controlla, risparmia, vivi meglio</div>
    </div>
  </header>

  <!-- overlay for off-canvas -->
  <div id="menuOverlay" aria-hidden="true"></div>

  <!-- off-canvas menu (enhanced) -->
  <aside id="sideMenu" aria-hidden="true" aria-label="Menu principale">
    <div class="menu-header">
      <div class="avatar">GH</div>
      <div>
        <h4>GroceryHub</h4>
        <p class="sub">Gestisci le tue spese e risparmia</p>
      </div>
    </div>

    <nav aria-label="Sezioni">
      <ul>
        <li><a href="index.html">Dashboard <small>Riepilogo e grafici</small></a></li>
        <li><a href="aggiungi.html">Aggiungi <small>Inserisci una nuova spesa</small></a></li>
        <li><a href="archivio.html">Archivio <small>Storico delle spese</small></a></li>
        <li><a href="impostazioni.html">Impostazioni <small>Configurazioni e budget</small></a></li>
      </ul>
    </nav>

    <div class="menu-sep" role="presentation"></div>

    <div style="font-size:0.95rem;color:var(--gh-muted);margin-top:10px;">
      Quick Links
    </div>
    <nav>
      <ul>
        <li><a href="aggiungi.html">Carrello salvato <small>Aggiungi prodotti</small></a></li>
        <li><a href="impostazioni.html">Imposta budget <small>Configura settimanale</small></a></li>
      </ul>
    </nav>

    <div class="menu-sep" role="presentation"></div>

    <div style="font-size:0.9rem;color:var(--gh-muted);margin-top:12px;">
      <button id="menuClose" style="background:none;border:1px solid rgba(0,0,0,0.06);padding:8px 12px;border-radius:8px;cursor:pointer;">Chiudi menu</button>
    </div>
  </aside>

  <main class="dashboard" role="main">
    <!-- calendar -->
    <section class="calendar-wrap" aria-label="Selezione giorno">
      <div class="calendar-row" id="calendarRow" aria-hidden="false"></div>
      <div id="daySummary" class="day-summary" aria-live="polite"></div>
    </section>

    <!-- summary blocks -->
    <section>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="font-weight:700;font-size:1.06rem;color:var(--gh-text-strong);">Riepilogo</div>
        <div>
          <label for="periodSelect" style="margin-right:8px;color:var(--gh-muted);font-size:0.95rem;">Periodo</label>
          <select id="periodSelect" style="padding:6px 8px;border-radius:8px;border:1px solid #ddd;">
            <option value="settimana">Settimana</option>
            <option value="mese" selected>Mese</option>
            <option value="anno">Anno</option>
          </select>
        </div>
      </div>

      <div class="blocks">
        <div class="block total">
          <div>
            <div class="label">Totale spese</div>
            <div id="totalAmountBlock" class="value">€0.00</div>
          </div>
          <!-- removed "periodo selezionato" text per richiesta -->
          <div style="font-size:0.92rem;color:rgba(255,255,255,0.95);text-align:right;">
            <div style="font-weight:700" id="totalDelta"> </div>
          </div>
        </div>

        <div class="block max">
          <div>
            <div class="label">Spesa massima</div>
            <div id="maxAmountBlock" class="value">€0.00</div>
            <div style="font-size:0.85rem;color:rgba(0,0,0,0.7)" id="maxStoreBlock"></div>
          </div>
        </div>

        <div class="block min">
          <div>
            <div class="label">Spesa minima</div>
            <div id="minAmountBlock" class="value">€0.00</div>
            <div style="font-size:0.85rem;color:rgba(0,0,0,0.7)" id="minStoreBlock"></div>
          </div>
        </div>

        <div class="block count">
          <div>
            <div class="label">Numero spese</div>
            <div id="countBlock" class="value">0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- charts (kept existing) -->
    <section class="charts-section" aria-label="Grafici comparativi" style="margin-top:18px;">
      <div class="chart-container">
        <h3>Supermercati più usati</h3>
        <canvas id="storeChart" width="300" height="300" role="img" aria-label="Grafico supermercati più usati"></canvas>
        <div id="storeStats" class="chart-legend"></div>
      </div>

      <div class="chart-container">
        <h3>Tipologie prodotti</h3>
        <canvas id="categoryChart" width="300" height="300" role="img" aria-label="Grafico tipologie prodotti"></canvas>
        <div id="categoryStats" class="chart-legend"></div>
      </div>
    </section>

    <!-- recent -->
    <section style="margin-top:18px;">
      <h3>Ultime spese</h3>
      <div id="recentList" class="recent-list"></div>
    </section>
  </main>

  <!-- bottom nav (kept) -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a href="index.html" class="nav-item nav-active">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a href="aggiungi.html" class="nav-item">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a href="archivio.html" class="nav-item">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a href="impostazioni.html" class="nav-item">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <script src="app.js"></script>

  <script>
    /* ------------- Helpers & Settings ------------- */
    const SETTINGS_KEY = 'gh_settings';
    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (!raw) {
          const def = { weeklyBudget: 100 };
          localStorage.setItem(SETTINGS_KEY, JSON.stringify(def));
          return def;
        }
        return JSON.parse(raw);
      } catch (e) { return { weeklyBudget:100 }; }
    }

    /* ------------- Calendar logic (fixed 5 pills) ------------- */
    const calendarRow = document.getElementById('calendarRow');
    const daySummary = document.getElementById('daySummary');
    let selectedDateKey = null;

    function formatKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function weekdayName(d) { return d.toLocaleDateString('it-IT', { weekday:'long' }); } // full
    function monthLong(d) { return d.toLocaleDateString('it-IT', { month:'long' }); }

    function getExpensesForKey(key) {
      return (app.expenses || []).filter(e => e.date === key);
    }

    function renderCalendar() {
      if (!calendarRow) return;
      calendarRow.innerHTML = '';

      const today = new Date();
      // fixed 5 pills: offsets -2, -1, 0, 1, 2
      for (let offset = -2; offset <= 2; offset++) {
        const d = new Date();
        d.setDate(today.getDate() + offset);
        const key = formatKey(d);
        const isToday = (formatKey(today) === key);
        const hasExpenses = getExpensesForKey(key).length > 0;

        const pill = document.createElement('button');
        pill.className = 'day-pill';
        if (Math.abs(offset) === 1) pill.classList.add('adjacent');
        if (Math.abs(offset) === 2) pill.classList.add('adjacent-2');

        pill.dataset.key = key;
        pill.type = 'button';
        pill.setAttribute('aria-pressed', 'false');

        // initial selection: if none set, select today
        if (!selectedDateKey && isToday) {
          pill.classList.add('selected');
          selectedDateKey = key;
        } else if (key === selectedDateKey) {
          pill.classList.add('selected');
        }

        pill.innerHTML = `
          <div class="day-num">${d.getDate()}</div>
          <div class="day-name">${weekdayName(d)}</div>
          <div class="month">${monthLong(d)}</div>
          <div class="has-expense-dot ${hasExpenses? '': 'hidden'}" aria-hidden="true"></div>
        `;
        pill.addEventListener('click', () => onDayClick(key, pill));
        calendarRow.appendChild(pill);
      }

      // show summary for selected
      if (selectedDateKey) showDaySummary(selectedDateKey);
    }

    function onDayClick(key, pillEl) {
      const prev = document.querySelector('.day-pill.selected');
      if (prev && prev !== pillEl) prev.classList.remove('selected');
      pillEl.classList.add('selected');
      selectedDateKey = key;
      showDaySummary(key);
      // NOT scrolling the page anymore (user requested)
    }

    function showDaySummary(key) {
      const exps = getExpensesForKey(key);
      if (!exps || exps.length === 0) {
        daySummary.classList.add('show');
        daySummary.innerHTML = `<div style="color:var(--gh-text-strong)">Nessuna spesa registrata per ${key}</div>`;
        return;
      }
      const total = exps.reduce((s,e)=> s + (parseFloat(e.total)||0), 0);
      daySummary.classList.add('show');
      daySummary.innerHTML = `<strong>Hai fatto ${exps.length} spesa${exps.length>1?'e':''} spendendo un totale di ${app.formatCurrency(total)}</strong>
        <div style="margin-top:8px;color:var(--gh-muted);font-size:0.95rem">
          ${exps.map(e => `${app.formatDate(e.date)} — ${e.store}: ${app.formatCurrency(e.total)}`).join('<br>')}
        </div>`;
    }

    /* ------------- Charts (existing) ------------- */
    function drawPieChart(canvasId, data, statsId, palette) {
      const canvas = document.getElementById(canvasId);
      const statsDiv = document.getElementById(statsId);
      if (!canvas || !statsDiv) return;
      const ctx = canvas.getContext('2d');
      const entries = Object.entries(data || {}).sort((a,b)=> b[1].total - a[1].total).slice(0,6);
      if (entries.length === 0) {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#ccc';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Nessun dato', canvas.width/2, canvas.height/2);
        statsDiv.innerHTML = '<div style="text-align:center;color:#666">Nessun dato disponibile</div>';
        return;
      }
      const total = entries.reduce((s,[,d]) => s + d.total, 0);
      let currentAngle = -Math.PI/2;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const cx = canvas.width/2;
      const cy = canvas.height/2;
      const radius = Math.min(cx,cy) - 20;
      entries.forEach(([label,d], idx) => {
        const slice = (d.total / total) * 2*Math.PI;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,radius,currentAngle,currentAngle + slice);
        ctx.closePath();
        ctx.fillStyle = palette[idx % palette.length];
        ctx.fill();
        currentAngle += slice;
      });
      statsDiv.innerHTML = entries.map(([label,d], idx) =>
        `<div style="display:flex;justify-content:space-between;padding:6px 0;">
           <div><span style="color:${palette[idx % palette.length]};margin-right:8px">●</span>${label}</div>
           <div>${app.formatCurrency(d.total)}</div>
         </div>`
      ).join('');
    }

    /* ------------- Dashboard update ------------- */
    function updateDashboard() {
      const period = document.getElementById('periodSelect')?.value || 'mese';
      const filtered = app.filterByPeriod(period);
      const stats = app.getStats(filtered);

      document.getElementById('totalAmountBlock').textContent = app.formatCurrency(stats.total);
      document.getElementById('maxAmountBlock').textContent = app.formatCurrency(stats.max.amount);
      document.getElementById('minAmountBlock').textContent = app.formatCurrency(stats.min.amount);
      document.getElementById('countBlock').textContent = stats.count;
      document.getElementById('maxStoreBlock').textContent = stats.max.store || '';
      document.getElementById('minStoreBlock').textContent = stats.min.store || '';

      // charts palette
      const palette = [
        getComputedStyle(document.documentElement).getPropertyValue('--gh-salvia').trim() || '#7aa986',
        getComputedStyle(document.documentElement).getPropertyValue('--gh-mustard').trim() || '#d6a63f',
        getComputedStyle(document.documentElement).getPropertyValue('--gh-terracotta').trim() || '#c7683c',
        '#f6cfa7', '#8fb9a0', '#f3b25b'
      ];

      drawPieChart('storeChart', stats.storeStats, 'storeStats', palette);
      drawPieChart('categoryChart', stats.categoryStats, 'categoryStats', palette);

      // recent
      loadRecentExpenses(filtered);
    }

    function loadRecentExpenses(expenses) {
      const recentList = document.getElementById('recentList');
      if (!recentList) return;
      const recent = (expenses || []).slice(-6).reverse();
      if (!recent.length) {
        recentList.innerHTML = '<div class="no-expenses">Nessuna spesa recente</div>';
        return;
      }
      recentList.innerHTML = recent.map(exp => `
        <div class="recent-item" style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(0,0,0,0.04);">
          <div>
            <strong>${exp.store}</strong>
            <small style="color:var(--gh-muted)">${app.formatDate(exp.date)} • ${exp.products?.length || 0} prodotti</small>
          </div>
          <div style="font-weight:700">${app.formatCurrency(exp.total)}</div>
        </div>
      `).join('');
    }

    /* ------------- Off-canvas menu open/close ------------- */
    document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuClose = document.getElementById('menuClose');
      const menuOverlay = document.getElementById('menuOverlay');

      function openMenu() {
        sideMenu.style.display = 'block';
        sideMenu.setAttribute('aria-hidden','false');
        menuOverlay.style.display = 'block';
        menuOverlay.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
      }
      function closeMenu() {
        sideMenu.style.display = 'none';
        sideMenu.setAttribute('aria-hidden','true');
        menuOverlay.style.display = 'none';
        menuOverlay.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
      }

      menuToggle?.addEventListener('click', openMenu);
      menuToggle?.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') openMenu(); });
      menuClose?.addEventListener('click', closeMenu);
      menuOverlay?.addEventListener('click', closeMenu);

      // initial render
      renderCalendar();
      updateDashboard();

      // listeners
      window.addEventListener('resize', () => { renderCalendar(); updateDashboard(); });

      document.getElementById('periodSelect')?.addEventListener('change', () => { updateDashboard(); });

      // react to app changes
      document.addEventListener('app:expenses-changed', () => {
        renderCalendar();
        updateDashboard();
      });

      // ensure summary visible for selected
      if (selectedDateKey) showDaySummary(selectedDateKey);
    });
  </script>
</body>
</html>