<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GroceryHub - Dashboard</title>

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="FDE6748E-E787-40BF-B6FD-203C136F8138.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">

  <!-- Font Awesome (icone) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Stile principale -->
  <link rel="stylesheet" href="style.css?v=20250816">
</head>
<body>
  <!-- HEADER (fisso) -->
  <header>
    <button id="menuToggle" class="hamburger" aria-label="Apri menu" title="Apri menu">
      <i class="fa-solid fa-bars" aria-hidden="true"></i>
    </button>

    <div class="title-wrap" role="banner">
      <!-- GroceryHub attaccato -->
      <h1 class="groceryhub" aria-label="GroceryHub">
        <span class="grocery">Grocery</span><span class="hub">Hub</span>
      </h1>
      <div class="payoff">Controlla, risparmia, vivi meglio</div>
    </div>
  </header>

  <!-- OFF-CANVAS SIDE MENU (arricchito) -->
  <nav id="sideMenu" aria-hidden="true">
    <div class="menu-header">
      <div class="menu-logo" aria-hidden="true">GH</div>
      <div>
        <div style="font-weight:800;font-size:1rem;color:var(--gh-text-strong)">GroceryHub</div>
        <div style="font-size:0.9rem;color:var(--gh-muted)">Controlla, risparmia, vivi meglio</div>
      </div>
    </div>
    <button id="menuClose" aria-label="Chiudi menu" style="background:none;border:none;font-size:16px;display:block;margin-bottom:12px;cursor:pointer;">Chiudi ✕</button>

    <div class="menu-section">
      <h4 style="margin:8px 0;color:var(--gh-muted);font-size:0.9rem">Navigazione</h4>
      <ul style="list-style:none;padding:0;margin:0;">
        <li><a href="index.html">Dashboard</a></li>
        <li><a href="aggiungi.html">Aggiungi</a></li>
        <li><a href="archivio.html">Archivio</a></li>
        <li><a href="impostazioni.html">Impostazioni</a></li>
      </ul>
    </div>

    <div class="menu-section" style="margin-top:18px;">
      <h4 style="margin:8px 0;color:var(--gh-muted);font-size:0.9rem">Store rapidi</h4>
      <div id="menuStores" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
    </div>

    <div style="margin-top:18px;color:var(--gh-muted);font-size:0.9rem">
      <strong>Info</strong>
      <p style="margin-top:6px">App local-first: i dati sono memorizzati nel browser.</p>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="dashboard" role="main">
    <!-- CALENDAR SLIDER -->
    <section class="calendar-wrap" aria-label="Selezione giorno">
      <div id="calendarRow" class="calendar-row" role="list" aria-label="Giorni"></div>
      <div id="daySummary" class="day-summary" aria-live="polite"></div>
    </section>

    <!-- RIEPILOGO blocchi -->
    <section aria-label="Riepilogo">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="font-weight:700;font-size:1.06rem;color:var(--gh-text-strong)">Riepilogo</div>
        <div>
          <label for="periodSelect" style="margin-right:8px;color:var(--gh-muted);font-size:0.95rem;">Periodo</label>
          <select id="periodSelect" style="padding:6px 8px;border-radius:8px;border:1px solid #ddd;">
            <option value="settimana">Settimana</option>
            <option value="mese" selected>Mese</option>
            <option value="anno">Anno</option>
          </select>
        </div>
      </div>

      <div class="blocks" role="region" aria-label="Statistiche principali">
        <div class="block total" role="img" aria-label="Totale spese">
          <div>
            <div class="label">Totale spese</div>
            <div id="totalAmountBlock" class="value">€0.00</div>
          </div>
          <div class="donut-wrap" aria-hidden="true"></div>
        </div>

        <div class="block max" role="img" aria-label="Spesa massima">
          <div>
            <div class="label">Spesa massima</div>
            <div id="maxAmountBlock" class="value">€0.00</div>
            <div id="maxStoreBlock" style="font-size:0.85rem;color:rgba(0,0,0,0.7)"></div>
          </div>
        </div>

        <div class="block min" role="img" aria-label="Spesa minima">
          <div>
            <div class="label">Spesa minima</div>
            <div id="minAmountBlock" class="value">€0.00</div>
            <div id="minStoreBlock" style="font-size:0.85rem;color:rgba(0,0,0,0.7)"></div>
          </div>
        </div>

        <div class="block count" role="img" aria-label="Numero spese">
          <div>
            <div class="label">Numero spese</div>
            <div id="countBlock" class="value">0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- CHARTS -->
    <section class="charts-section" aria-label="Grafici comparativi">
      <div class="chart-container">
        <h3>Supermercati più usati</h3>
        <canvas id="storeChart" width="300" height="300" role="img" aria-label="Grafico supermercati più usati"></canvas>
        <div id="storeStats" class="chart-legend"></div>
      </div>

      <div class="chart-container">
        <h3>Tipologie prodotti</h3>
        <canvas id="categoryChart" width="300" height="300" role="img" aria-label="Grafico tipologie prodotti"></canvas>
        <div id="categoryStats" class="chart-legend"></div>
      </div>
    </section>

    <!-- RECENT LIST -->
    <section style="margin-top:18px;" aria-label="Ultime spese">
      <h3 style="margin-bottom:8px;">Ultime spese</h3>
      <div id="recentList" class="recent-list"></div>
    </section>
  </main>

  <!-- BOTTOM NAV (icon-only) -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a href="index.html" class="nav-item nav-active" aria-label="Dashboard">
      <span class="icon-wrap" aria-hidden="true"><i class="fa-solid fa-house"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a href="aggiungi.html" class="nav-item" aria-label="Aggiungi">
      <span class="icon-wrap" aria-hidden="true"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a href="archivio.html" class="nav-item" aria-label="Archivio">
      <span class="icon-wrap" aria-hidden="true"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a href="impostazioni.html" class="nav-item" aria-label="Impostazioni">
      <span class="icon-wrap" aria-hidden="true"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <!-- App core (expense tracker) -->
  <script src="app.js"></script>

  <!-- Dashboard script (keeps logic but uses classes, no inline style reliance) -->
  <script>
    (function () {
      if (!window.app) {
        console.warn('app non trovato (assicurati app.js sia caricato prima).');
        return;
      }

      // elements
      const calendarRow = document.getElementById('calendarRow');
      const daySummary = document.getElementById('daySummary');
      const periodSelect = document.getElementById('periodSelect');
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuClose = document.getElementById('menuClose');

      let selectedDateKey = null;

      // date helpers
      function formatKey(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      }
      function shortDayName(d) {
        return d.toLocaleDateString('it-IT', { weekday: 'short' });
      }
      function longMonth(d) {
        return d.toLocaleDateString('it-IT', { month: 'long' });
      }

      function getExpensesForKey(key) {
        return (app.expenses || []).filter(e => e.date === key);
      }

      // render exactly 5 pills (2 prev, today, 2 next)
      function renderCalendar() {
        if (!calendarRow) return;
        calendarRow.innerHTML = '';

        const today = new Date();
        const visible = 5;
        const half = Math.floor(visible / 2);

        for (let offset = -half; offset <= half; offset++) {
          const d = new Date();
          d.setDate(today.getDate() + offset);
          const key = formatKey(d);
          const isToday = (formatKey(today) === key);
          const hasExpenses = getExpensesForKey(key).length > 0;

          const pill = document.createElement('button');
          pill.className = 'day-pill';
          if (offset === -2 || offset === 2) pill.classList.add('adjacent-2');
          else if (offset === -1 || offset === 1) pill.classList.add('adjacent');

          pill.type = 'button';
          pill.dataset.key = key;
          pill.setAttribute('aria-pressed', 'false');

          if (selectedDateKey === null && isToday) selectedDateKey = key;
          if (key === selectedDateKey) pill.classList.add('selected');

          pill.innerHTML = `
            <div class="day-num">${d.getDate()}</div>
            <div class="day-name">${shortDayName(d)}</div>
            <div class="month">${longMonth(d)}</div>
            <div class="has-expense-dot ${hasExpenses ? '' : 'hidden'}" aria-hidden="true"></div>
          `;

          pill.addEventListener('click', () => onDayClick(key, pill));
          calendarRow.appendChild(pill);
        }

        if (selectedDateKey) showDaySummary(selectedDateKey);
        // ensure center pill is visible: scroll calendar so selected pill is centered
        const sel = document.querySelector('.day-pill.selected');
        if (sel) {
          // calculate scroll to center selected pill
          const parent = calendarRow;
          const parentRect = parent.getBoundingClientRect();
          const selRect = sel.getBoundingClientRect();
          const offset = (selRect.left + selRect.width/2) - (parentRect.left + parentRect.width/2);
          parent.scrollBy({ left: offset, behavior: 'smooth' });
        }
      }

      function onDayClick(key, pillEl) {
        const prev = document.querySelector('.day-pill.selected');
        if (prev && prev !== pillEl) prev.classList.remove('selected');
        pillEl.classList.add('selected');
        selectedDateKey = key;
        showDaySummary(key);
        // intentionally DO NOT scroll the whole page (user requested)
      }

      function showDaySummary(key) {
        const exps = getExpensesForKey(key);
        if (!exps || exps.length === 0) {
          daySummary.innerHTML = `<div class="empty">Nessuna spesa registrata per ${key}</div>`;
          daySummary.classList.remove('has-data');
          return;
        }

        const total = exps.reduce((s,e)=> s + (parseFloat(e.total)||0), 0);
        const lines = exps.map(e => `${app.formatDate(e.date)} — ${e.store}: ${app.formatCurrency(e.total)}`).join('<br>');
        daySummary.innerHTML = `
          <div style="font-weight:700">Hai fatto ${exps.length} spesa${exps.length>1 ? 'e' : ''} spendendo un totale di ${app.formatCurrency(total)}</div>
          <div style="margin-top:8px;color:var(--gh-muted);font-size:0.95rem">${lines}</div>
        `;
        daySummary.classList.add('has-data');
      }

      // draw pie charts (palette)
      function drawPieChart(canvasId, data, statsId, palette) {
        const canvas = document.getElementById(canvasId);
        const statsDiv = document.getElementById(statsId);
        if (!canvas || !statsDiv) return;
        const ctx = canvas.getContext('2d');
        const entries = Object.entries(data || {}).sort((a,b)=> b[1].total - a[1].total).slice(0,6);
        if (entries.length === 0) {
          ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.fillStyle = '#ccc';
          ctx.font = '14px system-ui';
          ctx.textAlign = 'center';
          ctx.fillText('Nessun dato', canvas.width/2, canvas.height/2);
          statsDiv.innerHTML = '<div style="text-align:center;color:var(--gh-muted)">Nessun dato disponibile</div>';
          return;
        }
        const total = entries.reduce((s,[,d]) => s + d.total, 0);
        let current = -Math.PI/2;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const cx = canvas.width/2;
        const cy = canvas.height/2;
        const radius = Math.min(cx,cy) - 20;
        entries.forEach(([label,d], idx) => {
          const slice = (d.total / total) * 2*Math.PI;
          ctx.beginPath();
          ctx.moveTo(cx,cy);
          ctx.arc(cx,cy,radius,current,current+slice);
          ctx.closePath();
          ctx.fillStyle = palette[idx % palette.length];
          ctx.fill();
          current += slice;
        });
        statsDiv.innerHTML = entries.map(([label,d], idx) =>
          `<div style="display:flex;justify-content:space-between;padding:6px 0;">
             <div><span style="color:${palette[idx % palette.length]};margin-right:8px">●</span>${label}</div>
             <div>${app.formatCurrency(d.total)}</div>
           </div>`
        ).join('');
      }

      function updateDashboard() {
        const period = periodSelect?.value || 'mese';
        const filtered = app.filterByPeriod(period);
        const stats = app.getStats(filtered);

        document.getElementById('totalAmountBlock').textContent = app.formatCurrency(stats.total);
        document.getElementById('maxAmountBlock').textContent = app.formatCurrency(stats.max.amount);
        document.getElementById('minAmountBlock').textContent = app.formatCurrency(stats.min.amount);
        document.getElementById('countBlock').textContent = stats.count;
        document.getElementById('maxStoreBlock').textContent = stats.max.store || '';
        document.getElementById('minStoreBlock').textContent = stats.min.store || '';

        const palette = [
          getComputedStyle(document.documentElement).getPropertyValue('--gh-salvia').trim() || '#7aa986',
          getComputedStyle(document.documentElement).getPropertyValue('--gh-mustard').trim() || '#d6a63f',
          getComputedStyle(document.documentElement).getPropertyValue('--gh-terracotta').trim() || '#c7683c',
          '#f6cfa7','#8fb9a0','#f3b25b'
        ];
        drawPieChart('storeChart', stats.storeStats, 'storeStats', palette);
        drawPieChart('categoryChart', stats.categoryStats, 'categoryStats', palette);

        loadRecentExpenses(filtered);
      }

      function loadRecentExpenses(expenses) {
        const recentList = document.getElementById('recentList');
        if (!recentList) return;
        const recent = (expenses || []).slice(-6).reverse();
        if (!recent.length) {
          recentList.innerHTML = '<div class="no-expenses">Nessuna spesa recente</div>';
          return;
        }
        recentList.innerHTML = recent.map(exp => `
          <div class="recent-item">
            <div>
              <strong style="display:block">${exp.store}</strong>
              <small style="color:var(--gh-muted)">${app.formatDate(exp.date)} • ${exp.products?.length || 0} prodotti</small>
            </div>
            <div style="font-weight:700">${app.formatCurrency(exp.total)}</div>
          </div>
        `).join('');
      }

      function populateSideStores() {
        const container = document.getElementById('menuStores');
        if (!container) return;
        container.innerHTML = '';
        (app.getStores() || []).slice(0,8).forEach(s => {
          const a = document.createElement('a');
          a.href = '#';
          a.textContent = s;
          a.className = 'side-store';
          a.addEventListener('click', (ev) => { ev.preventDefault(); sideMenu.classList.remove('open'); });
          container.appendChild(a);
        });
      }

      // menu open/close (use class open so no inline style required)
      menuToggle?.addEventListener('click', () => {
        sideMenu.classList.add('open');
        sideMenu.setAttribute('aria-hidden','false');
      });
      menuClose?.addEventListener('click', () => {
        sideMenu.classList.remove('open');
        sideMenu.setAttribute('aria-hidden','true');
      });

      // initial
      renderCalendar();
      updateDashboard();
      populateSideStores();

      // listeners
      window.addEventListener('resize', () => renderCalendar());
      periodSelect?.addEventListener('change', updateDashboard);

      document.addEventListener('app:expenses-changed', () => {
        renderCalendar();
        updateDashboard();
      });
      document.addEventListener('app:stores-changed', () => populateSideStores());

      // bottom nav sync
      (function syncBottomNav() {
        const path = location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('.bottom-nav .nav-item').forEach(a => {
          const href = a.getAttribute('href') || '';
          a.classList.toggle('nav-active', href.endsWith(path));
        });
      })();

      // service worker attempt
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(err => console.warn('SW register failed', err));
      }
    })();
  </script>
</body>
</html>