<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GroceryHub - Dashboard</title>

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="FDE6748E-E787-40BF-B6FD-203C136F8138.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">

  <!-- Icone -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- style esterno "bellissima" -->
  <link rel="stylesheet" href="style.css?v=20250816">
</head>
<body>
  <header>
    <div class="hamburger" id="menuToggle" aria-label="Apri menu" title="Apri menu">
      <i class="fa-solid fa-bars"></i>
    </div>

    <div class="title-wrap" role="banner">
      <!-- GroceryHub attaccato -->
      <div class="title-row" aria-hidden="true">
        <h1 class="groceryhub">Grocery<span class="hub">Hub</span></h1>
      </div>
      <div class="payoff">Controlla, risparmia, vivi meglio</div>
    </div>
  </header>

  <!-- overlay per chiudere tappando fuori dal menu -->
  <div id="menuOverlay" class="menu-overlay" aria-hidden="true"></div>

  <!-- off-canvas menu (solo navigazione) -->
  <nav id="sideMenu" style="display:none; position:fixed; left:0; top:0; bottom:0; width:78%; max-width:340px; background:#fff; z-index:3500; box-shadow: 6px 0 30px rgba(0,0,0,0.12); padding:18px;">
    <div class="menu-header">
      <div class="menu-logo">GH</div>
      <div>
        <div style="font-weight:800;">GroceryHub</div>
        <div style="font-size:0.9rem;color:var(--gh-muted)">La tua gestione spese</div>
      </div>
    </div>

    <div class="menu-section">
      <div style="font-size:0.95rem;font-weight:700;margin-bottom:8px;">Navigazione</div>
      <a href="index.html"><i class="fa-solid fa-house" style="width:18px;margin-right:8px;"></i> Dashboard</a>
      <a href="aggiungi.html"><i class="fa-solid fa-plus" style="width:18px;margin-right:8px;"></i> Aggiungi spesa</a>
      <a href="archivio.html"><i class="fa-solid fa-archive" style="width:18px;margin-right:8px;"></i> Archivio</a>
      <a href="impostazioni.html"><i class="fa-solid fa-gear" style="width:18px;margin-right:8px;"></i> Impostazioni</a>
    </div>
  </nav>

  <main class="dashboard" role="main" aria-live="polite">
    <!-- calendar -->
    <section class="calendar-wrap" aria-label="Selezione giorno">
      <div class="calendar-row" id="calendarRow" aria-hidden="false"></div>
      <div id="daySummary" class="day-summary" aria-live="polite"></div>
    </section>

    <!-- Riepilogo -->
    <section>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="font-weight:700;font-size:1.06rem;">Riepilogo</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <!-- Period selector: 'giorno' è default -->
          <select id="periodSelect" style="padding:6px 8px;border-radius:8px;border:1px solid #ddd;">
            <option value="giorno" selected>Giorno</option>
            <option value="settimana">Settimana</option>
            <option value="mese">Mese</option>
            <option value="anno">Anno</option>
          </select>
        </div>
      </div>

      <div class="blocks">
        <div class="block total">
          <div>
            <div class="label">Totale spese</div>
            <div id="totalAmountBlock" class="value">€0.00</div>
          </div>
        </div>

        <div class="block max">
          <div>
            <div class="label">Spesa massima</div>
            <div id="maxAmountBlock" class="value">€0.00</div>
            <div style="font-size:0.85rem;color:rgba(0,0,0,0.7)" id="maxStoreBlock"></div>
          </div>
        </div>

        <div class="block min">
          <div>
            <div class="label">Spesa minima</div>
            <div id="minAmountBlock" class="value">€0.00</div>
            <div style="font-size:0.85rem;color:rgba(0,0,0,0.7)" id="minStoreBlock"></div>
          </div>
        </div>

        <div class="block count">
          <div>
            <div class="label">Numero spese</div>
            <div id="countBlock" class="value">0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- charts -->
    <section class="charts-section" aria-label="Grafici comparativi">
      <div class="chart-container">
        <h3>Supermercati più usati</h3>
        <canvas id="storeChart" width="300" height="300" role="img" aria-label="Grafico supermercati più usati"></canvas>
        <div id="storeStats" class="chart-legend"></div>
      </div>

      <div class="chart-container">
        <h3>Tipologie prodotti</h3>
        <canvas id="categoryChart" width="300" height="300" role="img" aria-label="Grafico tipologie prodotti"></canvas>
        <div id="categoryStats" class="chart-legend"></div>
      </div>
    </section>

    <!-- recent -->
    <section style="margin-top:18px;">
      <h3>Ultime spese</h3>
      <div id="recentList" class="recent-list"></div>
    </section>
  </main>

  <!-- bottom nav -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a href="index.html" class="nav-item nav-active" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-house"></i></span>
    </a>
    <a href="aggiungi.html" class="nav-item" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
    </a>
    <a href="archivio.html" class="nav-item" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
    </a>
    <a href="impostazioni.html" class="nav-item" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
    </a>
  </nav>

  <!-- App core (non modificato) -->
  <script src="app.js"></script>

  <!-- Inline app-specific JS (calendario, widgets) -->
  <script>
    /* ===== Helpers & settings (local) ===== */
    const SETTINGS_KEY = 'gh_settings';
    function loadSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (!raw) {
          const def = { weeklyBudget: 100 };
          localStorage.setItem(SETTINGS_KEY, JSON.stringify(def));
          return def;
        }
        return JSON.parse(raw);
      } catch (e) { return { weeklyBudget:100 }; }
    }
    function getBudgetForPeriod(period) {
      const s = loadSettings();
      const w = parseFloat(s.weeklyBudget) || 0;
      switch(period) {
        case 'settimana': return w;
        case 'mese': return w * 4;
        case 'anno': return w * 52;
        default: return w * 4;
      }
    }

    /* ===== Calendar rendering (exact 5 pills) ===== */
    const calendarRow = document.getElementById('calendarRow');
    const daySummary = document.getElementById('daySummary');
    let selectedDateKey = null; // YYYY-MM-DD

    function formatKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function shortDayName(d) {
      return d.toLocaleDateString('it-IT', { weekday: 'short' }); // "lun"
    }
    function longMonth(d) {
      return d.toLocaleDateString('it-IT', { month: 'long' }); // "agosto"
    }

    function getExpensesForKey(key) {
      return (app.expenses || []).filter(e => e.date === key);
    }

    // helper: iso today
    function isoToday() {
      const d = new Date();
      return d.toISOString().split('T')[0];
    }

    function renderCalendar() {
      if (!calendarRow) return;
      calendarRow.innerHTML = '';

      // center on selectedDateKey if present, otherwise today
      const centerDate = selectedDateKey ? new Date(selectedDateKey) : new Date();
      // Exactly 5 pills: -2, -1, 0(center), +1, +2
      for (let offset = -2; offset <= 2; offset++) {
        const d = new Date(centerDate);
        d.setDate(centerDate.getDate() + offset);
        const key = formatKey(d);
        const todayKey = formatKey(new Date());
        const isToday = (todayKey === key);
        const hasExpenses = getExpensesForKey(key).length > 0;

        const pill = document.createElement('button');
        pill.className = 'day-pill';
        if (offset === -2 || offset === 2) pill.classList.add('adjacent-2');
        else if (offset === -1 || offset === 1) pill.classList.add('adjacent');
        pill.dataset.key = key;
        pill.type = 'button';
        pill.setAttribute('aria-pressed', 'false');

        // selection logic
        if (selectedDateKey === null && isToday && offset === 0) {
          pill.classList.add('selected');
          selectedDateKey = key;
        } else if (key === selectedDateKey) {
          pill.classList.add('selected');
        }

        pill.innerHTML = `
          <div class="day-num">${d.getDate()}</div>
          <div class="day-name">${shortDayName(d)}</div>
          <div class="month">${longMonth(d)}</div>
          <div class="has-expense-dot ${hasExpenses ? '' : 'hidden'}" aria-hidden="true"></div>
        `;
        pill.addEventListener('click', () => onDayClick(key, pill));
        calendarRow.appendChild(pill);
      }

      // center the selected pill in view (only on render)
      setTimeout(centerSelectedPill, 80);

      // initial summary
      if (selectedDateKey) showDaySummary(selectedDateKey);
    }

    function centerSelectedPill() {
      const selected = document.querySelector('.day-pill.selected');
      if (!selected || !calendarRow) return;
      const containerRect = calendarRow.getBoundingClientRect();
      const pillRect = selected.getBoundingClientRect();
      const offset = (pillRect.left + pillRect.width/2) - (containerRect.left + containerRect.width/2);
      calendarRow.scrollLeft += offset;
    }

    function onDayClick(key, pillEl) {
      const prev = document.querySelector('.day-pill.selected');
      if (prev && prev !== pillEl) prev.classList.remove('selected');
      pillEl.classList.add('selected');
      selectedDateKey = key;

      // set period to 'giorno'
      const periodSelect = document.getElementById('periodSelect');
      if (periodSelect) periodSelect.value = 'giorno';

      showDaySummary(key);
      // update whole dashboard (use giorno as period + selectedDateKey)
      updateDashboard();
      // intentionally DO NOT scroll page — user remains at same position
    }

    function showDaySummary(key) {
      const exps = getExpensesForKey(key);
      if (!exps || exps.length === 0) {
        daySummary.classList.remove('show');
        daySummary.innerHTML = `<div class="empty">Nessuna spesa registrata per ${key}</div>`;
        return;
      }
      const total = exps.reduce((s,e)=> s + (parseFloat(e.total)||0), 0);
      daySummary.classList.add('show');
      daySummary.innerHTML = `<strong>Hai fatto ${exps.length} spesa${exps.length>1?'e':''} spendendo un totale di ${app.formatCurrency(total)}</strong>
        <div style="margin-top:8px;color:var(--gh-muted);font-size:0.95rem">
          ${exps.map(e => `${app.formatDate(e.date)} — ${e.store}: ${app.formatCurrency(e.total)}`).join('<br>')}
        </div>`;
    }

    /* ===== Drag/touch for calendar row (slider) ===== */
    (function() {
      const container = document.querySelector('.calendar-row');
      if (!container) return;
      let isDown = false, startX = 0, scrollLeft = 0;
      container.addEventListener('mousedown', (e) => {
        isDown = true;
        startX = e.pageX - container.offsetLeft;
        scrollLeft = container.scrollLeft;
        container.classList.add('dragging');
      });
      container.addEventListener('mouseleave', () => { isDown = false; container.classList.remove('dragging'); });
      container.addEventListener('mouseup', () => { isDown = false; container.classList.remove('dragging'); });
      container.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - container.offsetLeft;
        const walk = (x - startX) * 1.2;
        container.scrollLeft = scrollLeft - walk;
      });

      // touch
      let touchStartX = 0, touchStartScroll = 0;
      container.addEventListener('touchstart', e => {
        touchStartX = e.touches[0].pageX;
        touchStartScroll = container.scrollLeft;
      }, { passive: true });
      container.addEventListener('touchmove', e => {
        const x = e.touches[0].pageX;
        const walk = (touchStartX - x);
        container.scrollLeft = touchStartScroll + walk;
      }, { passive: true });
    })();

    /* ===== Pie drawing (keeps previous behaviour) ===== */
    function drawPieChart(canvasId, data, statsId, palette) {
      const canvas = document.getElementById(canvasId);
      const statsDiv = document.getElementById(statsId);
      if (!canvas || !statsDiv) return;
      const ctx = canvas.getContext('2d');
      const entries = Object.entries(data || {}).sort((a,b)=> b[1].total - a[1].total).slice(0,6);
      if (entries.length === 0) {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#666'; ctx.font = '14px Arial'; ctx.textAlign = 'center'; ctx.fillText('Nessun dato', canvas.width/2, canvas.height/2);
        statsDiv.innerHTML = '<div style="text-align:center;color:#666">Nessun dato disponibile</div>';
        return;
      }
      const total = entries.reduce((s,[,d]) => s + d.total, 0);
      let currentAngle = -Math.PI/2;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const cx = canvas.width/2, cy = canvas.height/2, radius = Math.min(cx,cy)-20;
      entries.forEach(([label,d], idx) => {
        const slice = (d.total / total) * 2*Math.PI;
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,radius,currentAngle,currentAngle+slice); ctx.closePath();
        ctx.fillStyle = palette[idx % palette.length]; ctx.fill();
        currentAngle += slice;
      });
      statsDiv.innerHTML = entries.map(([label,d], idx) =>
        `<div style="display:flex;justify-content:space-between;"><div><span style="color:${palette[idx % palette.length]};margin-right:6px">●</span>${label}</div><div>${app.formatCurrency(d.total)}</div></div>`
      ).join('');
    }

    /* ===== Update dashboard content (no donut) ===== */
    function updateDashboard() {
      const periodSelect = document.getElementById('periodSelect');
      const period = periodSelect?.value || 'mese';

      // Use selectedDateKey as reference for 'giorno'. For other periods some apps may accept a refDate argument;
      // try to call app.filterByPeriod(period, refDate) defensively, otherwise fallback to previous behaviour.
      let filtered;
      try {
        if (typeof app.filterByPeriod === 'function') {
          const refDate = (period === 'giorno') ? selectedDateKey : null;
          // call with two args if supported
          filtered = app.filterByPeriod.length >= 2 ? app.filterByPeriod(period, refDate) : app.filterByPeriod(period);
        } else {
          filtered = app.expenses || [];
        }
      } catch (e) {
        filtered = app.expenses || [];
      }

      const stats = app.getStats(filtered);

      document.getElementById('totalAmountBlock').textContent = app.formatCurrency(stats.total);
      document.getElementById('maxAmountBlock').textContent = app.formatCurrency(stats.max.amount);
      document.getElementById('minAmountBlock').textContent = app.formatCurrency(stats.min.amount);
      document.getElementById('countBlock').textContent = stats.count;
      document.getElementById('maxStoreBlock').textContent = stats.max.store || '';
      document.getElementById('minStoreBlock').textContent = stats.min.store || '';

      const palette = [
        (getComputedStyle(document.documentElement).getPropertyValue('--gh-salvia') || '#7aa986').trim(),
        (getComputedStyle(document.documentElement).getPropertyValue('--gh-mustard') || '#d6a63f').trim(),
        (getComputedStyle(document.documentElement).getPropertyValue('--gh-terracotta') || '#c7683c').trim(),
        '#f6cfa7','#8fb9a0','#f3b25b'
      ];

      drawPieChart('storeChart', stats.storeStats, 'storeStats', palette);
      drawPieChart('categoryChart', stats.categoryStats, 'categoryStats', palette);

      // update recent list relative to same filter
      loadRecentExpenses(filtered);
    }

    function loadRecentExpenses(expenses) {
      const recentList = document.getElementById('recentList');
      if (!recentList) return;
      const recent = (expenses || []).slice(-6).reverse();
      if (!recent.length) {
        recentList.innerHTML = '<div class="no-expenses">Nessuna spesa recente</div>';
        return;
      }
      recentList.innerHTML = recent.map(exp => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(0,0,0,0.04);">
          <div>
            <strong style="display:block">${exp.store}</strong>
            <small style="color:var(--gh-muted)">${app.formatDate(exp.date)} • ${exp.products?.length || 0} prodotti</small>
          </div>
          <div style="font-weight:700">${app.formatCurrency(exp.total)}</div>
        </div>
      `).join('');
    }

    /* ===== Side menu helpers: populate store list dynamically (kept for other pages) ===== */
    function populateSideMenuStores() {
      const container = document.getElementById('storesList');
      if (!container) return;
      const stores = (app.getStores && typeof app.getStores === 'function') ? app.getStores() : [];
      if (!stores || !stores.length) {
        container.innerHTML = '<div style="color:var(--gh-muted)">Nessun supermercato</div>';
        return;
      }
      container.innerHTML = '';
      stores.forEach(s => {
        const el = document.createElement('div');
        el.style.padding = '6px 0';
        el.textContent = s;
        container.appendChild(el);
      });
    }

    /* ===== Wiring ===== */
    document.addEventListener('DOMContentLoaded', () => {
      // side menu open/close using overlay tap to close
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuOverlay = document.getElementById('menuOverlay');

      function openMenu() {
        if (!sideMenu || !menuOverlay) return;
        menuOverlay.style.display = 'block';
        setTimeout(() => menuOverlay.classList.add('visible'), 20);
        sideMenu.style.display = 'block';
        sideMenu.classList.add('open');
        document.body.classList.add('no-scroll');
        menuOverlay.setAttribute('aria-hidden', 'false');
      }
      function closeMenu() {
        if (!sideMenu || !menuOverlay) return;
        menuOverlay.classList.remove('visible');
        sideMenu.classList.remove('open');
        document.body.classList.remove('no-scroll');
        menuOverlay.setAttribute('aria-hidden', 'true');
        setTimeout(() => {
          menuOverlay.style.display = 'none';
          sideMenu.style.display = 'none';
        }, 220);
      }

      menuToggle?.addEventListener('click', (e) => {
        e.stopPropagation();
        openMenu();
      });

      // close when tapping overlay
      menuOverlay?.addEventListener('click', () => {
        closeMenu();
      });

      // close when clicking a nav link inside menu (navigation)
      document.querySelectorAll('#sideMenu a').forEach(a => {
        a.addEventListener('click', () => {
          closeMenu();
        });
      });

      // initial render
      renderCalendar();
      updateDashboard();
      populateSideMenuStores();

      // listeners
      window.addEventListener('resize', () => setTimeout(renderCalendar, 120));

      // when period changes, update dashboard
      document.getElementById('periodSelect')?.addEventListener('change', () => {
        const p = document.getElementById('periodSelect').value;
        // if switched to 'giorno' and we have selectedDateKey, ensure selected is used
        if (p === 'giorno' && selectedDateKey) {
          // nothing extra required — updateDashboard will use selectedDateKey
        }
        updateDashboard();
      });

      // respond to app changes
      document.addEventListener('app:expenses-changed', () => {
        renderCalendar();
        updateDashboard();
        populateSideMenuStores();
      });

      // sync bottom-nav active state
      (function () {
        const path = location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('.bottom-nav .nav-item').forEach(a => {
          const href = a.getAttribute('href') || '';
          a.classList.toggle('nav-active', href.endsWith(path));
        });
      })();
    });
  </script>
</body>
</html>