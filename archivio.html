<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archivio Spese</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Archivio Spese</h1>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="aggiungi.html">Aggiungi</a>
      <a href="archivio.html" class="nav-active">Archivio</a>
      <a href="impostazioni.html">Impostazioni</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>Tutte le Spese</h2>

      <!-- Filtri con etichette chiare -->
      <div class="filters" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;align-items:end;">
        <div style="display:flex;flex-direction:column;min-width:160px;">
          <label for="filterStore" style="color:var(--text-secondary);font-weight:600;">Supermercato</label>
          <select id="filterStore" class="store-select" aria-label="Filtra per supermercato"></select>
        </div>

        <div style="display:flex;flex-direction:column;">
          <label for="filterDate" style="color:var(--text-secondary);font-weight:600;">Data (giorno)</label>
          <input type="date" id="filterDate" aria-label="Filtra per data" />
        </div>

        <div style="flex:1; min-width:180px; display:flex;flex-direction:column;">
          <label for="filterProduct" style="color:var(--text-secondary);font-weight:600;">Prodotto (nome)</label>
          <input type="text" id="filterProduct" placeholder="Cerca prodotto..." aria-label="Filtra per prodotto" />
        </div>

        <div style="display:flex;gap:8px;align-items:center;">
          <button id="applyFiltersBtn" class="btn btn-secondary small-btn" title="Applica filtri">üîé Applica</button>
          <button id="searchOFBtn" class="btn btn-secondary small-btn" title="Cerca manualmente su Open Food Facts">üîé Cerca OF</button>
          <button id="clearFiltersBtn" class="btn small-btn" title="Rimuovi filtri">‚úñ Rimuovi filtri</button>
        </div>
      </div>

      <!-- Status filtri / messaggio inline -->
      <div id="filterStatus" class="filter-status" aria-live="polite" role="status" style="margin-bottom:10px;"></div>

      <!-- Contenitore spese -->
      <div id="expenseList" aria-live="polite"></div>
    </section>
  </main>

  <!-- Importa la logica condivisa -->
  <script src="app.js"></script>
  <script>
    // helper: escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function formatCurrencySafe(amount) {
      if (typeof app?.formatCurrency === 'function') return app.formatCurrency(amount || 0);
      try {
        return new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(amount || 0);
      } catch { return `‚Ç¨${Number(amount||0).toFixed(2)}`; }
    }

    function formatDateSafe(dateStr) {
      if (typeof app?.formatDate === 'function') return app.formatDate(dateStr);
      const d = dateStr ? new Date(dateStr) : new Date();
      try {
        return new Intl.DateTimeFormat('it-IT', { year:'numeric', month:'short', day:'numeric' }).format(d);
      } catch { return d.toLocaleDateString('it-IT'); }
    }

    // aggiorna messaggio status filtro (risultati / nessun risultato)
    function updateFilterStatus(foundCount, totalCount, activeFilters) {
      const statusEl = document.getElementById('filterStatus');
      if (!statusEl) return;
      const filtersText = activeFilters.length ? `Filtri attivi: ${activeFilters.join(', ')}` : 'Nessun filtro attivo';
      if (foundCount === 0) {
        statusEl.innerHTML = `<span style="color:var(--text-secondary)">Nessuna spesa trovata. ${filtersText}.</span>`;
      } else {
        statusEl.innerHTML = `<strong>${foundCount}</strong> spesa${foundCount>1 ? 'e' : ''} trovata${foundCount>1 ? '' : ''} su <strong>${totalCount}</strong>. ${filtersText}.`;
      }
    }

    // render lista spese con filtri
    function renderArchive() {
      const storeFilter = (document.getElementById('filterStore').value || '').trim().toLowerCase();
      const dateFilter = (document.getElementById('filterDate').value || '').trim();
      const productFilter = (document.getElementById('filterProduct').value || '').trim().toLowerCase();

      const container = document.getElementById('expenseList');
      if (!container) return;

      // prendi la sorgente pi√π aggiornata
      let expenses = (typeof app?.loadExpenses === 'function') ? app.loadExpenses() : (app.expenses || []);
      const totalCount = expenses.length;

      // ordina per data (pi√π recente prima)
      expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

      // applica filtri
      const activeFilters = [];
      if (storeFilter) {
        activeFilters.push(`Supermercato: ${storeFilter}`);
        expenses = expenses.filter(exp => (exp.store || '').toLowerCase() === storeFilter);
      }
      if (dateFilter) {
        activeFilters.push(`Data: ${dateFilter}`);
        // confronto su inizio stringa ISO YYYY-MM-DD
        expenses = expenses.filter(exp => (exp.date || '').startsWith(dateFilter));
      }
      if (productFilter) {
        activeFilters.push(`Prodotto: ${productFilter}`);
        expenses = expenses.filter(exp => Array.isArray(exp.products) && exp.products.some(p => (p.name || '').toLowerCase().includes(productFilter)));
      }

      // aggiorna stato filtro *prima* di render
      updateFilterStatus(expenses.length, totalCount, activeFilters);

      if (!expenses.length) {
        container.innerHTML = '<div class="no-expenses">Nessuna spesa trovata con i filtri selezionati.</div>';
        return;
      }

      // build HTML
      container.innerHTML = expenses.map(exp => {
        const productCount = (exp.products || []).length;
        return `
          <div style="margin-bottom:8px;">
            <div class="recent-item" style="display:flex;justify-content:space-between;align-items:center;">
              <div class="recent-info" style="flex:1;min-width:0;">
                <strong>üè™ ${escapeHtml(exp.store || '')}</strong><br>
                <small>üìÖ ${formatDateSafe(exp.date)} ‚Ä¢ ${productCount} prodotti</small>
              </div>

              <div style="display:flex;align-items:center;gap:8px;">
                <div class="recent-amount" style="font-weight:700; margin-right:8px;">${formatCurrencySafe(exp.total)}</div>
                <button class="delete-expense remove-btn" data-id="${exp.id}" title="Elimina spesa">üóëÔ∏è</button>
              </div>
            </div>

            ${renderProducts(exp.products)}
          </div>
        `;
      }).join('');
      
      // attacca listener eliminazione dopo render
      container.querySelectorAll('.delete-expense').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('Sei sicuro di voler eliminare questa spesa?')) return;
          app.deleteExpense(btn.dataset.id);
          renderArchive();
        });
      });
    }

    function renderProducts(products = []) {
      if (!products || !products.length) return '';
      const rows = products.map(p => `
        <div class="product-item" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03);">
          <div style="min-width:0;">
            <strong>${escapeHtml(p.name || '')}</strong>
            <div class="category" style="color:var(--text-secondary);font-size:0.85rem">${escapeHtml(p.category || '')}${p.notes ? ' ‚Ä¢ ' + escapeHtml(p.notes) : ''}</div>
          </div>
          <div class="product-price" style="margin-left:12px;">${formatCurrencySafe(p.price)}</div>
        </div>
      `).join('');
      return `<div class="product-list" style="margin:6px 0 12px 0;">${rows}</div>`;
    }

    // Reset filtri
    function clearFilters() {
      const s = document.getElementById('filterStore');
      const d = document.getElementById('filterDate');
      const p = document.getElementById('filterProduct');
      if (s) s.value = '';
      if (d) d.value = '';
      if (p) p.value = '';
      // focalizza sul primo campo per comodit√†
      if (p) p.focus();
      renderArchive();
    }

    // Cerca manuale su Open Food Facts (apre nuova scheda con query)
    function openSearchOnOpenFoodFacts() {
      const q = (document.getElementById('filterProduct').value || '').trim();
      if (!q) {
        // se non c'√® query, chiedi conferma per aprire la home
        if (confirm('Nessun termine inserito. Aprire la pagina principale di Open Food Facts?')) {
          window.open('https://world.openfoodfacts.org', '_blank', 'noopener');
        }
        return;
      }
      // usa l'endpoint di ricerca (pagina web) con query
      const url = 'https://world.openfoodfacts.org/cgi/search.pl?search_terms=' + encodeURIComponent(q) + '&search_simple=1&action=process';
      window.open(url, '_blank', 'noopener');
    }

    // popolamento store select e wiring events
    document.addEventListener('DOMContentLoaded', () => {
      // popola select tramite app (se app caricato)
      try { app.populateAllStoreSelects(); } catch (e) { /* ignore */ }

      const filterStore = document.getElementById('filterStore');
      const filterDate = document.getElementById('filterDate');
      const filterProduct = document.getElementById('filterProduct');
      const applyBtn = document.getElementById('applyFiltersBtn');
      const clearBtn = document.getElementById('clearFiltersBtn');
      const searchBtn = document.getElementById('searchOFBtn');

      // eventi di filtro (debounce per input testo)
      let debounce;
      filterStore?.addEventListener('change', renderArchive);
      filterDate?.addEventListener('input', renderArchive);
      filterProduct?.addEventListener('input', () => { clearTimeout(debounce); debounce = setTimeout(renderArchive, 220); });

      applyBtn?.addEventListener('click', (e) => { e.preventDefault(); renderArchive(); });
      clearBtn?.addEventListener('click', (e) => { e.preventDefault(); clearFilters(); });

      searchBtn?.addEventListener('click', (e) => { e.preventDefault(); openSearchOnOpenFoodFacts(); });

      // invio con ENTER nella text input: applica filtri
      filterProduct?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          renderArchive();
        }
      });

      // reagisci a cambi listato negozi da altre schede
      document.addEventListener('app:stores-changed', () => {
        try { app.populateAllStoreSelects(); } catch (e) {}
      });

      // reagisci a cambi delle spese (es: eliminazione da altra scheda)
      document.addEventListener('app:expenses-changed', () => {
        renderArchive();
      });

      // iniziale render
      renderArchive();
    });
  </script>
</body>
</html>