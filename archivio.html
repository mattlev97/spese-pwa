<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archivio Spese</title>

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Archivio Spese</h1>
    <nav class="top-nav">
      <a href="index.html">Dashboard</a>
      <a href="aggiungi.html">Aggiungi</a>
      <a href="archivio.html" class="nav-active">Archivio</a>
      <a href="impostazioni.html">Impostazioni</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>Tutte le Spese</h2>

      <div class="filters" style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;align-items:end;">
        <div style="display:flex;flex-direction:column;min-width:160px;">
          <label for="filterStore" style="color:var(--text-secondary);font-weight:600;">Supermercato</label>
          <select id="filterStore" class="store-select" aria-label="Filtra per supermercato"></select>
        </div>

        <div style="display:flex;flex-direction:column;">
          <label for="filterDate" style="color:var(--text-secondary);font-weight:600;">Data (giorno)</label>
          <input type="date" id="filterDate" aria-label="Filtra per data" />
        </div>

        <div style="flex:1; min-width:180px; display:flex;flex-direction:column;">
          <label for="filterProduct" style="color:var(--text-secondary);font-weight:600;">Prodotto (nome)</label>
          <input type="text" id="filterProduct" placeholder="Cerca prodotto..." aria-label="Filtra per prodotto" />
        </div>

        <div class="filter-actions" style="display:flex;gap:8px;align-items:center;width:240px;max-width:40%;">
          <button id="clearFiltersBtn" class="btn small-btn" title="Rimuovi filtri">‚úñ Rimuovi filtri</button>
        </div>
      </div>

      <div id="filterStatus" class="filter-status" aria-live="polite" role="status" style="margin-bottom:10px;"></div>

      <div id="expenseList" aria-live="polite"></div>
    </section>
  </main>

  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a class="nav-item" href="index.html" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a class="nav-item" href="aggiungi.html" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a class="nav-item nav-active" href="archivio.html" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a class="nav-item" href="impostazioni.html" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <script src="app.js"></script>
  <script>
    function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text||''; return d.innerHTML; }
    function formatCurrencySafe(amount) { if (typeof app?.formatCurrency === 'function') return app.formatCurrency(amount || 0); try { return new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(amount || 0); } catch { return `‚Ç¨${Number(amount||0).toFixed(2)}`; } }
    function formatDateSafe(dateStr) { if (typeof app?.formatDate === 'function') return app.formatDate(dateStr || ''); const d = dateStr ? new Date(dateStr) : new Date(); try { return new Intl.DateTimeFormat('it-IT', { year:'numeric', month:'short', day:'numeric' }).format(d); } catch { return d.toLocaleDateString('it-IT'); } }

    function updateFilterStatus(foundCount, totalCount, activeFilters) {
      const statusEl = document.getElementById('filterStatus');
      if (!statusEl) return;
      const filtersText = activeFilters.length ? `Filtri attivi: ${activeFilters.join(', ')}` : 'Nessun filtro attivo';
      if (foundCount === 0) {
        statusEl.innerHTML = `<span style="color:var(--text-secondary)">Nessuna spesa trovata. ${filtersText}.</span>`;
      } else {
        statusEl.innerHTML = `<strong>${foundCount}</strong> spesa${foundCount>1 ? 'e' : ''} trovata su <strong>${totalCount}</strong>. ${filtersText}.`;
      }
    }

    function renderProducts(exp) {
      if (!exp || !Array.isArray(exp.products) || exp.products.length === 0) return '';
      return `<div style="margin-top:8px; color:var(--text-secondary); font-size:0.9rem;">
        ${exp.products.slice(0,3).map(p => escapeHtml(p.name)).join(', ')}${exp.products.length>3 ? ' ‚Ä¶' : ''}
      </div>`;
    }

    function renderArchive() {
      const storeFilter = (document.getElementById('filterStore').value || '').trim().toLowerCase();
      const dateFilter = (document.getElementById('filterDate').value || '').trim();
      const productFilter = (document.getElementById('filterProduct').value || '').trim().toLowerCase();
      const container = document.getElementById('expenseList');
      if (!container) return;
      let expenses = (typeof app?.loadExpenses === 'function') ? app.loadExpenses() : (app.expenses || []);
      const totalCount = expenses.length;
      expenses.sort((a,b) => new Date(b.date) - new Date(a.date));
      const activeFilters = [];
      if (storeFilter) { activeFilters.push(`Supermercato: ${storeFilter}`); expenses = expenses.filter(exp => (exp.store||'').toLowerCase() === storeFilter); }
      if (dateFilter) { activeFilters.push(`Data: ${dateFilter}`); expenses = expenses.filter(exp => (exp.date||'').startsWith(dateFilter)); }
      if (productFilter) { activeFilters.push(`Prodotto: ${productFilter}`); expenses = expenses.filter(exp => Array.isArray(exp.products) && exp.products.some(p => (p.name||'').toLowerCase().includes(productFilter))); }

      updateFilterStatus(expenses.length, totalCount, activeFilters);
      if (!expenses.length) { container.innerHTML = '<div class="no-expenses">Nessuna spesa trovata con i filtri selezionati.</div>'; return; }

      container.innerHTML = expenses.map(exp => {
        const productCount = (exp.products || []).length;
        const detailsUrl = `dettaglio.html?id=${encodeURIComponent(exp.id)}`;
        // pick first product image if any
        const firstImage = (exp.products||[]).find(p => p.image && p.image.length) || null;
        const thumbHtml = firstImage ? `<img class="thumb" src="${escapeHtml(firstImage.image)}" alt="${escapeHtml(firstImage.name||'')}" style="margin-right:10px;">` : `<div class="image-placeholder" style="margin-right:10px;">No foto</div>`;
        return `
          <div style="margin-bottom:12px; padding:12px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.02);">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
              <div style="display:flex;align-items:center;gap:12px;min-width:0;flex:1;">
                ${thumbHtml}
                <div style="min-width:0;">
                  <strong>üè™ ${escapeHtml(exp.store || '')}</strong>
                  <div style="color:var(--text-secondary); font-size:0.92rem;">üìÖ ${formatDateSafe(exp.date)} ‚Ä¢ ${productCount} prodotti</div>
                  ${renderProducts(exp)}
                </div>
              </div>

              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
                <div style="font-weight:700;">${formatCurrencySafe(exp.total)}</div>
                <div style="display:flex;gap:8px;">
                  <a class="btn btn-secondary" href="${detailsUrl}">Dettagli</a>
                  <button class="delete-expense btn small-btn" data-id="${exp.id}" title="Elimina spesa">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.querySelectorAll('.delete-expense').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('Sei sicuro di voler eliminare questa spesa?')) return;
          app.deleteExpense(btn.dataset.id);
          renderArchive();
        });
      });
    }

    function clearFilters() {
      const s = document.getElementById('filterStore');
      const d = document.getElementById('filterDate');
      const p = document.getElementById('filterProduct');
      if (s) s.value = '';
      if (d) d.value = '';
      if (p) p.value = '';
      if (p) p.focus();
      renderArchive();
    }

    (function syncBottomNavActive() {
      const path = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.bottom-nav .nav-item').forEach(a => {
        try { const href = a.getAttribute('href') || ''; if (href.endsWith(path)) a.classList.add('nav-active'); else a.classList.remove('nav-active'); } catch(e) {}
      });
    })();

    document.addEventListener('DOMContentLoaded', () => {
      try { app.populateAllStoreSelects(); } catch (e) {}
      const filterStore = document.getElementById('filterStore');
      const filterDate = document.getElementById('filterDate');
      const filterProduct = document.getElementById('filterProduct');
      const clearBtn = document.getElementById('clearFiltersBtn');

      let debounce;
      filterStore?.addEventListener('change', renderArchive);
      filterDate?.addEventListener('input', renderArchive);
      filterProduct?.addEventListener('input', () => { clearTimeout(debounce); debounce = setTimeout(renderArchive, 220); });

      clearBtn?.addEventListener('click', (e) => { e.preventDefault(); clearFilters(); });

      filterProduct?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); renderArchive(); }
      });

      document.addEventListener('app:stores-changed', () => { try { app.populateAllStoreSelects(); } catch(e){} });
      document.addEventListener('app:expenses-changed', () => { renderArchive(); });

      renderArchive();
    });
  </script>
</body>
</html>