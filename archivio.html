<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archivio Spese</title>

  <!-- Font Awesome (icone bottom nav) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">

  <!-- Stili principali -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Header identico a index/aggiungi -->
  <header>
    <div class="hamburger" id="menuToggle" aria-label="Apri menu" title="Apri menu">
      <i class="fa-solid fa-bars"></i>
    </div>

    <div class="title-wrap" role="banner">
      <div class="title-row" aria-hidden="true">
        <h1 class="groceryhub">Grocery<span class="hub">Hub</span></h1>
      </div>
      <div class="payoff">Controlla, risparmia, vivi meglio</div>
    </div>
  </header>

  <!-- Side menu off-canvas (stesso pattern) -->
  <nav id="sideMenu" aria-hidden="true" class="hidden" role="navigation">
    <div class="menu-header">
      <div class="menu-logo">GH</div>
      <div>
        <div style="font-weight:800;">GroceryHub</div>
        <div style="font-size:0.9rem;color:var(--gh-muted)">La tua gestione spese</div>
      </div>
    </div>

    <div class="menu-section">
      <div style="font-size:0.95rem;font-weight:700;margin-bottom:8px;">Navigazione</div>
      <a href="index.html"><i class="fa-solid fa-house" style="width:18px;margin-right:8px;"></i> Dashboard</a>
      <a href="aggiungi.html"><i class="fa-solid fa-plus" style="width:18px;margin-right:8px;"></i> Aggiungi spesa</a>
      <a href="archivio.html"><i class="fa-solid fa-archive" style="width:18px;margin-right:8px;"></i> Archivio</a>
      <a href="impostazioni.html"><i class="fa-solid fa-gear" style="width:18px;margin-right:8px;"></i> Impostazioni</a>
    </div>

    <div class="menu-section">
      <div style="font-size:0.95rem;font-weight:700;margin-bottom:8px;">Supermercati</div>
      <div id="storesList">Caricamento‚Ä¶</div>
      <div style="margin-top:8px;">
        <button id="addStoreBtn" class="btn btn-secondary">Aggiungi supermercato</button>
      </div>
    </div>

    <div class="menu-section" style="margin-top:auto;">
      <div style="font-size:0.9rem;color:var(--gh-muted)">Versione app</div>
      <div style="font-weight:700">1.0.0</div>
      <div style="margin-top:8px;"><button id="menuClose" class="btn" style="background:var(--gh-terracotta);">Chiudi menu</button></div>
    </div>
  </nav>

  <main class="dashboard" role="main" aria-live="polite">
    <section class="panel">
      <div class="section-header">
        <div class="icon-circle" aria-hidden="true"><i class="fa-solid fa-filter"></i></div>
        <div class="title-lines">
          <h2>Tutte le Spese</h2>
          <div class="subtitle">Filtra e trova velocemente le spese salvate</div>
        </div>
      </div>

      <form id="filtersForm" class="filters" novalidate>
        <div class="form-row">
          <div class="form-group" style="min-width:160px;">
            <label for="filterStore">Supermercato</label>
            <select id="filterStore" class="store-select" aria-label="Filtra per supermercato"></select>
          </div>

          <div class="form-group" style="min-width:150px;">
            <label for="filterDate">Data (giorno)</label>
            <input type="date" id="filterDate" aria-label="Filtra per data" />
          </div>

          <div class="form-group" style="flex:1; min-width:180px;">
            <label for="filterProduct">Prodotto (nome)</label>
            <input type="text" id="filterProduct" placeholder="Cerca prodotto..." aria-label="Filtra per prodotto" />
          </div>

          <div class="filter-actions" style="display:flex;align-items:end;">
            <button id="clearFiltersBtn" class="btn btn-secondary small-btn" title="Rimuovi filtri">‚úñ Rimuovi filtri</button>
          </div>
        </div>
      </form>

      <div id="filterStatus" class="filter-status" aria-live="polite" role="status"></div>
    </section>

    <section id="archiveListPanel" class="panel" aria-live="polite">
      <div id="expenseList" class="expense-list"></div>
    </section>
  </main>

  <!-- bottom navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a class="nav-item" href="index.html" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a class="nav-item" href="aggiungi.html" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a class="nav-item nav-active" href="archivio.html" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a class="nav-item" href="impostazioni.html" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <!-- app.js (logica condivisa) -->
  <script src="app.js"></script>

  <!-- script della pagina (funzionalit√† identiche a quelle che avevi) -->
  <script>
    // helper
    function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text||''; return d.innerHTML; }
    function formatCurrencySafe(amount) { if (typeof app?.formatCurrency === 'function') return app.formatCurrency(amount || 0); try { return new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(amount || 0); } catch { return `‚Ç¨${Number(amount||0).toFixed(2)}`; } }
    function formatDateSafe(dateStr) { if (typeof app?.formatDate === 'function') return app.formatDate(dateStr || ''); const d = dateStr ? new Date(dateStr) : new Date(); try { return new Intl.DateTimeFormat('it-IT', { year:'numeric', month:'short', day:'numeric' }).format(d); } catch { return d.toLocaleDateString('it-IT'); } }

    function updateFilterStatus(foundCount, totalCount, activeFilters) {
      const statusEl = document.getElementById('filterStatus');
      if (!statusEl) return;
      const filtersText = activeFilters.length ? `Filtri attivi: ${activeFilters.join(', ')}` : 'Nessun filtro attivo';
      if (foundCount === 0) {
        statusEl.innerHTML = `<div class="no-expenses">Nessuna spesa trovata. ${filtersText}.</div>`;
      } else {
        statusEl.innerHTML = `<div style="color:var(--text-secondary)"><strong>${foundCount}</strong> spesa${foundCount>1 ? 'e' : ''} trovata su <strong>${totalCount}</strong>. ${filtersText}.</div>`;
      }
    }

    function renderProducts(exp) {
      if (!exp || !Array.isArray(exp.products) || exp.products.length === 0) return '';
      return `<div class="archive-products">${exp.products.slice(0,3).map(p => escapeHtml(p.name)).join(', ')}${exp.products.length>3 ? ' ‚Ä¶' : ''}</div>`;
    }

    function renderArchive() {
      const storeFilter = (document.getElementById('filterStore').value || '').trim().toLowerCase();
      const dateFilter = (document.getElementById('filterDate').value || '').trim();
      const productFilter = (document.getElementById('filterProduct').value || '').trim().toLowerCase();
      const container = document.getElementById('expenseList');
      if (!container) return;
      let expenses = (typeof app?.loadExpenses === 'function') ? app.loadExpenses() : (app.expenses || []);
      const totalCount = expenses.length;
      expenses = expenses.slice().sort((a,b) => new Date(b.date) - new Date(a.date));
      const activeFilters = [];
      if (storeFilter) { activeFilters.push(`Supermercato: ${storeFilter}`); expenses = expenses.filter(exp => (exp.store||'').toLowerCase() === storeFilter); }
      if (dateFilter) { activeFilters.push(`Data: ${dateFilter}`); expenses = expenses.filter(exp => (exp.date||'').startsWith(dateFilter)); }
      if (productFilter) { activeFilters.push(`Prodotto: ${productFilter}`); expenses = expenses.filter(exp => Array.isArray(exp.products) && exp.products.some(p => (p.name||'').toLowerCase().includes(productFilter))); }

      updateFilterStatus(expenses.length, totalCount, activeFilters);
      if (!expenses.length) { container.innerHTML = '<div class="no-expenses">Nessuna spesa trovata con i filtri selezionati.</div>'; return; }

      container.innerHTML = expenses.map(exp => {
        const productCount = (exp.products || []).length;
        const detailsUrl = `dettaglio.html?id=${encodeURIComponent(exp.id)}`;

        return `
          <article class="archive-card" role="article" aria-label="Spesa ${escapeHtml(exp.store || '')} - ${escapeHtml(exp.date || '')}">
            <div class="archive-left">
              <div class="store-name">üè™ ${escapeHtml(exp.store || '')}</div>
              <div class="archive-meta">üìÖ ${formatDateSafe(exp.date)} ‚Ä¢ ${productCount} prodotti</div>
              ${renderProducts(exp)}
            </div>

            <div class="archive-right">
              <div class="archive-total">${formatCurrencySafe(exp.total)}</div>
              <div class="archive-actions">
                <a class="btn btn-secondary" href="${detailsUrl}">Dettagli</a>
                <button class="delete-expense btn small-btn" data-id="${exp.id}" title="Elimina spesa">üóëÔ∏è</button>
              </div>
            </div>
          </article>
        `;
      }).join('');

      // attach delete handlers
      container.querySelectorAll('.delete-expense').forEach(btn => {
        btn.addEventListener('click', () => {
          if (!confirm('Sei sicuro di voler eliminare questa spesa?')) return;
          app.deleteExpense(btn.dataset.id);
          renderArchive();
        });
      });
    }

    function clearFilters() {
      const s = document.getElementById('filterStore');
      const d = document.getElementById('filterDate');
      const p = document.getElementById('filterProduct');
      if (s) s.value = '';
      if (d) d.value = '';
      if (p) p.value = '';
      if (p) p.focus();
      renderArchive();
    }

    (function syncBottomNavActive() {
      const path = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.bottom-nav .nav-item').forEach(a => {
        try { const href = a.getAttribute('href') || ''; a.classList.toggle('nav-active', href.endsWith(path)); } catch(e) {}
      });
    })();

    // side menu small logic + populate stores
    function populateSideMenuStores() {
      const container = document.getElementById('storesList');
      if (!container || !window.app) return;
      const stores = app.getStores ? app.getStores() : [];
      if (!stores || stores.length === 0) {
        container.innerHTML = '<div style="color:var(--gh-muted)">Nessun supermercato</div>';
        return;
      }
      container.innerHTML = '';
      stores.forEach(s => {
        const el = document.createElement('div');
        el.style.padding = '6px 0';
        el.textContent = s;
        container.appendChild(el);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      try { app.populateAllStoreSelects(); } catch (e) {}
      populateSideMenuStores();

      const filterStore = document.getElementById('filterStore');
      const filterDate = document.getElementById('filterDate');
      const filterProduct = document.getElementById('filterProduct');
      const clearBtn = document.getElementById('clearFiltersBtn');

      let debounce;
      filterStore?.addEventListener('change', renderArchive);
      filterDate?.addEventListener('input', renderArchive);
      filterProduct?.addEventListener('input', () => { clearTimeout(debounce); debounce = setTimeout(renderArchive, 220); });

      clearBtn?.addEventListener('click', (e) => { e.preventDefault(); clearFilters(); });

      filterProduct?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); renderArchive(); }
      });

      document.addEventListener('app:stores-changed', () => { try { app.populateAllStoreSelects(); populateSideMenuStores(); } catch(e){} });
      document.addEventListener('app:expenses-changed', () => { renderArchive(); });

      // side menu toggle
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuClose = document.getElementById('menuClose');
      menuToggle?.addEventListener('click', () => { sideMenu.classList.remove('hidden'); sideMenu.setAttribute('aria-hidden','false'); });
      menuClose?.addEventListener('click', () => { sideMenu.classList.add('hidden'); sideMenu.setAttribute('aria-hidden','true'); });
      document.getElementById('addStoreBtn')?.addEventListener('click', () => {
        const name = prompt('Nome supermercato da aggiungere:');
        if (!name) return;
        const ok = app.addStore ? app.addStore(name) : false;
        if (ok) { populateSideMenuStores(); alert('Supermercato aggiunto'); } else { alert('Non √® stato possibile aggiungere (potrebbe gi√† esistere).'); }
      });

      renderArchive();

      // responsive padding for bottom nav
      const bottomNav = document.querySelector('.bottom-nav');
      const main = document.querySelector('main');
      if (bottomNav && main) {
        const navH = bottomNav.offsetHeight || 0;
        const extra = 24;
        main.style.paddingBottom = (navH + extra) + 'px';
        document.body.style.paddingBottom = (navH + extra) + 'px';
      }
    });
  </script>

</body>
</html>