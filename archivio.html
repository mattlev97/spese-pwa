<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archivio Spese</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Archivio Spese</h1>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="aggiungi.html">Aggiungi</a>
      <a href="archivio.html" class="nav-active">Archivio</a>
      <a href="impostazioni.html">Impostazioni</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>Tutte le Spese</h2>
      <div id="expenseList"></div>
    </section>
  </main>

  <!-- Importa la logica condivisa -->
  <script src="app.js"></script>
  <script>
    // Usa SEMPRE la stessa istanza globale "app" creata in app.js
    function renderArchive() {
      const container = document.getElementById('expenseList');
      if (!container) return;

      // ricarica dal localStorage usando i metodi di app, se disponibili
      const expenses = (typeof app?.loadExpenses === 'function') ? app.loadExpenses() : (app?.expenses || JSON.parse(localStorage.getItem('expenses')) || []);

      if (!expenses.length) {
        container.innerHTML = '<p>Nessuna spesa registrata.</p>';
        return;
      }

      // ordina dalla pi√π recente
      expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

      // costruisci lista
      container.innerHTML = expenses.map(exp => `
        <div class="recent-item">
          <div class="recent-info">
            <strong>üè™ ${escapeHtml(exp.store || '')}</strong><br>
            <small>üìÖ ${formatDateSafe(exp.date)} ‚Ä¢ ${exp.products ? exp.products.length : 0} prodotti</small>
          </div>
          <div class="recent-amount">${formatCurrencySafe(exp.total)}</div>
        </div>
        ${renderProducts(exp.products)}
      `).join('');
    }

    function renderProducts(products = []) {
      if (!products.length) return '';
      const rows = products.map(p => `
        <div class="product-item" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #333;">
          <div>
            <strong>${escapeHtml(p.name || '')}</strong>
            <div class="category" style="color:#bfbfc4;font-size:0.85rem">${escapeHtml(p.category || '')}${p.notes ? ' ‚Ä¢ ' + escapeHtml(p.notes) : ''}</div>
          </div>
          <div class="product-price">${formatCurrencySafe(p.price)}</div>
        </div>
      `).join('');
      return `<div class="product-list" style="margin:6px 0 16px 0;">${rows}</div>`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function formatCurrencySafe(amount) {
      if (typeof app?.formatCurrency === 'function') return app.formatCurrency(amount || 0);
      try {
        return new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' }).format(amount || 0);
      } catch { return `‚Ç¨${Number(amount||0).toFixed(2)}`; }
    }

    function formatDateSafe(dateStr) {
      if (typeof app?.formatDate === 'function') return app.formatDate(dateStr);
      const d = dateStr ? new Date(dateStr) : new Date();
      try {
        return new Intl.DateTimeFormat('it-IT', { year:'numeric', month:'short', day:'numeric' }).format(d);
      } catch { return d.toLocaleDateString('it-IT'); }
    }

    document.addEventListener('DOMContentLoaded', renderArchive);
  </script>
</body>
</html>