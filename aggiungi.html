<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggiungi Spesa</title>

  <!-- Manifest / PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#ffffff" />

  <!-- Font Awesome (icone) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">

  <!-- Stili: unificati in style.css (versione "bellissima") -->
  <link rel="stylesheet" href="style.css?v=20250816" />
</head>
<body>
  <!-- Header (identico a index) -->
  <header>
    <div class="hamburger" id="menuToggle" aria-label="Apri menu" title="Apri menu">
      <i class="fa-solid fa-bars"></i>
    </div>

    <div class="title-wrap" role="banner">
      <div class="title-row" aria-hidden="true">
        <h1 class="groceryhub">Grocery<span class="hub">Hub</span></h1>
      </div>
      <div class="payoff">Controlla, risparmia, vivi meglio</div>
    </div>
  </header>

  <!-- Off-canvas side menu (identico) -->
  <nav id="sideMenu" style="display:none; position:fixed; left:0; top:0; bottom:0; width:78%; max-width:340px; background:#fff; z-index:3500; box-shadow: 6px 0 30px rgba(0,0,0,0.12); padding:18px;">
    <div class="menu-header">
      <div class="menu-logo">GH</div>
      <div>
        <div style="font-weight:800;">GroceryHub</div>
        <div style="font-size:0.9rem;color:var(--gh-muted)">La tua gestione spese</div>
      </div>
    </div>

    <div class="menu-section">
      <div style="font-size:0.95rem;font-weight:700;margin-bottom:8px;">Navigazione</div>
      <a href="index.html"><i class="fa-solid fa-house" style="width:18px;margin-right:8px;"></i> Dashboard</a>
      <a href="aggiungi.html"><i class="fa-solid fa-plus" style="width:18px;margin-right:8px;"></i> Aggiungi spesa</a>
      <a href="archivio.html"><i class="fa-solid fa-archive" style="width:18px;margin-right:8px;"></i> Archivio</a>
      <a href="impostazioni.html"><i class="fa-solid fa-gear" style="width:18px;margin-right:8px;"></i> Impostazioni</a>
    </div>

    <div class="menu-section">
      <div style="font-size:0.95rem;font-weight:700;margin-bottom:8px;">Supermercati</div>
      <div id="storesList">Caricamento‚Ä¶</div>
      <div style="margin-top:8px;">
        <button id="addStoreBtn" style="padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer;">Aggiungi supermercato</button>
      </div>
    </div>

    <div class="menu-section" style="margin-top:auto;">
      <div style="font-size:0.9rem;color:var(--gh-muted)">Versione app</div>
      <div style="font-weight:700">1.0.0</div>
      <div style="margin-top:8px;"><button id="menuClose" style="padding:8px 10px;border-radius:8px;border:none;background:var(--gh-terracotta);color:#fff;cursor:pointer;">Chiudi menu</button></div>
    </div>
  </nav>

  <!-- Main content -->
  <main class="dashboard add-expense" role="main" aria-live="polite" style="max-width:900px;margin:0 auto;padding:16px;padding-top:calc(88px + 12px);">
    <form id="expenseForm" class="expense-form" novalidate>
      <!-- SEZIONE 1: Informazioni Generali -->
      <section class="form-section">
        <h2>üè™ Informazioni Generali</h2>

        <div class="form-group">
          <label for="storeSelect">Supermercato:</label>
          <select id="storeSelect" class="store-select" required></select>
        </div>

        <div class="form-group" id="customStoreGroup" style="display:none;">
          <label for="customStore">Nome supermercato:</label>
          <input type="text" id="customStore" placeholder="Inserisci nome supermercato" />
        </div>

        <div class="form-group">
          <label for="expenseDate">Data:</label>
          <input type="date" id="expenseDate" required />
        </div>
      </section>

      <!-- SEZIONE 2: Aggiungi Prodotti -->
      <section class="form-section">
        <h2>üõí Aggiungi Prodotti</h2>

        <div class="product-form">
          <div class="form-row" style="display:flex;gap:12px;flex-wrap:wrap;">
            <div class="form-group" style="flex:1;min-width:160px;">
              <label for="productCategory">Tipologia:</label>
              <select id="productCategory" required>
                <option value="">Seleziona tipologia</option>
                <option value="Carne">ü•© Carne</option>
                <option value="Pesce">üêü Pesce</option>
                <option value="Verdura">ü•¨ Verdura</option>
                <option value="Frutta">üçé Frutta</option>
                <option value="Latticini">üßÄ Latticini</option>
                <option value="Pane">üçû Pane e Cereali</option>
                <option value="Bevande">ü•§ Bevande</option>
                <option value="Surgelati">üßä Surgelati</option>
                <option value="Dolci">üç∞ Dolci</option>
                <option value="Pulizia">üßΩ Prodotti Pulizia</option>
                <option value="Igiene">üß¥ Igiene Personale</option>
                <option value="Altro">üì¶ Altro</option>
              </select>
            </div>

            <div class="form-group suggestions" style="min-width:0;flex:2;">
              <label for="productName">Nome prodotto:</label>
              <input type="text" id="productName" placeholder="Es. Pomodori" autocomplete="off" required />
              <!-- container per suggerimenti -->
              <div id="suggestions" aria-hidden="true" class="suggestions-list" style="display:none;"></div>
            </div>
          </div>

          <div class="form-row" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;">
            <div class="form-group" style="flex:1;min-width:140px;">
              <label for="productPrice">Prezzo (‚Ç¨):</label>
              <input type="number" id="productPrice" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
              <div id="priceDiff" aria-live="polite" style="display:none;"></div>
            </div>

            <div class="form-group" style="flex:1;min-width:140px;">
              <label for="productPriceKg">Prezzo/kg (‚Ç¨):</label>
              <input type="number" id="productPriceKg" step="0.01" min="0" inputmode="decimal" placeholder="0.00" />
            </div>
          </div>

          <div class="form-group" style="margin-top:10px;">
            <label for="productNotes">Note:</label>
            <input type="text" id="productNotes" placeholder="Note aggiuntive (opzionale)" />
          </div>

          <div style="display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap;">
            <button type="button" id="scanBarcodeBtn" class="btn btn-secondary">üì∑ Scansiona codice a barre</button>
            <button type="button" id="addProductBtn" class="btn">‚ûï Aggiungi Prodotto al Carrello</button>
          </div>

        </div>
      </section>

      <!-- SEZIONE 3: Carrello (visibile solo quando ci sono prodotti) -->
      <section class="cart-section" id="cartSection" style="display:none;margin-top:18px;">
        <h2>üõí Carrello</h2>
        <div class="cart-table-container">
          <table id="cartTable" style="width:100%;border-collapse:collapse;">
            <thead>
              <tr><th style="text-align:left;padding:8px 0;">Prodotto</th><th style="text-align:right;padding:8px 0;">Prezzo</th><th style="text-align:center;padding:8px 0;">Azioni</th></tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>
        </div>
        <div class="cart-total" style="margin-top:12px;"><strong>Totale: <span id="cartTotal">‚Ç¨0.00</span></strong></div>
      </section>

      <!-- SEZIONE 4: Azioni finali -->
      <section class="form-actions" style="margin-top:18px;display:flex;gap:10px;">
        <button type="submit" id="saveExpenseBtn" class="btn" disabled>üíæ Salva Spesa Completa</button>
        <button type="button" id="clearCartBtn" class="btn btn-danger">üóëÔ∏è Svuota Carrello</button>
      </section>
    </form>
  </main>

  <!-- Scanner modal -->
  <div id="scannerModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-content" style="max-width:720px;margin:20px auto;padding:16px;border-radius:12px;background:#fff;">
      <h3>üì∑ Scansione Codice a Barre</h3>
      <p class="scanner-instructions">Inquadra il codice a barre con la fotocamera. L'app prover√† a recuperare i dati da Open Food Facts.</p>

      <div id="scannerContainer" aria-live="polite" style="position:relative;width:100%;height:320px;max-height:60vh;background:#000;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;">
        <video id="scannerVideo" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;display:block;"></video>
        <div id="scannerOverlay" aria-hidden="true" style="position:absolute;left:50%;top:50%;width:78%;height:120px;transform:translate(-50%, -50%);border-radius:10px;box-shadow:0 0 0 9999px rgba(0,0,0,0.45), inset 0 0 0 2px rgba(0,122,255,0.85);pointer-events:none;z-index:40;">
          <div class="scan-line" aria-hidden="true" style="position:absolute;left:0;top:0;width:100%;height:2px;background:linear-gradient(90deg, rgba(0,122,255,0) 0%, rgba(0,122,255,0.9) 50%, rgba(0,122,255,0) 100%);border-radius:1px;animation:scanMove 1.6s linear infinite;"></div>
        </div>
      </div>

      <a class="openfood-link" href="https://world.openfoodfacts.org" target="_blank" rel="noopener" style="display:block;margin-top:10px;color:var(--gh-salvia);font-weight:600;text-decoration:none;">üîé Cerca manualmente su Open Food Facts</a>

      <div class="scanner-actions" style="display:flex;gap:8px;margin-top:10px;justify-content:space-between;align-items:center;">
        <div class="left">
          <div id="deviceLabel" class="device-label" aria-live="polite"></div>
        </div>
        <div class="right">
          <button id="switchCameraBtn" class="btn btn-secondary small-btn">üîÅ Cambia Camera</button>
          <button id="scannerCancelBtn" class="btn btn-secondary">Annulla</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 12px;border-radius:10px;z-index:2100;font-size:0.95rem;display:none;"></div>

  <!-- app.js (la tua logica condivisa) -->
  <script src="app.js"></script>

  <!-- ZXing library (UMD build) -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>

  <!-- bottom navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a class="nav-item" href="index.html" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a class="nav-item nav-active" href="aggiungi.html" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a class="nav-item" href="archivio.html" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a class="nav-item" href="impostazioni.html" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <!-- sincronia bottom-nav active -->
  <script>
    (function () {
      const path = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.bottom-nav .nav-item').forEach(a => {
        const href = a.getAttribute('href') || '';
        a.classList.toggle('nav-active', href.endsWith(path));
      });
    })();
  </script>

  <!-- Script: menu handling + populate side menu stores -->
  <script>
    function populateSideMenuStores() {
      const container = document.getElementById('storesList');
      if (!container || !window.app) return;
      const stores = app.getStores ? app.getStores() : [];
      if (!stores || stores.length === 0) {
        container.innerHTML = '<div style="color:var(--gh-muted)">Nessun supermercato</div>';
        return;
      }
      container.innerHTML = '';
      stores.forEach(s => {
        const el = document.createElement('div');
        el.style.padding = '6px 0';
        el.textContent = s;
        container.appendChild(el);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuClose = document.getElementById('menuClose');

      menuToggle?.addEventListener('click', () => { sideMenu.style.display = 'block'; });
      menuClose?.addEventListener('click', () => { sideMenu.style.display = 'none'; });

      document.getElementById('addStoreBtn')?.addEventListener('click', () => {
        const name = prompt('Nome supermercato da aggiungere:');
        if (!name) return;
        const ok = app.addStore ? app.addStore(name) : false;
        if (ok) {
          populateSideMenuStores();
          alert('Supermercato aggiunto');
        } else {
          alert('Non √® stato possibile aggiungere (potrebbe gi√† esistere).');
        }
      });

      populateSideMenuStores();

      // Also refresh sideMenu store list if app changes stores elsewhere
      document.addEventListener('app:stores-changed', () => populateSideMenuStores());
    });
  </script>

  <!-- Tutto il JS di aggiungi (scanner, cart, autocomplete) - mantenuto identico e collocato qui -->
  <script>
    /* ---------- helper toast ---------- */
    function showToast(msg, duration = 1800) {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(t._timeout);
      t._timeout = setTimeout(() => { t.style.display = 'none'; }, duration);
    }

    /* ---------- Scanner state (invariate) ---------- */
    let codeReader = null;
    let availableVideoDevices = []; // [{deviceId,label},...]
    let currentDeviceIndex = -1;
    let isScannerOpen = false;
    let barcodeHandled = false;

    async function stopScanner() {
      if (codeReader) {
        try { await codeReader.reset(); } catch (e) { /* ignore */ }
        codeReader = null;
      }
      const video = document.getElementById('scannerVideo');
      if (video) {
        if (video.srcObject) {
          try {
            const tracks = video.srcObject.getTracks();
            tracks.forEach(t => t.stop());
          } catch (e) { /* ignore */ }
          video.srcObject = null;
        }
        try { video.pause(); } catch(e) {}
      }
      isScannerOpen = false;
      barcodeHandled = false;
      updateDeviceLabel('');
    }

    function updateDeviceLabel(text) {
      const lab = document.getElementById('deviceLabel');
      if (lab) lab.textContent = text || '';
    }

    // Try to enumerate and prefer back camera
    async function prepareDevicesAndChoosePreferred() {
      try {
        // small permission request so labels become available in some browsers
        const tmpStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
        tmpStream.getTracks().forEach(t => t.stop());
      } catch (e) {
        // continue
      }

      const devices = await navigator.mediaDevices.enumerateDevices();
      availableVideoDevices = devices.filter(d => d.kind === 'videoinput').map(d => ({ deviceId: d.deviceId, label: d.label || 'Camera' }));
      let idx = availableVideoDevices.findIndex(d => /back|rear|environment|posteriore/gi.test(d.label));
      if (idx === -1) idx = (availableVideoDevices.length > 0 ? 0 : -1);
      currentDeviceIndex = idx;
      return currentDeviceIndex;
    }

    async function openScannerModal() {
      const modal = document.getElementById('scannerModal');
      if (modal) { modal.style.display = 'block'; modal.setAttribute('aria-hidden','false'); }
      isScannerOpen = true;
      barcodeHandled = false;

      try {
        codeReader = new ZXingBrowser.BrowserMultiFormatReader();
      } catch (e) {
        if (window.ZXing && window.ZXing.BrowserMultiFormatReader) {
          codeReader = new window.ZXing.BrowserMultiFormatReader();
        } else {
          console.error('ZXing init error', e);
          alert('Errore inizializzazione scanner.');
          await closeScannerModal();
          return;
        }
      }

      try {
        const chosenIndex = await prepareDevicesAndChoosePreferred();
        if (chosenIndex === -1) {
          alert('Nessuna videocamera disponibile sul dispositivo.');
          await closeScannerModal();
          return;
        }
        const chosen = availableVideoDevices[chosenIndex];
        updateDeviceLabel('Camera: ' + (chosen.label || 'Sconosciuta'));

        const videoElem = document.getElementById('scannerVideo');
        await codeReader.decodeFromVideoDevice(chosen.deviceId, videoElem, (result, err) => {
          if (result) {
            const code = (result.getText ? result.getText() : (result.text || '')).trim();
            handleBarcodeFound(code);
          }
        });
      } catch (err) {
        console.error('Camera/Scanner error', err);
        alert('Impossibile avviare lo scanner. Controlla i permessi o riprova.');
        await closeScannerModal();
      }
    }

    async function closeScannerModal() {
      const modal = document.getElementById('scannerModal');
      try { await stopScanner(); } catch(e){}
      if (modal) { modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); }
    }

    async function switchCamera() {
      if (!isScannerOpen) return;
      if (!availableVideoDevices || availableVideoDevices.length <= 1) {
        showToast('Nessun altra camera disponibile', 1400);
        return;
      }
      try { await stopScanner(); } catch(e){}
      currentDeviceIndex = (currentDeviceIndex + 1) % availableVideoDevices.length;
      const chosen = availableVideoDevices[currentDeviceIndex];
      updateDeviceLabel('Camera: ' + (chosen.label || 'Sconosciuta'));
      try {
        codeReader = new ZXingBrowser.BrowserMultiFormatReader();
        const videoElem = document.getElementById('scannerVideo');
        await codeReader.decodeFromVideoDevice(chosen.deviceId, videoElem, (result, err) => {
          if (result) {
            const code = (result.getText ? result.getText() : (result.text || '')).trim();
            handleBarcodeFound(code);
          }
        });
      } catch (err) {
        console.error('Errore switching camera', err);
        showToast('Errore nel cambiare camera', 1600);
        await stopScanner();
      }
    }

    async function handleBarcodeFound(barcode) {
      if (!barcode || barcodeHandled) return;
      barcodeHandled = true;
      showToast('Codice rilevato: ' + barcode, 1500);

      try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(barcode)}.json`);
        if (!res.ok) throw new Error('Network response not ok');
        const json = await res.json();

        // reset any previous scanned image by default
        if (app && typeof app.setLastScannedImage === 'function') app.setLastScannedImage(null);
        if (app && typeof app.setLastScannedBarcode === 'function') app.setLastScannedBarcode(barcode);

        if (json && json.status === 1 && json.product) {
          const p = json.product;
          const nameField = document.getElementById('productName');
          const notesField = document.getElementById('productNotes');
          const categoryField = document.getElementById('productCategory');

          const prodName = p.product_name || p.generic_name || p.brands || '';
          if (nameField && prodName) nameField.value = prodName;

          let noteParts = [];
          if (p.brands) noteParts.push(p.brands);
          if (p.quantity) noteParts.push(p.quantity);
          if (p.categories) noteParts.push(p.categories.split(',').slice(0,2).join(' ‚Ä¢ '));
          if (notesField && noteParts.length) notesField.value = noteParts.join(' ‚Ä¢ ');

          if (categoryField && Array.isArray(p.categories_tags) && p.categories_tags.length) {
            const tag = p.categories_tags[0] || '';
            const human = (p.categories || '').split(',')[0] || tag.replace('en:', '').replace(/-/g,' ');
            const opts = Array.from(categoryField.options).map(o => o.value);
            const found = opts.find(o => human && o && o.toLowerCase().includes(human.toLowerCase()));
            if (found) categoryField.value = found;
          }

          // try to pick the best available image URL from OpenFoodFacts
          const imageCandidates = [
            p.image_front_small_url,
            p.image_front_thumb_url,
            p.image_small_url,
            p.image_url,
            p.image_front_url
          ].filter(Boolean);
          const chosenImage = imageCandidates.length ? imageCandidates[0] : null;
          if (chosenImage) {
            if (app && typeof app.setLastScannedImage === 'function') app.setLastScannedImage(chosenImage);
          } else {
            if (app && typeof app.setLastScannedImage === 'function') app.setLastScannedImage(null);
          }

          showToast('Dati trovati e compilati (verifica prima di aggiungere)', 2200);
        } else {
          if (app && typeof app.setLastScannedImage === 'function') app.setLastScannedImage(null);
          const manual = confirm('Prodotto non trovato in Open Food Facts. Vuoi cercarlo manualmente sul sito?');
          if (manual) {
            window.open('https://world.openfoodfacts.org', '_blank', 'noopener');
          }
        }
      } catch (err) {
        console.error('OpenFoodFacts fetch error', err);
        if (app && typeof app.setLastScannedImage === 'function') app.setLastScannedImage(null);
        alert('Errore nel recupero dei dati. Controlla la connessione o inserisci manualmente.');
      } finally {
        setTimeout(async () => {
          await closeScannerModal();
          barcodeHandled = false;
        }, 800);
      }
    }

    async function manualBarcodePrompt() {
      const code = prompt('Inserisci manualmente il codice a barre (EAN/UPC):');
      if (!code) return;
      barcodeHandled = false;
      handleBarcodeFound(code);
    }

    /* ---------- Page logic (carrello, autocomplete, eventi) ---------- */

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function toggleCustomStore() {
      const storeSelect = document.getElementById('storeSelect');
      const customGroup = document.getElementById('customStoreGroup');
      const customInput = document.getElementById('customStore');
      if (!storeSelect) return;
      if (storeSelect.value === 'Altro') {
        customGroup.style.display = 'block';
        if (customInput) customInput.required = true;
      } else {
        customGroup.style.display = 'none';
        if (customInput) customInput.required = false;
      }
    }

    /* ---------- Product reference helpers (fallback if app.js not updated) ---------- */
    function loadLocalProductsReference() {
      try {
        const raw = localStorage.getItem('productsReference');
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        return {};
      }
    }

    function getReferenceByName(name) {
      if (!name) return null;
      // prefer app API if exists
      try {
        if (window.app && typeof app.getProductReference === 'function') {
          return app.getProductReference(name);
        }
      } catch (e) { /* ignore */ }
      const all = loadLocalProductsReference();
      return all[name.trim().toLowerCase()] || null;
    }

    function compareWithReferenceLocal(product) {
      if (!product || !product.name) return null;
      try {
        if (window.app && typeof app.compareWithReference === 'function') {
          return app.compareWithReference(product);
        }
      } catch (e) {}
      const ref = getReferenceByName(product.name);
      if (!ref || !ref.minPrice) return null;
      const current = parseFloat(product.price) || 0;
      if (!current) return null;
      const diff = ((current - ref.minPrice) / ref.minPrice) * 100;
      return { reference: ref.minPrice, difference: diff };
    }

    /* ---------- AUTOCOMPLETE / SUGGESTIONS ---------- */
    let suggestionDebounce;
    function getSuggestions(prefix, limit=8) {
      if (!prefix || !prefix.trim()) return [];
      const p = prefix.trim().toLowerCase();
      // prefer app data
      try {
        if (window.app && app.productsReference && typeof app.productsReference === 'object') {
          const keys = Object.keys(app.productsReference || {});
          return keys.filter(k => k.includes(p)).slice(0, limit);
        }
      } catch (e) {}
      // fallback to localStorage
      const all = loadLocalProductsReference();
      return Object.keys(all).filter(k => k.includes(p)).slice(0, limit);
    }

    function showSuggestions(list) {
      const box = document.getElementById('suggestions');
      if (!box) return;
      if (!list || !list.length) { box.style.display = 'none'; box.innerHTML = ''; box.setAttribute('aria-hidden','true'); return; }
      box.innerHTML = '';
      list.forEach(nameKey => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.tabIndex = 0;
        item.textContent = nameKey;
        item.addEventListener('click', () => applySuggestion(nameKey));
        item.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') applySuggestion(nameKey); });
        box.appendChild(item);
      });
      box.style.display = 'block';
      box.setAttribute('aria-hidden','false');
    }

    function applySuggestion(nameKey) {
      const nameField = document.getElementById('productName');
      if (!nameField) return;
      nameField.value = nameKey;
      // fill price with reference.minPrice if present
      const ref = getReferenceByName(nameKey);
      if (ref && ref.minPrice) {
        const priceField = document.getElementById('productPrice');
        if (priceField) priceField.value = Number(ref.minPrice).toFixed(2);
        // show price diff (0% because filled with reference)
        showPriceDiff(ref.minPrice, ref.minPrice);
      }
      // hide suggestions
      showSuggestions([]);
      nameField.focus();
    }

    function hideSuggestions() { showSuggestions([]); }

    /* ---------- price diff UI ---------- */
    function showPriceDiff(enteredPrice, referencePrice) {
      const el = document.getElementById('priceDiff');
      if (!el) return;
      if (!referencePrice || !enteredPrice) { el.style.display='none'; el.innerHTML=''; return; }
      const p = parseFloat(enteredPrice);
      const r = parseFloat(referencePrice);
      if (!p || !r) { el.style.display='none'; el.innerHTML=''; return; }
      const diff = ((p - r) / r) * 100;
      const abs = Math.abs(diff);
      if (diff === 0) {
        el.innerHTML = `<span style="color:var(--gh-muted)">Prezzo pari al riferimento: <strong>‚Ç¨${Number(r).toFixed(2)}</strong></span>`;
        el.style.display = 'block';
        return;
      }
      if (diff > 0) {
        el.innerHTML = `Prezzo rispetto al minimo registrato: <span class="up">+${abs.toFixed(1)}%</span> (rif. ‚Ç¨${Number(r).toFixed(2)})`;
      } else {
        el.innerHTML = `Prezzo rispetto al minimo registrato: <span class="down">${(abs).toFixed(1)}% in meno</span> (rif. ‚Ç¨${Number(r).toFixed(2)})`;
      }
      el.style.display = 'block';
    }

    function clearPriceDiff() {
      const el = document.getElementById('priceDiff');
      if (!el) return;
      el.style.display = 'none';
      el.innerHTML = '';
    }

    /* ---------- Aggiorna carrello: esteso per mostrare differenza ---------- */
    function updateCartDisplay() {
      const cartSection = document.getElementById('cartSection');
      const cartBody = document.getElementById('cartBody');
      const cartTotal = document.getElementById('cartTotal');
      const saveBtn = document.getElementById('saveExpenseBtn');
      if (!cartSection || !cartBody || !cartTotal || !saveBtn) return;

      const cart = app.currentCart || [];

      if (!cart || cart.length === 0) {
        cartSection.style.display = 'none';
        saveBtn.disabled = true;
        cartBody.innerHTML = '';
        cartTotal.textContent = (app && typeof app.formatCurrency === 'function') ? app.formatCurrency(0) : `‚Ç¨0.00`;
        return;
      }

      cartSection.style.display = 'block';
      saveBtn.disabled = false;

      cartBody.innerHTML = cart.map(p => {
        // image html (only if p.image present)
        const imgHtml = p.image ? `<img class="cart-img" src="${escapeHtml(p.image)}" alt="${escapeHtml(p.name)}" />` : '';
        const detailsHtml = `
          <div class="cart-item" style="display:flex;align-items:center;gap:12px;">
            ${imgHtml}
            <div class="cart-item-details" style="display:flex;flex-direction:column;gap:4px;min-width:0;">
              <div class="name" style="font-weight:700;color:var(--gh-text-strong);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(p.name)}</div>
              <div class="meta" style="color:var(--gh-muted);font-size:0.88rem;">${escapeHtml(p.category || '')}${p.notes ? ' ‚Ä¢ ' + escapeHtml(p.notes) : ''}</div>
            </div>
          </div>
        `;
        // price diff display (use _priceComparison if present or compute)
        let diffHtml = '';
        const comp = p._priceComparison || compareWithReferenceLocal(p);
        if (comp && typeof comp.reference !== 'undefined' && typeof comp.difference !== 'undefined') {
          const d = comp.difference;
          const abs = Math.abs(d);
          if (d === 0) {
            diffHtml = `<div style="font-size:0.86rem;color:var(--gh-muted)">rif. ${ (app && app.formatCurrency) ? app.formatCurrency(comp.reference) : '‚Ç¨' + comp.reference.toFixed(2)}</div>`;
          } else if (d > 0) {
            diffHtml = `<div style="font-size:0.86rem;color:#ffb4b0">+${abs.toFixed(1)}% vs min (rif. ${(app && app.formatCurrency) ? app.formatCurrency(comp.reference) : '‚Ç¨'+comp.reference.toFixed(2)})</div>`;
          } else {
            diffHtml = `<div style="font-size:0.86rem;color:#c8f7d4">${abs.toFixed(1)}% in meno vs min (rif. ${(app && app.formatCurrency) ? app.formatCurrency(comp.reference) : '‚Ç¨'+comp.reference.toFixed(2)})</div>`;
          }
        }

        const priceHtml = `<div style="display:flex;flex-direction:column;align-items:flex-end;"><strong>${(app && app.formatCurrency) ? app.formatCurrency(p.price) : '‚Ç¨' + Number(p.price).toFixed(2)}</strong>${diffHtml}</div>`;

        return `
          <tr>
            <td style="min-width:0; width:60%;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.04);">${detailsHtml}</td>
            <td style="white-space:nowrap;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.04);">${priceHtml}</td>
            <td style="white-space:nowrap;padding:10px 0;border-bottom:1px solid rgba(0,0,0,0.04);text-align:center;">
              <button type="button" class="remove-btn" onclick="removeFromCart('${p.id}')">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join('');

      const total = app.getCartTotal ? app.getCartTotal() : (cart.reduce((s, it) => s + (parseFloat(it.price) || 0), 0));
      cartTotal.textContent = (app && typeof app.formatCurrency === 'function') ? app.formatCurrency(total) : `‚Ç¨${Number(total).toFixed(2)}`;
    }

    /* ---------- add product flow (modificato per allegare _priceComparison) ---------- */
    function addProductToCartLocal() {
      const categoryEl = document.getElementById('productCategory');
      const nameEl = document.getElementById('productName');
      const priceEl = document.getElementById('productPrice');
      const priceKgEl = document.getElementById('productPriceKg');
      const notesEl = document.getElementById('productNotes');

      if (!categoryEl || !nameEl || !priceEl) return;

      const category = categoryEl.value.trim();
      const name = nameEl.value.trim();
      const priceRaw = priceEl.value.trim();
      const price = parseFloat(priceRaw);
      const priceKg = priceKgEl && priceKgEl.value ? parseFloat(priceKgEl.value) : null;
      const notes = notesEl && notesEl.value ? notesEl.value.trim() : '';

      if (!category || !name || !priceRaw || isNaN(price) || price <= 0) {
        alert('Compila tutti i campi prodotto correttamente.');
        return;
      }

      // se lo scanner ha fornito un'immagine, la usiamo e poi la resettiamo
      const scannedImage = (typeof app.getLastScannedImage === 'function') ? app.getLastScannedImage() : null;
      const scannedBarcode = (typeof app.getLastScannedBarcode === 'function') ? app.getLastScannedBarcode() : null;

      const product = {
        id: app.generateId ? app.generateId() : ('p_'+Date.now()),
        category,
        name,
        price,
        priceKg,
        notes
      };

      if (scannedImage) {
        product.image = scannedImage;
        if (scannedBarcode) product.barcode = scannedBarcode;
      }

      // compute comparison now (and attach) using app or local fallback
      const comparison = compareWithReferenceLocal(product);
      if (comparison) {
        product._priceComparison = comparison;
      }

      // usa l'API dell'app (dispatta event + mantiene stato)
      if (app && typeof app.addProductToCart === 'function') {
        app.addProductToCart(product);
      } else {
        // fallback: maintain local cart
        if (!app.currentCart) app.currentCart = [];
        app.currentCart.push(product);
        document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: app.currentCart }));
      }

      // pulisci last-scanned per evitare riutili
      try { if (app && typeof app.setLastScannedImage === 'function') app.setLastScannedImage(null); if (app && typeof app.setLastScannedBarcode === 'function') app.setLastScannedBarcode(null); } catch(e){}

      updateCartDisplay();
      clearProductForm();
      nameEl.focus();

      const addBtn = document.getElementById('addProductBtn');
      if (addBtn) { addBtn.classList.add('pulse'); setTimeout(()=>addBtn.classList.remove('pulse'), 260); }
    }

    function clearProductForm() {
      ['productCategory','productName','productPrice','productPriceKg','productNotes'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      clearPriceDiff();
      hideSuggestions();
    }

    function removeFromCart(id) {
      if (app.removeProductFromCart) {
        app.removeProductFromCart(id);
      } else {
        app.currentCart = (app.currentCart || []).filter(p => p.id !== id);
        document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: app.currentCart }));
      }
      updateCartDisplay();
    }

    function clearCart() {
      if (!app.currentCart || app.currentCart.length === 0) return;
      if (!confirm('Svuotare il carrello?')) return;
      if (app.clearCart) {
        app.clearCart();
      } else {
        app.currentCart = [];
        document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: app.currentCart }));
      }
      updateCartDisplay();
    }

    function saveExpense() {
      const storeSelect = document.getElementById('storeSelect');
      const customStore = document.getElementById('customStore');
      const dateEl = document.getElementById('expenseDate');
      if (!storeSelect || !dateEl) return;

      const store = (storeSelect.value === 'Altro') ? (customStore ? customStore.value.trim() : '') : storeSelect.value;
      const date = dateEl.value;
      if (!store) { alert('Seleziona o inserisci un supermercato.'); return; }
      if (!date) { alert('Inserisci la data.'); return; }
      if (!app.currentCart || app.currentCart.length === 0) { alert('Aggiungi almeno un prodotto.'); return; }

      const today = new Date().toISOString().split('T')[0];
      if (date > today) { alert('La data non pu√≤ essere futura'); return; }

      try {
        // usa la API dell'app
        if (app.saveCartAsExpense) {
          app.saveCartAsExpense(store, date);
        } else if (app.addExpense) {
          app.addExpense(store, date, app.currentCart);
          // fallback: attempt update local productsReference if present
          try {
            const pr = loadLocalProductsReference();
            (app.currentCart||[]).forEach(p => {
              const key = (p.name || '').trim().toLowerCase();
              const price = parseFloat(p.price) || 0;
              if (!key || !price) return;
              if (!pr[key] || price < pr[key].minPrice) pr[key] = { minPrice: price };
            });
            localStorage.setItem('productsReference', JSON.stringify(pr));
          } catch (e) {}
        }

        try {
          const inList = app.getStores().some(s => s.toLowerCase() === store.toLowerCase());
          if (!inList && store !== 'Altro') app.addStore(store);
        } catch(e) { /* ignore */ }

        alert('Spesa salvata con successo');
        document.getElementById('expenseForm').reset();
        if (app.clearCart) app.clearCart(); else app.currentCart = [];
        updateCartDisplay();
        toggleCustomStore();
        dateEl.value = today;
      } catch (e) {
        console.error(e);
        alert('Errore salvataggio spesa');
      }
    }

    /* ---------- Wiring events on DOMContentLoaded ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      // populate selects from app
      try { app.populateAllStoreSelects(); } catch(e) {}

      // set default date
      const dateEl = document.getElementById('expenseDate');
      if (dateEl) dateEl.value = new Date().toISOString().split('T')[0];

      // wire UI
      document.getElementById('storeSelect')?.addEventListener('change', toggleCustomStore);
      document.getElementById('addProductBtn')?.addEventListener('click', e => { e.preventDefault(); addProductToCartLocal(); });
      document.getElementById('clearCartBtn')?.addEventListener('click', e => { e.preventDefault(); clearCart(); });
      document.getElementById('saveExpenseBtn')?.addEventListener('click', e => { e.preventDefault(); saveExpense(); });
      document.getElementById('expenseForm')?.addEventListener('submit', e => { e.preventDefault(); saveExpense(); });

      document.getElementById('scanBarcodeBtn')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await openScannerModal();
        } catch (err) {
          console.warn('Scanner open failed', err);
          if (confirm('Impossibile aprire la fotocamera. Vuoi inserire manualmente il codice a barre?')) {
            manualBarcodePrompt();
          }
        }
      });

      document.getElementById('scannerCancelBtn')?.addEventListener('click', () => { closeScannerModal(); });
      document.getElementById('switchCameraBtn')?.addEventListener('click', async () => { await switchCamera(); });

      // attach events for productName autocomplete
      const nameField = document.getElementById('productName');
      const suggestBox = document.getElementById('suggestions');
      nameField?.addEventListener('input', (e) => {
        clearTimeout(suggestionDebounce);
        suggestionDebounce = setTimeout(() => {
          const q = (nameField.value || '').trim();
          if (!q) { hideSuggestions(); return; }
          const list = getSuggestions(q);
          showSuggestions(list);
        }, 180);
      });
      // hide suggestions on blur (small delay to allow click)
      nameField?.addEventListener('blur', () => setTimeout(hideSuggestions, 180));

      // price field: on input show diff if ref exists
      const priceField = document.getElementById('productPrice');
      priceField?.addEventListener('input', () => {
        const name = (nameField.value || '').trim();
        const entered = parseFloat(priceField.value);
        const refObj = getReferenceByName(name);
        if (refObj && refObj.minPrice && entered) {
          showPriceDiff(entered, refObj.minPrice);
        } else {
          clearPriceDiff();
        }
      });

      // init cart state (sync con app)
      app.currentCart = app.currentCart || [];
      updateCartDisplay();
      toggleCustomStore();

      // ascolta cambi carte dall'API in caso qualcuno modifichi
      document.addEventListener('app:cart-changed', (e) => {
        updateCartDisplay();
      });

      // Ensure main has enough bottom padding for the bottom nav (JS fallback in case env() is not supported)
      const bottomNav = document.querySelector('.bottom-nav');
      const main = document.querySelector('main');
      if (bottomNav && main) {
        const navH = bottomNav.offsetHeight || 0;
        const extra = 24;
        main.style.paddingBottom = (navH + extra) + 'px';
        document.body.style.paddingBottom = (navH + extra) + 'px';
      }
    });

    // Clean up scanner if user navigates away
    window.addEventListener('pagehide', () => {
      try { stopScanner(); } catch (e) {}
    });
  </script>

  <style>
    /* quick local scan animation keyframes (used by overlay) */
    @keyframes scanMove { 0%{transform:translateY(-4px);opacity:0;}10%{opacity:1;}50%{transform:translateY(calc(100% - 2px));opacity:1;}90%{opacity:1;}100%{transform:translateY(-4px);opacity:0;} }
  </style>
</body>
</html>