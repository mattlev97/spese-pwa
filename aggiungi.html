<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggiungi Spesa</title>

  <!-- Manifest / PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#1e1e1e" />

  <!-- Font Awesome (icone) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="" crossorigin="anonymous">

  <!-- Stili -->
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Piccoli aggiustamenti locali per il modal scanner */
    .scanner-instructions { color: var(--text-secondary); margin-bottom:8px; font-size:0.95rem; }
    #scannerContainer { position: relative; width: 100%; height: 320px; max-height: 60vh; background: #000; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    #scannerVideo { width: 100%; height: 100%; object-fit: cover; background: #000; display: block; }
    #scannerOverlay {
      position: absolute; left: 50%; top: 50%; width: 78%; height: 120px; transform: translate(-50%, -50%);
      border-radius: 10px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.45), inset 0 0 0 2px rgba(0,122,255,0.85);
      pointer-events: none; z-index: 40;
    }
    #scannerOverlay .scan-line { position: absolute; left: 0; top: 0; width: 100%; height: 2px; background: linear-gradient(90deg, rgba(0,122,255,0) 0%, rgba(0,122,255,0.9) 50%, rgba(0,122,255,0) 100%); animation: scanMove 1.6s linear infinite; border-radius: 1px; }
    @keyframes scanMove { 0%{transform:translateY(-4px);opacity:0;}10%{opacity:1;}50%{transform:translateY(calc(100% - 2px));opacity:1;}90%{opacity:1;}100%{transform:translateY(-4px);opacity:0;} }
    .scanner-actions { display:flex; gap:8px; margin-top:10px; justify-content: space-between; align-items:center; }
    .scanner-actions .left { display:flex; gap:8px; align-items:center; }
    .scanner-actions .right { display:flex; gap:8px; align-items:center; }
    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 28px; background: rgba(0,0,0,0.7); color: #fff; padding: 8px 12px; border-radius: 10px; z-index: 2100; font-size: 0.95rem; display:none; }
    .device-label { font-size: 0.85rem; color: var(--text-secondary); }
    .small-btn { padding:8px 10px; border-radius:8px; font-size:0.9rem; }
    .openfood-link { display:block; margin-top:10px; color: var(--accent); text-decoration: none; font-weight:600; }
    .openfood-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ›ï¸ Aggiungi Spesa</h1>
    <nav class="top-nav" role="navigation" aria-label="Menu principale">
      <a href="index.html">Dashboard</a>
      <a href="aggiungi.html" class="nav-active">Aggiungi</a>
      <a href="archivio.html">Archivio</a>
      <a href="impostazioni.html">Impostazioni</a>
    </nav>
  </header>

  <main class="add-expense">
    <form id="expenseForm" class="expense-form" novalidate>
      <!-- SEZIONE 1: Informazioni Generali -->
      <section class="form-section">
        <h2>ğŸª Informazioni Generali</h2>

        <div class="form-group">
          <label for="storeSelect">Supermercato:</label>
          <select id="storeSelect" class="store-select" required></select>
        </div>

        <div class="form-group" id="customStoreGroup" style="display:none;">
          <label for="customStore">Nome supermercato:</label>
          <input type="text" id="customStore" placeholder="Inserisci nome supermercato" />
        </div>

        <div class="form-group">
          <label for="expenseDate">Data:</label>
          <input type="date" id="expenseDate" required />
        </div>
      </section>

      <!-- SEZIONE 2: Aggiungi Prodotti -->
      <section class="form-section">
        <h2>ğŸ›’ Aggiungi Prodotti</h2>

        <div class="product-form">
          <div class="form-row">
            <div class="form-group">
              <label for="productCategory">Tipologia:</label>
              <select id="productCategory" required>
                <option value="">Seleziona tipologia</option>
                <option value="Carne">ğŸ¥© Carne</option>
                <option value="Pesce">ğŸŸ Pesce</option>
                <option value="Verdura">ğŸ¥¬ Verdura</option>
                <option value="Frutta">ğŸ Frutta</option>
                <option value="Latticini">ğŸ§€ Latticini</option>
                <option value="Pane">ğŸ Pane e Cereali</option>
                <option value="Bevande">ğŸ¥¤ Bevande</option>
                <option value="Surgelati">ğŸ§Š Surgelati</option>
                <option value="Dolci">ğŸ° Dolci</option>
                <option value="Pulizia">ğŸ§½ Prodotti Pulizia</option>
                <option value="Igiene">ğŸ§´ Igiene Personale</option>
                <option value="Altro">ğŸ“¦ Altro</option>
              </select>
            </div>

            <div class="form-group">
              <label for="productName">Nome prodotto:</label>
              <input type="text" id="productName" placeholder="Es. Pomodori" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="productPrice">Prezzo (â‚¬):</label>
              <input type="number" id="productPrice" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
            </div>

            <div class="form-group">
              <label for="productPriceKg">Prezzo/kg (â‚¬):</label>
              <input type="number" id="productPriceKg" step="0.01" min="0" inputmode="decimal" placeholder="0.00" />
            </div>
          </div>

          <div class="form-group">
            <label for="productNotes">Note:</label>
            <input type="text" id="productNotes" placeholder="Note aggiuntive (opzionale)" />
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" id="scanBarcodeBtn" class="btn btn-secondary">ğŸ“· Scansiona codice a barre</button>
            <button type="button" id="addProductBtn" class="btn">â• Aggiungi Prodotto al Carrello</button>
          </div>

        </div>
      </section>

      <!-- SEZIONE 3: Carrello (visibile solo quando ci sono prodotti) -->
      <section class="cart-section" id="cartSection" style="display:none;">
        <h2>ğŸ›’ Carrello</h2>
        <div class="cart-table-container">
          <table id="cartTable">
            <thead>
              <tr><th>Prodotto</th><th>Prezzo</th><th>Azioni</th></tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>
        </div>
        <div class="cart-total"><strong>Totale: <span id="cartTotal">â‚¬0.00</span></strong></div>
      </section>

      <!-- SEZIONE 4: Azioni finali -->
      <section class="form-actions">
        <button type="submit" id="saveExpenseBtn" class="btn" disabled>ğŸ’¾ Salva Spesa Completa</button>
        <button type="button" id="clearCartBtn" class="btn btn-danger">ğŸ—‘ï¸ Svuota Carrello</button>
      </section>
    </form>
  </main>

  <!-- Scanner modal -->
  <div id="scannerModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>ğŸ“· Scansione Codice a Barre</h3>
      <p class="scanner-instructions">Inquadra il codice a barre con la fotocamera. L'app proverÃ  a recuperare i dati da Open Food Facts.</p>

      <div id="scannerContainer" aria-live="polite">
        <video id="scannerVideo" autoplay playsinline muted></video>
        <div id="scannerOverlay" aria-hidden="true">
          <div class="scan-line" aria-hidden="true"></div>
        </div>
      </div>

      <a class="openfood-link" href="https://world.openfoodfacts.org" target="_blank" rel="noopener">ğŸ” Cerca manualmente su Open Food Facts</a>

      <div class="scanner-actions">
        <div class="left">
          <div id="deviceLabel" class="device-label" aria-live="polite"></div>
        </div>
        <div class="right">
          <button id="switchCameraBtn" class="btn btn-secondary small-btn">ğŸ” Cambia Camera</button>
          <button id="scannerCancelBtn" class="btn btn-secondary">Annulla</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- app.js (la tua logica condivisa) -->
  <script src="app.js"></script>

  <!-- ZXing library (UMD build) -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>

  <!-- bottom navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a class="nav-item" href="index.html" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a class="nav-item nav-active" href="aggiungi.html" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a class="nav-item" href="archivio.html" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a class="nav-item" href="impostazioni.html" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <script>
    // Sincronizza lo stato "active" nella bottom-nav con la pagina corrente
    (function () {
      const path = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.bottom-nav .nav-item').forEach(a => {
        const href = a.getAttribute('href') || '';
        if (href.endsWith(path)) {
          a.classList.add('nav-active');
        } else {
          a.classList.remove('nav-active');
        }
      });
    })();
  </script>

  <!-- scanner + form script rimangono quelli che hai giÃ  (inclusi nel file sopra) -->
  <script>
    /* Scanner and page code (identico a quello che hai giÃ  fornito).
       Note: per brevitÃ  qui non ripeto nuovamente l'intero script visto che
       lo includi con app.js e gli script inline precedenti nella tua versione.
       Mantieni il codice scanner che mi hai fornito. */
  </script>
</body>
</html>