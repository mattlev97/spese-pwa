<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggiungi Spesa ‚Äî GroceryHub</title>

  <!-- Manifest / PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#ffffff" />

  <!-- Font Awesome (icone) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">

  <!-- Stili unificati -->
  <link rel="stylesheet" href="style.css?v=20250816" />

  <!-- Stili specifici per aggiungi.html -->
  <style>
    /* essentials */
    .store-list-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:10px; margin-top:12px; }
    .store-card { display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--panel); cursor:pointer; transition:transform .12s ease,box-shadow .14s ease; }
    .store-card.selected { background:var(--gh-salvia); color:#fff; box-shadow:0 12px 38px rgba(122,169,134,0.14); }
    .store-card .store-logo { width:64px; height:64px; object-fit:contain; border-radius:8px; flex:0 0 64px; }
    .store-card .store-card-body { flex:1; min-width:0; }
    .store-card .store-card-title { font-weight:700; }
    .store-card .store-card-desc { color:var(--gh-muted); font-size:0.92rem; margin-top:4px; }

    #cartMainPlaceholder { display:none; gap:12px; align-items:center; padding:18px; border-radius:12px; border:1px solid var(--border); background:var(--panel); box-shadow:0 12px 28px rgba(0,0,0,0.04); margin-bottom:16px; }
    .cart-icon-circle { width:56px; height:56px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:var(--gh-salvia); color:#fff; flex:0 0 56px; }

    .add-product-drawer { position:fixed !important; left:50% !important; transform:translateX(-50%) !important; bottom:16px !important; width:calc(100% - 32px) !important; max-width:720px !important; border-top-left-radius:12px !important; border-top-right-radius:12px !important; padding:12px !important; max-height:78vh !important; overflow:auto !important; z-index:3600 !important; background:var(--panel); }
    .add-product-drawer .drawer-header { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:6px 6px 12px 6px; }
    .menu-overlay.visible { display:block; opacity:1; }

    /* cart table tweaks */
    #cartTable td, #cartTable th { padding:10px 8px; vertical-align:middle; }
    .cart-product-name { font-weight:600; }
    .cart-product-meta { color:var(--gh-muted); font-size:0.9rem; }
    .cart-remove-btn { background:transparent; border:none; color:var(--gh-terracotta); cursor:pointer; font-size:1rem; padding:6px; }
    .cart-edit-btn { background:transparent; border:none; color:var(--gh-text-strong); cursor:pointer; font-size:1rem; padding:6px; margin-right:6px; }

    /* thumbnail placeholder using fontawesome inside circle */
    .cart-thumb-placeholder {
      width:48px; height:48px; border-radius:6px; display:flex; align-items:center; justify-content:center; flex:0 0 48px;
      background:var(--gh-salvia); color:#fff; font-size:18px; box-shadow:0 1px 0 rgba(0,0,0,0.04); margin-right:10px;
    }
    .cart-thumb { width:48px; height:48px; object-fit:cover; border-radius:6px; border:1px solid rgba(0,0,0,0.04); margin-right:10px; flex:0 0 48px; }

    /* drawer preview container (can contain img or placeholder) */
    #drawerImagePreview { display:none; margin-bottom:8px; }
    #drawerImagePreview .preview-img { width:64px; height:64px; object-fit:cover; border-radius:8px; border:1px solid rgba(0,0,0,0.06); }
    #drawerImagePreview .preview-placeholder { width:64px; height:64px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:var(--gh-salvia); color:#fff; font-size:20px; }

    /* store header card (white) */
    #storeHeaderCard { display:none; padding:12px; border-radius:10px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.04); margin-bottom:12px; align-items:center; gap:12px; }
    #storeHeaderCard .store-logo-large { width:72px; height:72px; object-fit:contain; border-radius:10px; flex:0 0 72px; background:transparent; }
    #storeHeaderCard .store-header-body { flex:1; }
    #storeHeaderCard .store-header-title { font-weight:800; margin-bottom:4px; }
    #storeHeaderCard .store-header-desc { color:var(--gh-muted); font-size:0.95rem; }

    /* small responsive tweaks */
    @media (max-width:520px) {
      #storeHeaderCard { flex-direction:column; align-items:flex-start; }
      #storeHeaderCard .store-logo-large { margin-bottom:8px; }
    }

    /* toast */
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:84px; background:rgba(0,0,0,0.8); color:#fff; padding:10px 14px; border-radius:8px; display:none; z-index:9999; }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="hamburger" id="menuToggle" aria-label="Apri menu" title="Apri menu">
      <i class="fa-solid fa-bars"></i>
    </div>

    <div class="title-wrap" role="banner">
      <div class="title-row" aria-hidden="true">
        <h1 class="groceryhub">Grocery<span class="hub">Hub</span></h1>
      </div>
      <div class="payoff">Controlla, risparmia, vivi meglio</div>
    </div>
  </header>

  <!-- Side menu -->
  <nav id="sideMenu" class="hidden" aria-hidden="true"> ... </nav>

  <!-- overlay -->
  <div id="menuOverlay" class="menu-overlay" tabindex="-1" aria-hidden="true"></div>

  <main class="dashboard add-expense" role="main" aria-live="polite" style="padding:18px;">
    <!-- STORE CHOICE CARD -->
    <section id="storeChoiceCard" class="panel store-choice-card" aria-labelledby="storeChoiceTitle">
      <div class="section-header">
        <span class="icon-circle" aria-hidden="true"><i class="fa-solid fa-store"></i></span>
        <div class="title-lines">
          <h2 id="storeChoiceTitle">Aggiungi nuova spesa</h2>
          <div class="subtitle">Scegli il supermercato per iniziare</div>
        </div>
      </div>

      <div id="storeListGrid" class="store-list-grid" role="list" aria-label="Elenco supermercati"></div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
        <button id="confirmStoreBtn" class="btn" disabled aria-disabled="true">‚úîÔ∏è Conferma</button>
      </div>
    </section>

    <!-- Store header card (after confirm) -->
    <section id="storeHeaderCard" class="panel" aria-hidden="true" style="display:none; margin-top:12px; display:flex;">
      <img id="selectedStoreLogo" class="store-logo-large" src="" alt="Logo supermercato" />
      <div class="store-header-body">
        <div class="store-header-title" id="selectedStoreTitle"></div>
        <div class="store-header-desc" id="selectedStoreDesc"></div>
        <div style="margin-top:8px;">
          <label style="font-size:0.9rem;color:var(--gh-muted);margin-bottom:4px;display:block;">Data spesa</label>
          <input type="date" id="expenseDateHeader" />
        </div>
      </div>
    </section>

    <!-- After confirm: empty cart placeholder -->
    <section id="cartMainPlaceholder" aria-hidden="true">
      <div class="title-row">
        <div class="cart-icon-circle" aria-hidden="true"><i class="fa-solid fa-cart-shopping" style="font-size:20px"></i></div>
        <div>
          <div style="font-weight:700;font-size:1.06rem;">Il tuo carrello</div>
          <div class="cart-empty-note"><em>Nessun prodotto nel carrello</em></div>
        </div>
      </div>
    </section>

    <!-- Hidden original form and cart (cartSection shown when items exist) -->
    <form id="expenseForm" class="expense-form hidden" novalidate>
      <section id="cartSection" class="cart-section panel hidden" aria-hidden="true" style="margin-top:12px;">
        <div class="section-header">
          <div class="title-lines">
            <h2>Carrello</h2>
            <div class="subtitle">Riepilogo dei prodotti</div>
          </div>
        </div>

        <div class="cart-table-container">
          <table id="cartTable" style="width:100%;">
            <thead>
              <tr><th style="text-align:left">Prodotto</th><th style="width:120px">Prezzo</th><th style="width:110px">Azioni</th></tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>
        </div>
        <div class="cart-total" style="margin-top:8px;"><strong>Totale: <span id="cartTotal">‚Ç¨0.00</span></strong></div>
      </section>

      <section class="form-actions" style="margin-top:12px;display:flex;gap:10px;">
        <button type="submit" id="saveExpenseBtn" class="btn" disabled>üíæ Salva Spesa Completa</button>
        <button type="button" id="clearCartBtn" class="btn btn-danger">üóëÔ∏è Svuota Carrello</button>
      </section>
    </form>
  </main>

  <!-- Drawer: add/edit product (bottom sheet) -->
  <div id="drawerOverlay" class="menu-overlay" aria-hidden="true"></div>
  <div id="addProductDrawer" class="add-product-drawer hidden" role="dialog" aria-hidden="true" aria-labelledby="drawerTitle">
    <div class="drawer-header">
      <div id="drawerTitle" style="font-weight:700;font-size:1rem;">Aggiungi prodotto</div>
      <button id="closeDrawerBtn" class="btn btn-secondary" aria-label="Chiudi">Chiudi</button>
    </div>
    <div class="drawer-body">
      <!-- preview can contain img or placeholder -->
      <div id="drawerImagePreview" aria-hidden="true">
        <div id="drawerPreviewContainer"></div>
      </div>

      <div class="form-group">
        <label for="drawerProductName">Nome prodotto</label>
        <input id="drawerProductName" type="text" />
      </div>
      <div class="form-group">
        <label for="drawerProductCategory">Categoria</label>
        <select id="drawerProductCategory">
          <option value="">Seleziona tipologia</option>
          <option>Carne</option><option>Pesce</option><option>Verdura</option><option>Frutta</option>
          <option>Latticini</option><option>Pane</option><option>Bevande</option><option>Altro</option>
        </select>
      </div>
      <div class="form-row" style="display:flex;gap:10px;">
        <div class="form-group" style="flex:1">
          <label for="drawerProductPrice">Prezzo (‚Ç¨)</label>
          <input id="drawerProductPrice" type="number" step="0.01" inputmode="decimal" />
        </div>
        <div class="form-group" style="flex:1">
          <label for="drawerProductPriceKg">Prezzo/kg (‚Ç¨)</label>
          <input id="drawerProductPriceKg" type="number" step="0.01" inputmode="decimal" />
        </div>
      </div>
      <div class="form-group">
        <label for="drawerProductNotes">Note</label>
        <input id="drawerProductNotes" type="text" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button id="drawerAddBtn" class="btn" type="button">Aggiungi al carrello</button>
      </div>
    </div>
  </div>

  <!-- Scanner modal, toast, bottom nav, floating buttons (kept as before) -->
  <div id="scannerModal" class="modal hidden" aria-hidden="true"> ... </div>
  <div id="toast" class="toast" aria-hidden="true"></div>

  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione"> ... </nav>

  <button id="floatingCameraBtn" class="floating-btn floating-left" aria-label="Apri fotocamera"><i class="fa-solid fa-camera"></i></button>
  <button id="floatingAddBtn" class="floating-btn floating-right" aria-label="Aggiungi prodotto"><i class="fa-solid fa-plus"></i></button>

  <!-- app core -->
  <script src="app.js"></script>
  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>

  <!-- Behaviour script -->
  <script>
    // small helpers
    function showToast(msg, timeout = 1400) {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.style.display = 'block';
      t.setAttribute('aria-hidden','false');
      setTimeout(()=>{ t.style.display='none'; t.setAttribute('aria-hidden','true'); }, timeout);
    }
    function escapeHtml(txt){ const d = document.createElement('div'); d.textContent = txt || ''; return d.innerHTML; }

    // mapping category -> font-awesome icon class (white icon inside salvia circle)
    function categoryFaIcon(category) {
      const map = {
        'Latticini': 'fa-cheese',
        'Verdura': 'fa-leaf',
        'Frutta': 'fa-apple-whole',
        'Carne': 'fa-drumstick-bite',
        'Pesce': 'fa-fish',
        'Pane': 'fa-bread-slice',
        'Bevande': 'fa-wine-glass',
        'Altro': 'fa-box-open'
      };
      return map[category] || 'fa-cart-shopping';
    }

    // Create thumbnail element: <img> if image, else placeholder div with icon
    function createThumbnailElement(itemOrSrc, category) {
      if (typeof itemOrSrc === 'string' && itemOrSrc) {
        const img = document.createElement('img');
        img.className = 'cart-thumb';
        img.src = itemOrSrc;
        img.alt = '';
        return img;
      }
      // if object with .image
      if (itemOrSrc && itemOrSrc.image) {
        const img = document.createElement('img');
        img.className = 'cart-thumb';
        img.src = itemOrSrc.image;
        img.alt = itemOrSrc.name || '';
        return img;
      }
      // placeholder
      const wrap = document.createElement('div');
      wrap.className = 'cart-thumb-placeholder';
      const i = document.createElement('i');
      i.className = 'fa-solid ' + categoryFaIcon(category);
      i.setAttribute('aria-hidden','true');
      wrap.appendChild(i);
      return wrap;
    }

    // drawer preview render (either image or placeholder)
    function setDrawerPreview(imgSrc, category) {
      const previewWrap = document.getElementById('drawerImagePreview');
      const container = document.getElementById('drawerPreviewContainer');
      container.innerHTML = '';
      if (imgSrc) {
        const im = document.createElement('img');
        im.className = 'preview-img';
        im.src = imgSrc;
        container.appendChild(im);
        previewWrap.style.display = 'block';
      } else {
        const ph = document.createElement('div');
        ph.className = 'preview-placeholder';
        const ico = document.createElement('i');
        ico.className = 'fa-solid ' + categoryFaIcon(category);
        ph.appendChild(ico);
        container.appendChild(ph);
        previewWrap.style.display = 'block';
      }
    }

    // read current preview image (if any)
    function getDrawerPreviewImage() {
      const container = document.getElementById('drawerPreviewContainer');
      if (!container) return null;
      const img = container.querySelector('img.preview-img');
      return img ? img.src : null;
    }

    // Make sure app exists and expose updateProductInCart if missing
    document.addEventListener('DOMContentLoaded', () => {
      if (!window.app) window.app = new ExpenseTracker();

      // safe fallback (only if not provided by app.js)
      if (!window.app.updateProductInCart) {
        window.app.updateProductInCart = function(updatedProduct) {
          try {
            if (!this.currentCart) this.currentCart = [];
            const idx = this.currentCart.findIndex(p => p.id === updatedProduct.id);
            if (idx === -1) { this.currentCart.push(updatedProduct); }
            else { this.currentCart[idx] = { ...this.currentCart[idx], ...updatedProduct }; }
            document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: this.currentCart }));
            return true;
          } catch (e) { console.error(e); return false; }
        };
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // elements
      const storeListGrid = document.getElementById('storeListGrid');
      const confirmBtn = document.getElementById('confirmStoreBtn');
      const storeChoiceCard = document.getElementById('storeChoiceCard');
      const cartMainPlaceholder = document.getElementById('cartMainPlaceholder');
      const floatingAddBtn = document.getElementById('floatingAddBtn');
      const floatingCameraBtn = document.getElementById('floatingCameraBtn');
      const drawer = document.getElementById('addProductDrawer');
      const drawerOverlay = document.getElementById('drawerOverlay');
      const closeDrawerBtn = document.getElementById('closeDrawerBtn');
      const drawerAddBtn = document.getElementById('drawerAddBtn');

      const selectedStoreLogo = document.getElementById('selectedStoreLogo');
      const selectedStoreTitle = document.getElementById('selectedStoreTitle');
      const selectedStoreDesc = document.getElementById('selectedStoreDesc');
      const storeHeaderCard = document.getElementById('storeHeaderCard');
      const expenseDateHeader = document.getElementById('expenseDateHeader');
      const expenseForm = document.getElementById('expenseForm');

      function hideFloating() { floatingAddBtn.classList.add('hidden'); floatingCameraBtn.classList.add('hidden'); }
      function showFloating() { floatingAddBtn.classList.remove('hidden'); floatingCameraBtn.classList.remove('hidden'); }

      // start
      hideFloating();

      const logoMap = {
        "Conad": "conad.it",
        "Coop": "coop.it",
        "Esselunga": "esselunga.it",
        "Eurospin": "eurospin.it",
        "Carrefour": "carrefour.it",
        "Lidl": "lidl.it",
        "MD": "mdspa.it",
        "Pam": "pam.it",
        "Simply": "simplymarket.it",
        "Iper": "iper.it"
      };
      const descriptions = {
        "Conad":"Catena presente capillarmente in Italia, ideale per prodotti freschi e offerte locali.",
        "Coop":"Coop punta su qualit√† e sostenibilit√†, con un'ampia selezione di prodotti biologici.",
        "Esselunga":"Esselunga offre grandi reparti freschi e numerose promozioni settimanali.",
        "Eurospin":"Discount concentrato sul prezzo: ottime offerte su prodotti essenziali.",
        "Carrefour":"Supermercati e ipermercati con vasta scelta e marchi internazionali.",
        "Lidl":"Discount europeo con prodotti a marchio e offerte settimanali competitive.",
        "MD":"Catena discount con assortimento conveniente e offerte locali frequenti.",
        "Pam":"Supermercati focalizzati su freschi e prodotti regionali, utile per la spesa quotidiana.",
        "Simply":"Punto vendita con offerta pratica per la spesa di tutti i giorni.",
        "Iper":"Ipermercati con grande assortimento e reparti specializzati."
      };

      let selectedStore = null;

      function placeholderSVG(name, diameter=64) {
        const initials = (name || '').split(' ').slice(0,2).map(s => s[0]?.toUpperCase()||'').join('');
        const bg = getComputedStyle(document.documentElement).getPropertyValue('--gh-salvia') || '#7aa986';
        const fg = '#fff';
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${diameter}" height="${diameter}"><rect width="100%" height="100%" rx="10" fill="${bg}"/><text x="50%" y="50%" font-family="Arial, Helvetica, sans-serif" font-size="${Math.round(diameter/2.6)}" fill="${fg}" dominant-baseline="middle" text-anchor="middle">${initials}</text></svg>`);
        return `data:image/svg+xml;utf8,${svg}`;
      }

      function renderStoreCards() {
        storeListGrid.innerHTML = '';
        const stores = (typeof app?.getStores === 'function') ? app.getStores() : Object.keys(logoMap);
        const finalStores = (stores && stores.length) ? stores : Object.keys(logoMap);

        finalStores.forEach(sName => {
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'store-card';
          card.setAttribute('role','listitem');

          const domain = logoMap[sName] || '';
          const clearbitUrl = domain ? `https://logo.clearbit.com/${domain}?size=128` : '';
          const imgSrc = clearbitUrl || placeholderSVG(sName,64);

          card.innerHTML = `
            <div class="store-card-left">
              <img class="store-logo" src="${imgSrc}" alt="${escapeHtml(sName)} logo" />
            </div>
            <div class="store-card-body">
              <div class="store-card-title">${escapeHtml(sName)}</div>
              <div class="store-card-desc"><em>${escapeHtml(descriptions[sName] || '')}</em></div>
            </div>
          `;

          const imgEl = card.querySelector('img.store-logo');
          if (imgEl) { imgEl.addEventListener('error', ()=> imgEl.src = placeholderSVG(sName,64)); }

          card.addEventListener('click', () => {
            document.querySelectorAll('.store-card.selected').forEach(el => el.classList.remove('selected'));
            card.classList.add('selected');
            selectedStore = sName;
            confirmBtn.disabled = false;
            confirmBtn.removeAttribute('aria-disabled');
          });

          storeListGrid.appendChild(card);
        });
      }

      renderStoreCards();
      document.addEventListener('app:stores-changed', renderStoreCards);

      confirmBtn.disabled = true;
      confirmBtn.setAttribute('aria-disabled','true');

      if (confirmBtn) {
        const mo = new MutationObserver(() => {
          if (confirmBtn.disabled) confirmBtn.setAttribute('aria-disabled','true');
          else confirmBtn.removeAttribute('aria-disabled');
        });
        mo.observe(confirmBtn, { attributes:true, attributeFilter:['disabled'] });
      }

      // Confirm store
      confirmBtn?.addEventListener('click', () => {
        if (!selectedStore) return;
        try { app.populateAllStoreSelects(); } catch(e){}

        // ensure storeSelect contains selected store
        const storeSel = document.getElementById('storeSelect');
        if (storeSel) {
          const exists = Array.from(storeSel.options).some(o => o.value === selectedStore);
          if (!exists) {
            const opt = document.createElement('option'); opt.value = selectedStore; opt.textContent = selectedStore;
            storeSel.appendChild(opt);
          }
          storeSel.value = selectedStore;
          storeSel.dispatchEvent(new Event('change', { bubbles:true }));
        }

        // populate and show store header card
        const domain = logoMap[selectedStore] || '';
        const clearbitUrl = domain ? `https://logo.clearbit.com/${domain}?size=128` : '';
        selectedStoreLogo.src = clearbitUrl || placeholderSVG(selectedStore,72);
        selectedStoreLogo.addEventListener('error', ()=> selectedStoreLogo.src = placeholderSVG(selectedStore,72));
        selectedStoreTitle.textContent = selectedStore;
        selectedStoreDesc.textContent = descriptions[selectedStore] || `Ampia scelta di prodotti e offerte presso ${selectedStore}.`;

        // prefill date to today (YYYY-MM-DD) both in header and hidden expenseDate (keep storeSelect & hidden inputs in sync)
        const today = new Date();
        const y = today.getFullYear(); const m = String(today.getMonth()+1).padStart(2,'0'); const d = String(today.getDate()).padStart(2,'0');
        const iso = `${y}-${m}-${d}`;
        expenseDateHeader.value = iso;
        const hiddenDateInput = document.getElementById('expenseDate');
        if (hiddenDateInput) hiddenDateInput.value = iso;

        // show header card
        storeHeaderCard.style.display = 'flex';
        storeHeaderCard.removeAttribute('aria-hidden');

        // Hide store choice card & show placeholder cart
        storeChoiceCard.classList.add('hidden');
        cartMainPlaceholder.style.display = 'flex';
        cartMainPlaceholder.removeAttribute('aria-hidden');

        showFloating();
        // expenseForm remains hidden until products exist
        expenseForm.classList.add('hidden');

        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Drawer open/close
      function openDrawer() {
        if (!storeChoiceCard.classList.contains('hidden')) return;
        drawerOverlay.classList.add('visible');
        drawer.classList.remove('hidden');
        drawer.removeAttribute('aria-hidden');
        document.body.classList.add('no-scroll');
        hideFloating();
      }
      function closeDrawer() {
        drawerOverlay.classList.remove('visible');
        drawer.classList.add('hidden');
        drawer.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');

        // reset edit flag
        const addBtn = document.getElementById('drawerAddBtn');
        if (addBtn) { delete addBtn.dataset.editing; addBtn.textContent = 'Aggiungi al carrello'; }
        if (storeChoiceCard.classList.contains('hidden')) showFloating();
      }

      function openDrawerWithProduct(product) {
        if (!product) return;
        openDrawer();
        document.getElementById('drawerProductName').value = product.name || '';
        document.getElementById('drawerProductCategory').value = product.category || '';
        document.getElementById('drawerProductPrice').value = (product.price !== undefined) ? product.price : '';
        document.getElementById('drawerProductPriceKg').value = (product.priceKg !== undefined && product.priceKg !== null) ? product.priceKg : '';
        document.getElementById('drawerProductNotes').value = product.notes || '';

        const img = product.image || null;
        setDrawerPreview(img, product.category || 'Altro');

        const addBtn = document.getElementById('drawerAddBtn');
        addBtn.dataset.editing = product.id;
        addBtn.textContent = 'Salva modifica';
      }

      document.getElementById('floatingAddBtn')?.addEventListener('click', (e) => { e.preventDefault(); openDrawer(); });
      closeDrawerBtn?.addEventListener('click', closeDrawer);
      drawerOverlay?.addEventListener('click', closeDrawer);

      // add/edit product
      function normalizeDecimalString(s) { return (s||'').toString().trim().replace(',', '.'); }

      drawerAddBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('drawerProductName');
        const catInput = document.getElementById('drawerProductCategory');
        const priceInput = document.getElementById('drawerProductPrice');
        const priceKgInput = document.getElementById('drawerProductPriceKg');
        const notesInput = document.getElementById('drawerProductNotes');

        const name = (nameInput?.value || '').trim();
        const cat = (catInput?.value || '').trim();
        const priceRaw = (priceInput?.value || '').trim();
        const priceKgRaw = (priceKgInput?.value || '').trim();
        const notes = (notesInput?.value || '').trim();

        const price = parseFloat(normalizeDecimalString(priceRaw)) || 0;
        const priceKg = priceKgRaw ? (parseFloat(normalizeDecimalString(priceKgRaw)) || null) : null;

        if (!name || !cat || !price || isNaN(price) || price <= 0) {
          alert('Compila nome, categoria e prezzo correttamente.');
          return;
        }

        const editingId = drawerAddBtn.dataset.editing;
        if (editingId) {
          const updated = { id: editingId, name, category: cat, price, priceKg, notes };
          if (window.app && typeof window.app.updateProductInCart === 'function') {
            window.app.updateProductInCart(updated);
            showToast('Prodotto aggiornato');
          } else {
            // fallback
            if (!window.app.currentCart) window.app.currentCart = [];
            const idx = window.app.currentCart.findIndex(p => p.id === editingId);
            if (idx !== -1) {
              const prevImg = window.app.currentCart[idx].image;
              window.app.currentCart[idx] = { ...window.app.currentCart[idx], ...updated, image: prevImg };
              document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: window.app.currentCart }));
              showToast('Prodotto aggiornato');
            }
          }
        } else {
          const product = {
            id: (window.app && typeof app.generateId === 'function') ? app.generateId() : ('p_'+Date.now()),
            name, category: cat, price, priceKg, notes
          };

          // attach scanned image if any (app.getLastScannedImage) or drawer preview image
          try {
            if (window.app && typeof app.getLastScannedImage === 'function') {
              const img = app.getLastScannedImage();
              if (img) product.image = img;
            }
          } catch(e){}

          const previewImg = getDrawerPreviewImage();
          if (!product.image && previewImg) product.image = previewImg;

          // add via app
          if (window.app && typeof app.addProductToCart === 'function') {
            window.app.addProductToCart(product);
          } else {
            if (!window.app.currentCart) window.app.currentCart = [];
            window.app.currentCart.push(product);
            document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: window.app.currentCart }));
          }

          showToast('Prodotto aggiunto al carrello');
          // clear last scanned
          try { if (app && typeof app.setLastScannedImage === 'function') app.setLastScannedImage(null); } catch(e){}
        }

        // show cart UI
        document.getElementById('cartSection')?.classList.remove('hidden');
        document.getElementById('cartSection')?.removeAttribute('aria-hidden');
        cartMainPlaceholder.style.display = 'none';
        expenseForm.classList.remove('hidden');

        // update
        try { updateCartDisplay(); } catch(e){ console.warn(e); }

        // clear if not editing
        if (!editingId) {
          nameInput.value = ''; catInput.value = ''; priceInput.value = ''; priceKgInput.value = ''; notesInput.value = '';
          const previewWrap = document.getElementById('drawerImagePreview');
          previewWrap.style.display = 'none';
          document.getElementById('drawerPreviewContainer').innerHTML = '';
        }

        closeDrawer();
      });

      // floating camera button (kept)
      document.getElementById('floatingCameraBtn')?.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!storeChoiceCard.classList.contains('hidden')) return;
        if (typeof openScannerModal === 'function') {
          try { await openScannerModal(); } catch (err) { console.warn(err); alert('Impossibile aprire la fotocamera.'); }
        } else {
          document.getElementById('scanBarcodeBtn')?.click();
        }
      });

      // handle barcode event (open drawer & populate)
      document.addEventListener('app:barcode-scanned', (ev) => {
        try {
          if (storeChoiceCard.classList.contains('hidden')) openDrawer();
          const data = ev && ev.detail ? ev.detail : {};
          const product = data.product || {};
          const img = data.image || (window.app && typeof app.getLastScannedImage === 'function' ? app.getLastScannedImage() : null);

          const nameField = document.getElementById('drawerProductName');
          const notesField = document.getElementById('drawerProductNotes');
          const categoryField = document.getElementById('drawerProductCategory');

          const prodName = product.product_name || product.generic_name || product.brands || '';
          if (nameField && prodName) nameField.value = prodName;

          let noteParts = [];
          if (product.brands) noteParts.push(product.brands);
          if (product.quantity) noteParts.push(product.quantity);
          if (product.categories) noteParts.push(product.categories.split(',').slice(0,2).join(' ‚Ä¢ '));
          if (notesField && noteParts.length) notesField.value = noteParts.join(' ‚Ä¢ ');

          if (categoryField && Array.isArray(product.categories_tags) && product.categories_tags.length) {
            const tag = product.categories_tags[0] || '';
            const human = (product.categories || '').split(',')[0] || tag.replace('en:', '').replace(/-/g,' ');
            Array.from(categoryField.options).forEach(o => {
              if (human && o.value && o.value.toLowerCase().includes(human.toLowerCase())) {
                categoryField.value = o.value;
              }
            });
          }

          setDrawerPreview(img, (product.categories || '').split(',')[0] || 'Altro');
        } catch (e) { console.warn('app:barcode-scanned handler error', e); }
      });

      // populate store selects
      try { app.populateAllStoreSelects(); } catch(e){}

      // when cart changes (update UI)
      document.addEventListener('app:cart-changed', (ev) => {
        const cart = (window.app && window.app.currentCart) ? window.app.currentCart : (ev && ev.detail) ? ev.detail : [];
        if (!cart || cart.length === 0) {
          if (storeChoiceCard.classList.contains('hidden')) {
            cartMainPlaceholder.style.display = 'flex';
            document.getElementById('cartSection')?.classList.add('hidden');
            expenseForm.classList.add('hidden');
          }
        } else {
          cartMainPlaceholder.style.display = 'none';
          document.getElementById('cartSection')?.classList.remove('hidden');
          expenseForm.classList.remove('hidden');
        }
        if (storeChoiceCard.classList.contains('hidden')) showFloating();
        try { updateCartDisplay(); } catch(e){ console.warn(e); }
      });

      // clear cart button
      const clearCartBtn = document.getElementById('clearCartBtn');
      if (clearCartBtn) {
        clearCartBtn.addEventListener('click', () => {
          if (!confirm('Vuoi davvero svuotare il carrello?')) return;
          try {
            if (window.app && typeof window.app.clearCart === 'function') {
              window.app.clearCart();
              showToast('Carrello svuotato');
            } else {
              if (!window.app) window.app = {};
              window.app.currentCart = [];
              document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: window.app.currentCart }));
              showToast('Carrello svuotato');
            }
          } catch (e) { console.error('clear cart error', e); }
        });
      }

      // save expense button (reads date from header input)
      const saveExpenseBtn = document.getElementById('saveExpenseBtn');
      if (saveExpenseBtn) {
        saveExpenseBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          // read store and date
          const storeSelect = document.getElementById('storeSelect');
          const store = storeSelect ? (storeSelect.value || '') : '';
          const dateInputHidden = document.getElementById('expenseDate');
          const date = (expenseDateHeader && expenseDateHeader.value) ? expenseDateHeader.value : (dateInputHidden ? dateInputHidden.value : '');

          if (!store) { alert('Seleziona il supermercato prima di salvare.'); return; }
          if (!date) { alert('Seleziona la data della spesa.'); return; }
          if (!window.app || !Array.isArray(window.app.currentCart) || window.app.currentCart.length === 0) { alert('Il carrello √® vuoto.'); return; }

          try {
            const saved = window.app.saveCartAsExpense(store, date);
            if (saved) {
              showToast('Spesa salvata con successo', 1600);
              // UI reset
              document.getElementById('cartMainPlaceholder').style.display = 'flex';
              document.getElementById('cartSection')?.classList.add('hidden');
              document.getElementById('expenseForm')?.classList.add('hidden');
              // dispatch events so index/archivio can update
              document.dispatchEvent(new CustomEvent('app:expenses-changed', { detail: window.app.expenses }));
              document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: window.app.currentCart }));
              updateCartDisplay();
            } else {
              alert('Errore durante il salvataggio della spesa.');
            }
          } catch (e) {
            console.error('save expense error', e);
            alert('Errore durante il salvataggio della spesa.');
          }
        });
      }

      // bottom padding for nav
      const bottomNav = document.querySelector('.bottom-nav');
      const main = document.querySelector('main');
      if (bottomNav && main) {
        const navH = bottomNav.offsetHeight || 0; const extra = 28;
        main.style.paddingBottom = (navH + extra) + 'px'; document.body.style.paddingBottom = (navH + extra) + 'px';
      }
    }); // DOMContentLoaded
  </script>

  <!-- updateCartDisplay: populate #cartBody, update total, enable buttons -->
  <script>
    function updateCartDisplay() {
      try {
        const tbody = document.getElementById('cartBody');
        if (!tbody) return;
        const cart = (window.app && Array.isArray(window.app.currentCart)) ? window.app.currentCart : [];
        tbody.innerHTML = '';

        if (!cart || cart.length === 0) {
          document.getElementById('cartTotal').textContent = (window.app && typeof app.formatCurrency === 'function') ? app.formatCurrency(0) : '‚Ç¨0.00';
          document.getElementById('saveExpenseBtn').disabled = true;
          return;
        }

        cart.forEach(item => {
          const tr = document.createElement('tr');

          // product column
          const tdProd = document.createElement('td');
          const prodWrap = document.createElement('div'); prodWrap.style.display='flex'; prodWrap.style.alignItems='center';

          // thumbnail (img or placeholder)
          const thumb = (function(){
            if (item.image) {
              const img = document.createElement('img'); img.className='cart-thumb'; img.src = item.image; img.alt = item.name || ''; return img;
            } else {
              const wrap = document.createElement('div'); wrap.className='cart-thumb-placeholder';
              const i = document.createElement('i'); i.className = 'fa-solid ' + (function(c){ const map = { 'Latticini':'fa-cheese','Verdura':'fa-leaf','Frutta':'fa-apple-whole','Carne':'fa-drumstick-bite','Pesce':'fa-fish','Pane':'fa-bread-slice','Bevande':'fa-wine-glass','Altro':'fa-box-open'}; return map[c]||'fa-cart-shopping'; })(item.category);
              wrap.appendChild(i);
              return wrap;
            }
          })();
          prodWrap.appendChild(thumb);

          const info = document.createElement('div');
          const nameEl = document.createElement('div'); nameEl.className='cart-product-name'; nameEl.textContent = item.name || '';
          const metaEl = document.createElement('div'); metaEl.className='cart-product-meta';
          const cat = item.category? item.category : '';
          const notes = item.notes ? (' ‚Äî ' + item.notes) : '';
          metaEl.textContent = cat + (item.priceKg ? (` ‚Ä¢ ${item.priceKg} ‚Ç¨/kg`) : '') + (notes ? notes : '');
          info.appendChild(nameEl); info.appendChild(metaEl);

          prodWrap.appendChild(info);
          tdProd.appendChild(prodWrap);
          tr.appendChild(tdProd);

          // price column
          const tdPrice = document.createElement('td'); tdPrice.style.whiteSpace='nowrap';
          const priceNum = (item.price !== undefined && item.price !== null) ? parseFloat(item.price) : 0;
          const priceText = (window.app && typeof app.formatCurrency === 'function') ? app.formatCurrency(priceNum) : `‚Ç¨${(priceNum||0).toFixed(2)}`;
          tdPrice.textContent = priceText;
          tr.appendChild(tdPrice);

          // actions column
          const tdActions = document.createElement('td');

          const editBtn = document.createElement('button');
          editBtn.className = 'cart-edit-btn'; editBtn.type='button'; editBtn.title='Modifica'; editBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
          editBtn.addEventListener('click', ()=> { openDrawerWithProduct(item); });
          tdActions.appendChild(editBtn);

          const removeBtn = document.createElement('button');
          removeBtn.className = 'cart-remove-btn'; removeBtn.type='button'; removeBtn.title='Rimuovi'; removeBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
          removeBtn.addEventListener('click', ()=> {
            try {
              if (window.app && typeof app.removeProductFromCart === 'function') {
                app.removeProductFromCart(item.id);
                showToast('Prodotto rimosso');
              } else {
                const idx = (window.app && Array.isArray(window.app.currentCart)) ? window.app.currentCart.findIndex(p => p.id === item.id) : -1;
                if (idx !== -1) { window.app.currentCart.splice(idx,1); document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: window.app.currentCart })); showToast('Prodotto rimosso'); }
              }
            } catch (e) { console.error('remove from cart error', e); }
          });
          tdActions.appendChild(removeBtn);

          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });

        const total = (window.app && typeof app.getCartTotal === 'function') ? app.getCartTotal() : cart.reduce((s,i)=> s + (parseFloat(i.price)||0),0);
        document.getElementById('cartTotal').textContent = (window.app && typeof app.formatCurrency === 'function') ? app.formatCurrency(total) : `‚Ç¨${total.toFixed(2)}`;
        const saveBtn = document.getElementById('saveExpenseBtn'); if (saveBtn) saveBtn.disabled = !(cart && cart.length > 0);
      } catch (err) { console.error('updateCartDisplay error', err); }
    }

    // init render
    document.addEventListener('DOMContentLoaded', () => { try { updateCartDisplay(); } catch(e){ console.warn(e); } });
    document.addEventListener('app:cart-changed', () => { try { updateCartDisplay(); } catch(e){ console.warn(e); } });

    // Expose helper used by updateCartDisplay
    function openDrawerWithProduct(product) {
      // delegated to behaviour script; keep function global for usage in updateCartDisplay event handlers
      const evt = new CustomEvent('app:open-drawer-with-product', { detail: product });
      document.dispatchEvent(evt);
    }

    // Listen and forward to real openDrawerWithProduct inside behaviour script
    document.addEventListener('app:open-drawer-with-product', (ev) => {
      try {
        // actual handler is defined in behaviour; find it and call - we rely on the function declared there
        if (typeof window.openDrawerWithProduct === 'function') {
          window.openDrawerWithProduct(ev.detail);
        } else {
          // fallback: dispatch a DOM event that behaviour code listens to (it already uses global openDrawerWithProduct by closure)
          // no-op if not available
        }
      } catch (e) { /* ignore */ }
    });
  </script>
</body>
</html>