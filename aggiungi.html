<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aggiungi Spesa</title>
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="theme-color" content="#4CAF50" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <header>
        <h1>üõçÔ∏è Aggiungi Spesa</h1>
        <nav>
            <a href="index.html">Dashboard</a>
            <a href="aggiungi.html" class="nav-active">Aggiungi</a>
            <a href="archivio.html">Archivio</a>
        </nav>
    </header>

    <main class="add-expense">
        <form id="expenseForm" class="expense-form" novalidate>
            <div class="form-section">
                <h2>üè™ Informazioni Generali</h2>
                
                <div class="form-group">
                    <label for="storeSelect">Supermercato:</label>
                    <select id="storeSelect" required>
                        <option value="">Seleziona supermercato</option>
                        <option value="Conad">Conad</option>
                        <option value="Coop">Coop</option>
                        <option value="Esselunga">Esselunga</option>
                        <option value="Eurospin">Eurospin</option>
                        <option value="Carrefour">Carrefour</option>
                        <option value="Lidl">Lidl</option>
                        <option value="MD">MD</option>
                        <option value="Pam">Pam</option>
                        <option value="Simply">Simply</option>
                        <option value="Iper">Iper</option>
                        <option value="Altro">Altro (specificare sotto)</option>
                    </select>
                </div>

                <div class="form-group" id="customStoreGroup" style="display: none;">
                    <label for="customStore">Nome supermercato:</label>
                    <input type="text" id="customStore" placeholder="Inserisci nome supermercato" />
                </div>

                <div class="form-group">
                    <label for="expenseDate">Data:</label>
                    <input type="date" id="expenseDate" required />
                </div>
            </div>

            <div class="form-section">
                <h2>üõí Aggiungi Prodotti</h2>
                
                <div class="product-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productCategory">Tipologia:</label>
                            <select id="productCategory" required>
                                <option value="">Seleziona tipologia</option>
                                <option value="Carne">ü•© Carne</option>
                                <option value="Pesce">üêü Pesce</option>
                                <option value="Verdura">ü•¨ Verdura</option>
                                <option value="Frutta">üçé Frutta</option>
                                <option value="Latticini">üßÄ Latticini</option>
                                <option value="Pane">üçû Pane e Cereali</option>
                                <option value="Bevande">ü•§ Bevande</option>
                                <option value="Surgelati">üßä Surgelati</option>
                                <option value="Dolci">üç∞ Dolci</option>
                                <option value="Pulizia">üßΩ Prodotti Pulizia</option>
                                <option value="Igiene">üß¥ Igiene Personale</option>
                                <option value="Altro">üì¶ Altro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="productName">Nome prodotto:</label>
                            <input type="text" id="productName" placeholder="Es. Pomodori" required />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="productPrice">Prezzo (‚Ç¨):</label>
                            <input type="number" id="productPrice" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
                        </div>

                        <div class="form-group">
                            <label for="productPriceKg">Prezzo/kg (‚Ç¨):</label>
                            <input type="number" id="productPriceKg" step="0.01" min="0" inputmode="decimal" placeholder="0.00" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="productNotes">Note:</label>
                        <input type="text" id="productNotes" placeholder="Note aggiuntive (opzionale)" />
                    </div>

                    <button type="button" id="addProductBtn" class="btn btn-secondary">
                        ‚ûï Aggiungi Prodotto al Carrello
                    </button>
                </div>
            </div>

            <div class="cart-section" id="cartSection" style="display: none;">
                <h2>üõí Carrello</h2>
                <div class="cart-table-container">
                    <table id="cartTable">
                        <thead>
                            <tr>
                                <th>Prodotto</th>
                                <th>Prezzo</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="cartBody"></tbody>
                    </table>
                </div>
                <div class="cart-total">
                    <strong>Totale: <span id="cartTotal">‚Ç¨0.00</span></strong>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" id="saveExpenseBtn" class="btn btn-primary" disabled>
                    üíæ Salva Spesa Completa
                </button>
                <button type="button" id="clearCartBtn" class="btn btn-danger">
                    üóëÔ∏è Svuota Carrello
                </button>
            </div>
        </form>
    </main>

    <!-- Includi la classe condivisa e l'istanza globale -->
    <script src="app.js"></script>

    <!-- Script specifico per la pagina Aggiungi -->
    <script>
    // Verifica che l'istanza globale app esista
    if (typeof app === 'undefined') {
        console.error('ERRORE: oggetto globale "app" non trovato. Controlla che app.js sia incluso e valido.');
    }

    // Helper: escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    // Funzioni UI / logica carrello (usano l'istanza globale `app`)
    function toggleCustomStore() {
        const storeSelect = document.getElementById('storeSelect');
        const customStoreGroup = document.getElementById('customStoreGroup');
        const customStore = document.getElementById('customStore');

        if (!storeSelect || !customStoreGroup) return;
        if (storeSelect.value === 'Altro') {
            customStoreGroup.style.display = 'block';
            if (customStore) customStore.required = true;
        } else {
            customStoreGroup.style.display = 'none';
            if (customStore) customStore.required = false;
        }
    }

    function addProductToCart() {
        const categoryEl = document.getElementById('productCategory');
        const nameEl = document.getElementById('productName');
        const priceEl = document.getElementById('productPrice');
        const priceKgEl = document.getElementById('productPriceKg');
        const notesEl = document.getElementById('productNotes');

        if (!categoryEl || !nameEl || !priceEl) {
            console.error('Elementi form non trovati');
            return;
        }

        const category = categoryEl.value.trim();
        const name = nameEl.value.trim();
        const priceRaw = priceEl.value.trim();
        const price = parseFloat(priceRaw);
        const priceKg = priceKgEl && priceKgEl.value ? parseFloat(priceKgEl.value) : null;
        const notes = notesEl && notesEl.value ? notesEl.value.trim() : '';

        if (!category) { categoryEl.focus(); return; }
        if (!name) { nameEl.focus(); return; }
        if (!priceRaw || isNaN(price) || price <= 0) { priceEl.focus(); return; }

        if (typeof app === 'undefined') {
            console.error('Oggetto app non disponibile');
            return;
        }

        const product = {
            id: app.generateId(),
            category,
            name,
            price,
            priceKg,
            notes
        };

        app.currentCart.push(product);
        updateCartDisplay();
        clearProductForm();

        const addBtn = document.getElementById('addProductBtn');
        if (addBtn) {
            addBtn.classList.add('pulse');
            setTimeout(() => addBtn.classList.remove('pulse'), 300);
        }

        // focus su nome prodotto per inserimento rapido
        nameEl.focus();
    }

    function updateCartDisplay() {
        const cartSection = document.getElementById('cartSection');
        const cartBody = document.getElementById('cartBody');
        const cartTotal = document.getElementById('cartTotal');
        const saveBtn = document.getElementById('saveExpenseBtn');

        if (!cartSection || !cartBody || !cartTotal || !saveBtn) return;

        if (!app.currentCart || app.currentCart.length === 0) {
            cartSection.style.display = 'none';
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.5';
            cartBody.innerHTML = '';
            cartTotal.textContent = app.formatCurrency(0);
            return;
        }

        cartSection.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';

        cartBody.innerHTML = app.currentCart.map(product => `
            <tr>
                <td>
                    <strong>${escapeHtml(product.name)}</strong><br>
                    <small style="color: #666;">${escapeHtml(product.category)}</small>
                    ${product.notes ? `<br><small style="color: #888;">üìù ${escapeHtml(product.notes)}</small>` : ''}
                    ${product.priceKg ? `<br><small style="color: #666;">üí∞ ${app.formatCurrency(product.priceKg)}/kg</small>` : ''}
                </td>
                <td><strong>${app.formatCurrency(product.price)}</strong></td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeFromCart('${product.id}')" title="Rimuovi prodotto">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `).join('');

        const total = app.currentCart.reduce((sum, p) => sum + (parseFloat(p.price) || 0), 0);
        cartTotal.textContent = app.formatCurrency(total);
    }

    function clearProductForm() {
        const category = document.getElementById('productCategory');
        const name = document.getElementById('productName');
        const price = document.getElementById('productPrice');
        const priceKg = document.getElementById('productPriceKg');
        const notes = document.getElementById('productNotes');

        if (category) category.value = '';
        if (name) name.value = '';
        if (price) price.value = '';
        if (priceKg) priceKg.value = '';
        if (notes) notes.value = '';
    }

    function removeFromCart(productId) {
        if (!app.currentCart) return;
        app.currentCart = app.currentCart.filter(p => p.id !== productId);
        updateCartDisplay();
    }

    function clearCart() {
        if (!app.currentCart || app.currentCart.length === 0) return;
        if (confirm('üóëÔ∏è Sei sicuro di voler svuotare il carrello?')) {
            app.currentCart = [];
            updateCartDisplay();
        }
    }

    function saveExpense() {
        const storeSelect = document.getElementById('storeSelect');
        const customStore = document.getElementById('customStore');
        const expenseDate = document.getElementById('expenseDate');

        if (!storeSelect || !expenseDate) return;

        const store = storeSelect.value === 'Altro' ? (customStore ? customStore.value.trim() : '') : storeSelect.value;
        const date = expenseDate.value;

        // validazione base
        if (!store) { alert('‚ö†Ô∏è Inserisci il supermercato.'); return; }
        if (!date) { alert('‚ö†Ô∏è Inserisci la data.'); return; }
        if (!app.currentCart || app.currentCart.length === 0) { alert('‚ö†Ô∏è Aggiungi almeno un prodotto.'); return; }

        // prevenire date future
        const today = new Date().toISOString().split('T')[0];
        if (date > today) { alert('‚ö†Ô∏è La data non pu√≤ essere futura.'); return; }

        try {
            app.addExpense(store, date, app.currentCart);

            // feedback non bloccante
            // preferibile sostituire con toast UI in futuro
            alert('‚úÖ Spesa salvata con successo!');

            // reset form
            document.getElementById('expenseForm').reset();
            app.currentCart = [];
            updateCartDisplay();
            toggleCustomStore();

            // reimposta data odierna
            expenseDate.value = today;
        } catch (err) {
            console.error('Errore salvataggio spesa:', err);
            alert('‚ùå Errore nel salvataggio. Riprova.');
        }
    }

    // Inizializzazione pagina
    document.addEventListener('DOMContentLoaded', function () {
        // Imposta data odierna
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('expenseDate');
        if (dateInput) dateInput.value = today;

        // Event listeners
        const storeSelect = document.getElementById('storeSelect');
        const addProductBtn = document.getElementById('addProductBtn');
        const saveExpenseBtn = document.getElementById('saveExpenseBtn');
        const clearCartBtn = document.getElementById('clearCartBtn');
        const expenseForm = document.getElementById('expenseForm');

        if (storeSelect) storeSelect.addEventListener('change', toggleCustomStore);
        if (addProductBtn) addProductBtn.addEventListener('click', function(e) { e.preventDefault(); addProductToCart(); });
        if (saveExpenseBtn) saveExpenseBtn.addEventListener('click', function(e) { e.preventDefault(); saveExpense(); });
        if (clearCartBtn) clearCartBtn.addEventListener('click', function(e) { e.preventDefault(); clearCart(); });
        if (expenseForm) expenseForm.addEventListener('submit', function(e) { e.preventDefault(); saveExpense(); });

        // inizializza carrello vuoto
        if (app && Array.isArray(app.currentCart)) {
            app.currentCart = [];
        } else if (app) {
            app.currentCart = [];
        }

        updateCartDisplay();
        toggleCustomStore();
    });
    </script>
</body>
</html>