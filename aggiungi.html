<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggiungi Spesa</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#1e1e1e" />

  <link rel="stylesheet" href="style.css" />
  <style>
    /* piccoli aggiustamenti locali (non cambiare style.css) */
    .product-form .meta { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .cart-item-row { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.03); }
    .cart-item-left { display:flex; gap:12px; align-items:center; min-width:0; }
    .cart-item-name { font-weight:700; color:var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px; }
    .cart-item-price { font-weight:700; color:var(--text-primary); min-width:90px; text-align:right; }
    .small-note { color:var(--text-secondary); font-size:0.9rem; }
    .image-placeholder { width:64px; height:64px; border-radius:8px; background:rgba(255,255,255,0.02); display:flex;align-items:center;justify-content:center;color:var(--text-secondary); font-size:0.9rem; border:1px solid rgba(255,255,255,0.02); }
  </style>
</head>
<body>
  <header>
    <h1>üõçÔ∏è Aggiungi Spesa</h1>
    <nav class="top-nav" role="navigation" aria-label="Menu principale">
      <a href="index.html">Dashboard</a>
      <a href="aggiungi.html" class="nav-active">Aggiungi</a>
      <a href="archivio.html">Archivio</a>
      <a href="impostazioni.html">Impostazioni</a>
    </nav>
  </header>

  <main class="add-expense">
    <form id="expenseForm" class="expense-form" novalidate>
      <section class="form-section">
        <h2>üè™ Informazioni Generali</h2>
        <div class="form-group">
          <label for="storeSelect">Supermercato:</label>
          <select id="storeSelect" class="store-select" required></select>
        </div>
        <div class="form-group" id="customStoreGroup" style="display:none;">
          <label for="customStore">Nome supermercato:</label>
          <input type="text" id="customStore" placeholder="Inserisci nome supermercato" />
        </div>
        <div class="form-group">
          <label for="expenseDate">Data:</label>
          <input type="date" id="expenseDate" required />
        </div>
      </section>

      <section class="form-section">
        <h2>üõí Aggiungi Prodotti</h2>
        <div class="product-form">
          <div class="form-row">
            <div class="form-group">
              <label for="productCategory">Tipologia:</label>
              <select id="productCategory" required>
                <option value="">Seleziona tipologia</option>
                <option value="Carne">ü•© Carne</option>
                <option value="Pesce">üêü Pesce</option>
                <option value="Verdura">ü•¨ Verdura</option>
                <option value="Frutta">üçé Frutta</option>
                <option value="Latticini">üßÄ Latticini</option>
                <option value="Pane">üçû Pane e Cereali</option>
                <option value="Bevande">ü•§ Bevande</option>
                <option value="Surgelati">üßä Surgelati</option>
                <option value="Dolci">üç∞ Dolci</option>
                <option value="Pulizia">üßΩ Prodotti Pulizia</option>
                <option value="Igiene">üß¥ Igiene Personale</option>
                <option value="Altro">üì¶ Altro</option>
              </select>
            </div>

            <div class="form-group">
              <label for="productName">Nome prodotto:</label>
              <input type="text" id="productName" placeholder="Es. Pomodori" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="productPrice">Prezzo (‚Ç¨):</label>
              <input type="number" id="productPrice" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
            </div>

            <div class="form-group">
              <label for="productPriceKg">Prezzo/kg (‚Ç¨):</label>
              <input type="number" id="productPriceKg" step="0.01" min="0" inputmode="decimal" placeholder="0.00" />
            </div>
          </div>

          <div class="form-group">
            <label for="productNotes">Note:</label>
            <input type="text" id="productNotes" placeholder="Note aggiuntive (opzionale)" />
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" id="scanBarcodeBtn" class="btn btn-secondary">üì∑ Scansiona codice a barre</button>
            <button type="button" id="addProductBtn" class="btn">‚ûï Aggiungi Prodotto al Carrello</button>
          </div>

          <div class="meta" style="margin-top:8px;">
            <div id="lastScannedInfo" class="small-note">Nessuna scansione effettuata</div>
          </div>
        </div>
      </section>

      <section class="cart-section" id="cartSection" style="display:block;">
        <h2>üõí Carrello</h2>
        <div id="cartList"></div>
        <div class="cart-total"><strong>Totale: <span id="cartTotal">‚Ç¨0.00</span></strong></div>
      </section>

      <section class="form-actions">
        <button type="submit" id="saveExpenseBtn" class="btn" disabled>üíæ Salva Spesa Completa</button>
        <button type="button" id="clearCartBtn" class="btn btn-danger">üóëÔ∏è Svuota Carrello</button>
      </section>
    </form>
  </main>

  <!-- scanner modal (semplice esempio) -->
  <div id="scannerModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>üì∑ Scansione Codice a Barre</h3>
      <p class="small-note">Inquadra il codice: l'app recuperer√† i dati da Open Food Facts e la relativa immagine se disponibile.</p>
      <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px;">
        <button id="scannerSimulateBtn" class="btn">Simula Scan (Esempio)</button>
        <button id="scannerCancelBtn" class="btn btn-secondary">Annulla</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="app.js"></script>

  <script>
    // --- HELPERS per fetch OpenFoodFacts e integrazione immagine ---
    async function fetchProductFromOFF(barcode) {
      // Richiesta al server OpenFoodFacts
      try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(barcode)}.json`);
        if (!res.ok) return null;
        const data = await res.json();
        if (!data || data.status !== 1 || !data.product) return null;
        const p = data.product;
        // preferenze campo immagine disponibili
        const image = p.image_front_small_url || p.image_small_url || p.image_url || p.image_front_url || null;
        return {
          name: p.product_name || p.generic_name || '',
          image: image,
          brands: p.brands || '',
          raw: p
        };
      } catch (err) {
        console.warn('OFF fetch error', err);
        return null;
      }
    }

    // UI & logica aggiungi
    document.addEventListener('DOMContentLoaded', () => {
      const scanBtn = document.getElementById('scanBarcodeBtn');
      const addBtn = document.getElementById('addProductBtn');
      const cartList = document.getElementById('cartList');
      const cartTotalEl = document.getElementById('cartTotal');
      const saveBtn = document.getElementById('saveExpenseBtn');
      const clearCartBtn = document.getElementById('clearCartBtn');
      const lastScannedInfo = document.getElementById('lastScannedInfo');

      // aggiorna UI carrello (al cambiamento dell'evento app:cart-changed)
      function renderCart(products) {
        cartList.innerHTML = '';
        if (!products || products.length === 0) {
          cartList.innerHTML = '<div class="no-expenses">Il carrello √® vuoto.</div>';
          cartTotalEl.textContent = app.formatCurrency(0);
          saveBtn.disabled = true;
          return;
        }
        products.forEach(p => {
          const row = document.createElement('div');
          row.className = 'cart-item-row';
          // left: thumbnail + nome
          const left = document.createElement('div');
          left.className = 'cart-item-left';
          if (p.image) {
            const img = document.createElement('img');
            img.src = p.image;
            img.className = 'thumb';
            img.alt = p.name || 'foto prodotto';
            left.appendChild(img);
          } else {
            const placeholder = document.createElement('div');
            placeholder.className = 'image-placeholder';
            placeholder.textContent = 'No foto';
            left.appendChild(placeholder);
          }
          const nameWrap = document.createElement('div');
          nameWrap.style = 'display:flex;flex-direction:column;min-width:0;';
          const name = document.createElement('div');
          name.className = 'cart-item-name';
          name.textContent = p.name || '(senza nome)';
          const small = document.createElement('div');
          small.className = 'small-note';
          small.textContent = p.category ? `${p.category}` : '';
          nameWrap.appendChild(name);
          nameWrap.appendChild(small);
          left.appendChild(nameWrap);

          // price + actions
          const right = document.createElement('div');
          right.style = 'display:flex;gap:8px;align-items:center;min-width:0;';
          const price = document.createElement('div');
          price.className = 'cart-item-price';
          price.textContent = app.formatCurrency(p.price || 0);
          const rem = document.createElement('button');
          rem.className = 'remove-btn';
          rem.title = 'Rimuovi';
          rem.innerHTML = 'üóëÔ∏è';
          rem.addEventListener('click', () => {
            app.removeProductFromCart(p.id);
          });
          right.appendChild(price);
          right.appendChild(rem);

          row.appendChild(left);
          row.appendChild(right);
          cartList.appendChild(row);
        });

        cartTotalEl.textContent = app.formatCurrency(app.getCartTotal());
        saveBtn.disabled = false;
      }

      // ascolta evento cart change
      document.addEventListener('app:cart-changed', (ev) => {
        renderCart(ev.detail || []);
      });

      // ascolta last scanned img change
      document.addEventListener('app:last-scanned-image-changed', (ev) => {
        const url = ev.detail;
        if (url) {
          lastScannedInfo.textContent = `Immagine trovata dall'API. Anteprima disponibile al momento dell'aggiunta.`;
        } else {
          lastScannedInfo.textContent = `Nessuna immagine trovata dall'ultimo scan.`;
        }
      });

      // Simulazione scanner semplice (in produzione sostituisci con ZXing reale)
      const scannerModal = document.getElementById('scannerModal');
      document.getElementById('scannerCancelBtn')?.addEventListener('click', () => {
        scannerModal.style.display = 'none';
      });

      // bottone che apre il modal / avvia scan
      scanBtn.addEventListener('click', (e) => {
        e.preventDefault();
        // in ambiente reale apri camera + decodifica barcode, qui mostri il modal di simulazione
        scannerModal.style.display = 'block';
      });

      // simulazione: simula un barcode (esempio: 3270190020399 -> Nutella, ma non sempre presente)
      document.getElementById('scannerSimulateBtn')?.addEventListener('click', async (e) => {
        e.preventDefault();
        scannerModal.style.display = 'none';
        const barcode = prompt('Inserisci barcode di prova (es. 3270190020399) oppure OK per test placeholder', '');
        if (!barcode) return;
        // fetch OFF
        lastScannedInfo.textContent = 'Recupero dati da OpenFoodFacts‚Ä¶';
        app.setLastScannedBarcode(barcode);
        const info = await fetchProductFromOFF(barcode);
        if (info) {
          app.setLastScannedImage(info.image || null);
          // pre-fill fields se disponibili
          if (info.name) document.getElementById('productName').value = info.name;
          document.getElementById('productNotes').value = info.brands || '';
          lastScannedInfo.textContent = `Scansione OK: ${info.name || '(nome non disponibile)'}`;
        } else {
          app.setLastScannedImage(null);
          lastScannedInfo.textContent = 'Prodotto non trovato su OpenFoodFacts.';
        }
      });

      // aggiungi singolo prodotto (usa eventuale immagine recuperata)
      addBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const name = (document.getElementById('productName')?.value || '').trim();
        const priceRaw = (document.getElementById('productPrice')?.value || '').trim();
        const price = parseFloat(priceRaw);
        const category = (document.getElementById('productCategory')?.value || '').trim() || 'Altro';
        const notes = (document.getElementById('productNotes')?.value || '').trim();
        if (!name) { alert('Inserisci il nome del prodotto'); return; }
        if (isNaN(price) || price < 0) { alert('Inserisci un prezzo valido'); return; }
        const image = app.getLastScannedImage() || null;
        const prod = { name, price, category, notes, image };
        app.addProductToCart(prod);
        // pulisci campi (ma mantieni last scanned image - rimane per prossimi)
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productPriceKg').value = '';
        document.getElementById('productNotes').value = '';
      });

      clearCartBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (!confirm('Svuotare il carrello?')) return;
        app.clearCart();
      });

      // salva spesa completa
      document.getElementById('expenseForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const store = (document.getElementById('storeSelect')?.value || '').trim();
        const date = (document.getElementById('expenseDate')?.value || '').trim();
        if (!store) { alert('Seleziona un supermercato'); return; }
        if (!date) { alert('Inserisci la data'); return; }
        if (!app.currentCart || app.currentCart.length === 0) { alert('Il carrello √® vuoto'); return; }
        app.saveCartAsExpense(store, date);
        alert('Spesa salvata con successo.');
        // reset form and UI
        document.getElementById('storeSelect').value = '';
        document.getElementById('expenseDate').value = '';
        app.setLastScannedImage(null);
      });

      // initial render (cart potrebbe essere vuoto)
      renderCart(app.currentCart);
    });
  </script>

  <!-- bottom navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a class="nav-item" href="index.html" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a class="nav-item nav-active" href="aggiungi.html" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a class="nav-item" href="archivio.html" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a class="nav-item" href="impostazioni.html" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>
</body>
</html>