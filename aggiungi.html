<!DOCTYPE html>

<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggiungi Spesa</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#4CAF50">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üõçÔ∏è Aggiungi Spesa</h1>
        <nav>
            <a href="index.html">Dashboard</a>
            <a href="aggiungi.html" class="nav-active">Aggiungi</a>
            <a href="archivio.html">Archivio</a>
        </nav>
    </header>

```
<main class="add-expense">
    <form id="expenseForm" class="expense-form">
        <div class="form-section">
            <h2>üè™ Informazioni Generali</h2>
            
            <div class="form-group">
                <label for="storeSelect">Supermercato:</label>
                <select id="storeSelect" required>
                    <option value="">Seleziona supermercato</option>
                    <option value="Conad">Conad</option>
                    <option value="Coop">Coop</option>
                    <option value="Esselunga">Esselunga</option>
                    <option value="Eurospin">Eurospin</option>
                    <option value="Carrefour">Carrefour</option>
                    <option value="Lidl">Lidl</option>
                    <option value="MD">MD</option>
                    <option value="Pam">Pam</option>
                    <option value="Simply">Simply</option>
                    <option value="Iper">Iper</option>
                    <option value="Altro">Altro (specificare sotto)</option>
                </select>
            </div>

            <div class="form-group" id="customStoreGroup" style="display: none;">
                <label for="customStore">Nome supermercato:</label>
                <input type="text" id="customStore" placeholder="Inserisci nome supermercato">
            </div>

            <div class="form-group">
                <label for="expenseDate">Data:</label>
                <input type="date" id="expenseDate" required>
            </div>
        </div>

        <div class="form-section">
            <h2>üõí Aggiungi Prodotti</h2>
            
            <div class="product-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="productCategory">Tipologia:</label>
                        <select id="productCategory" required>
                            <option value="">Seleziona tipologia</option>
                            <option value="Carne">ü•© Carne</option>
                            <option value="Pesce">üêü Pesce</option>
                            <option value="Verdura">ü•¨ Verdura</option>
                            <option value="Frutta">üçé Frutta</option>
                            <option value="Latticini">üßÄ Latticini</option>
                            <option value="Pane">üçû Pane e Cereali</option>
                            <option value="Bevande">ü•§ Bevande</option>
                            <option value="Surgelati">üßä Surgelati</option>
                            <option value="Dolci">üç∞ Dolci</option>
                            <option value="Pulizia">üßΩ Prodotti Pulizia</option>
                            <option value="Igiene">üß¥ Igiene Personale</option>
                            <option value="Altro">üì¶ Altro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productName">Nome prodotto:</label>
                        <input type="text" id="productName" placeholder="Es. Pomodori" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productPrice">Prezzo (‚Ç¨):</label>
                        <input type="number" id="productPrice" step="0.01" min="0" placeholder="0.00" required>
                    </div>

                    <div class="form-group">
                        <label for="productPriceKg">Prezzo/kg (‚Ç¨):</label>
                        <input type="number" id="productPriceKg" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="productNotes">Note:</label>
                    <input type="text" id="productNotes" placeholder="Note aggiuntive (opzionale)">
                </div>

                <button type="button" id="addProductBtn" class="btn btn-secondary">
                    ‚ûï Aggiungi Prodotto al Carrello
                </button>
            </div>
        </div>

        <div class="cart-section" id="cartSection" style="display: none;">
            <h2>üõí Carrello</h2>
            <div class="cart-table-container">
                <table id="cartTable">
                    <thead>
                        <tr>
                            <th>Prodotto</th>
                            <th>Prezzo</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="cartBody">
                    </tbody>
                </table>
            </div>
            <div class="cart-total">
                <strong>Totale: ‚Ç¨<span id="cartTotal">0.00</span></strong>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" id="saveExpenseBtn" class="btn btn-primary" disabled>
                üíæ Salva Spesa Completa
            </button>
            <button type="button" id="clearCartBtn" class="btn btn-danger">
                üóëÔ∏è Svuota Carrello
            </button>
        </div>
    </form>
</main>

<!-- JavaScript incorporato -->
<script>
    // Gestione spese - App principale
    class ExpenseTracker {
        constructor() {
            this.expenses = this.loadExpenses();
            this.currentCart = [];
            this.deleteExpenseId = null;
        }

        loadExpenses() {
            const stored = localStorage.getItem('expenses');
            return stored ? JSON.parse(stored) : [];
        }

        saveExpenses() {
            localStorage.setItem('expenses', JSON.stringify(this.expenses));
        }

        generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        addExpense(store, date, products) {
            const expense = {
                id: this.generateId(),
                store,
                date,
                products: [...products],
                total: products.reduce((sum, p) => sum + parseFloat(p.price || 0), 0),
                createdAt: new Date().toISOString()
            };
            
            this.expenses.push(expense);
            this.saveExpenses();
            return expense;
        }

        formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount || 0);
        }

        formatDate(dateString) {
            return new Intl.DateTimeFormat('it-IT', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }).format(new Date(dateString));
        }

        filterByPeriod(period) {
            const now = new Date();
            const startDate = new Date();

            switch(period) {
                case 'settimana':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'mese':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'anno':
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
                default:
                    return this.expenses;
            }

            return this.expenses.filter(expense => 
                new Date(expense.date) >= startDate
            );
        }

        getStats(expenses = this.expenses) {
            if (!expenses.length) {
                return {
                    total: 0,
                    count: 0,
                    max: { amount: 0, store: '' },
                    min: { amount: 0, store: '' },
                    avgPerExpense: 0,
                    storeStats: {},
                    categoryStats: {}
                };
            }

            const total = expenses.reduce((sum, exp) => sum + exp.total, 0);
            const amounts = expenses.map(exp => exp.total);
            const maxAmount = Math.max(...amounts);
            const minAmount = Math.min(...amounts);
            
            const maxExpense = expenses.find(exp => exp.total === maxAmount);
            const minExpense = expenses.find(exp => exp.total === minAmount);

            // Statistiche per supermercato
            const storeStats = {};
            expenses.forEach(expense => {
                if (!storeStats[expense.store]) {
                    storeStats[expense.store] = { count: 0, total: 0 };
                }
                storeStats[expense.store].count++;
                storeStats[expense.store].total += expense.total;
            });

            // Statistiche per categoria
            const categoryStats = {};
            expenses.forEach(expense => {
                expense.products.forEach(product => {
                    if (!categoryStats[product.category]) {
                        categoryStats[product.category] = { count: 0, total: 0 };
                    }
                    categoryStats[product.category].count++;
                    categoryStats[product.category].total += parseFloat(product.price || 0);
                });
            });

            return {
                total,
                count: expenses.length,
                max: { amount: maxAmount, store: maxExpense.store },
                min: { amount: minAmount, store: minExpense.store },
                avgPerExpense: total / expenses.length,
                storeStats,
                categoryStats
            };
        }
    }

    // Istanza globale
    const app = new ExpenseTracker();

    // Funzione helper per escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    function addProductToCart() {
        // Ottieni elementi
        const categoryEl = document.getElementById('productCategory');
        const nameEl = document.getElementById('productName');
        const priceEl = document.getElementById('productPrice');
        const priceKgEl = document.getElementById('productPriceKg');
        const notesEl = document.getElementById('productNotes');

        if (!categoryEl || !nameEl || !priceEl) {
            alert('‚ùå Errore: elementi del form non trovati');
            return;
        }

        // Ottieni valori
        const category = categoryEl.value ? categoryEl.value.trim() : '';
        const name = nameEl.value ? nameEl.value.trim() : '';
        const priceValue = priceEl.value ? priceEl.value.trim() : '';
        const price = parseFloat(priceValue);
        const priceKg = priceKgEl ? (parseFloat(priceKgEl.value) || null) : null;
        const notes = notesEl ? (notesEl.value ? notesEl.value.trim() : '') : '';

        // Validazione
        if (!category) {
            alert('‚ö†Ô∏è Seleziona una tipologia di prodotto');
            categoryEl.focus();
            return;
        }

        if (!name) {
            alert('‚ö†Ô∏è Inserisci il nome del prodotto');
            nameEl.focus();
            return;
        }

        if (!priceValue || isNaN(price) || price <= 0) {
            alert('‚ö†Ô∏è Inserisci un prezzo valido maggiore di 0');
            priceEl.focus();
            return;
        }

        // Crea prodotto
        const product = {
            id: app.generateId(),
            category,
            name,
            price: price,
            priceKg: priceKg,
            notes: notes
        };

        // Aggiungi al carrello
        app.currentCart.push(product);

        // Aggiorna display
        updateCartDisplay();
        clearProductForm();
        
        // Feedback visivo
        const addBtn = document.getElementById('addProductBtn');
        if (addBtn) {
            addBtn.classList.add('pulse');
            setTimeout(() => addBtn.classList.remove('pulse'), 300);
        }

        // Scroll al carrello se √® la prima aggiunta
        if (app.currentCart.length === 1) {
            const cartSection = document.getElementById('cartSection');
            if (cartSection) {
                cartSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }

    function updateCartDisplay() {
        const cartSection = document.getElementById('cartSection');
        const cartBody = document.getElementById('cartBody');
        const cartTotal = document.getElementById('cartTotal');
        const saveBtn = document.getElementById('saveExpenseBtn');

        if (!cartSection || !cartBody || !cartTotal || !saveBtn) return;

        if (app.currentCart.length === 0) {
            cartSection.style.display = 'none';
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.5';
            return;
        }

        cartSection.style.display = 'block';
        saveBtn.disabled = false;
        saveBtn.style.opacity = '1';

        // Aggiorna tabella prodotti
        cartBody.innerHTML = app.currentCart.map(product => `
            <tr>
                <td>
                    <strong>${escapeHtml(product.name)}</strong><br>
                    <small style="color: #666;">${escapeHtml(product.category)}</small>
                    ${product.notes ? `<br><small style="color: #888;">üìù ${escapeHtml(product.notes)}</small>` : ''}
                    ${product.priceKg ? `<br><small style="color: #666;">üí∞ ${app.formatCurrency(product.priceKg)}/kg</small>` : ''}
                </td>
                <td><strong>${app.formatCurrency(product.price)}</strong></td>
                <td>
                    <button type="button" class="remove-btn" onclick="removeFromCart('${product.id}')" title="Rimuovi prodotto">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `).join('');

        // Aggiorna totale
        const total = app.currentCart.reduce((sum, product) => sum + product.price, 0);
        cartTotal.textContent = app.formatCurrency(total);

        // Aggiungi animazione fade-in
        cartSection.classList.add('fade-in');
    }

    function clearProductForm() {
        document.getElementById('productCategory').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        if (document.getElementById('productPriceKg')) document.getElementById('productPriceKg').value = '';
        if (document.getElementById('productNotes')) document.getElementById('productNotes').value = '';
    }

    function toggleCustomStore() {
        const storeSelect = document.getElementById('storeSelect');
        const customStoreGroup = document.getElementById('customStoreGroup');
        
        if (storeSelect && customStoreGroup) {
            if (storeSelect.value === 'Altro') {
                customStoreGroup.style.display = 'block';
                document.getElementById('customStore').required = true;
            } else {
                customStoreGroup.style.display = 'none';
                document.getElementById('customStore').required = false;
            }
        }
    }

    function removeFromCart(productId) {
        app.currentCart = app.currentCart.filter(product => product.id !== productId);
        updateCartDisplay();
    }

    function clearCart() {
        if (app.currentCart.length === 0) return;
        
        if (confirm('üóëÔ∏è Sei sicuro di voler svuotare il carrello?')) {
            app.currentCart = [];
            updateCartDisplay();
        }
    }

    function saveExpense() {
        const storeSelect = document.getElementById('storeSelect');
        const customStore = document.getElementById('customStore');
        const expenseDate = document.getElementById('expenseDate');

        if (!storeSelect || !expenseDate) return;

        const store = storeSelect.value === 'Altro' ? customStore.value : storeSelect.value;
        const date = expenseDate.value;

        // Validazione
        if (!store || !date || app.currentCart.length === 0) {
            alert('‚ö†Ô∏è Compila tutti i campi e aggiungi almeno un prodotto');
            return;
        }

        try {
            app.addExpense(store, date, app.currentCart);
            
            // Feedback successo
            alert('‚úÖ Spesa salvata con successo!');
            
            // Reset form
            document.getElementById('expenseForm').reset();
            app.currentCart = [];
            updateCartDisplay();
            toggleCustomStore();
            
            // Imposta data odierna
            const today = new Date().toISOString().split('T')[0];
            expenseDate.value = today;
            
        } catch (error) {
            console.error('Errore nel salvare la spesa:', error);
            alert('‚ùå Errore nel salvare la spesa. Riprova.');
        }
    }

    // Inizializzazione
    document.addEventListener('DOMContentLoaded', function() {
        // Imposta data odierna
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('expenseDate').value = today;
        
        // Event listeners
        document.getElementById('storeSelect').addEventListener('change', toggleCustomStore);
        
        document.getElementById('addProductBtn').addEventListener('click', function(e) {
            e.preventDefault();
            addProductToCart();
        });

        document.getElementById('saveExpenseBtn').addEventListener('click', function(e) {
            e.preventDefault();
            saveExpense();
        });

        document.getElementById('clearCartBtn').addEventListener('click', function(e) {
            e.preventDefault();
            clearCart();
        });

        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveExpense();
        });

        // Reset carrello
        app.currentCart = [];
        updateCartDisplay();
    });
</script>
```

</body>
</html>