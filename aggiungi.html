<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggiungi Spesa — GroceryHub</title>

  <!-- Manifest / PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#ffffff" />

  <!-- Font Awesome (icone) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">

  <!-- Stili unificati -->
  <link rel="stylesheet" href="style.css?v=20250816" />

  <!-- Stili specifici per store-choice e nuove regole -->
  <style>
    /* Grid store cards */
    .store-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .store-card {
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: var(--panel);
      cursor: pointer;
      text-align:left;
      transition: transform .12s ease, box-shadow .14s ease, background .12s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,0.04);
      width:100%;
    }
    .store-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.06); }
    .store-card.selected {
      background: var(--gh-salvia);
      color: #fff;
      border-color: rgba(0,0,0,0.04);
      box-shadow: 0 12px 38px rgba(122,169,134,0.14);
    }
    .store-card .store-logo {
      width:64px; height:64px; object-fit:contain; border-radius:8px; background:transparent;
      flex:0 0 64px;
      border: none;
    }
    .store-card .store-card-body { flex:1; min-width:0; }
    .store-card .store-card-title { font-weight:700; color:var(--gh-text-strong); }
    .store-card.selected .store-card-title { color: #fff; }
    .store-card .store-card-desc { color:var(--gh-muted); font-size:0.92rem; margin-top:4px; }
    .store-card.selected .store-card-desc { color: rgba(255,255,255,0.9); }

    /* cart empty placeholder after confirming store */
    #cartMainPlaceholder {
      display:none;
      gap:12px;
      align-items:center;
      padding:18px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--panel);
      box-shadow: 0 12px 28px rgba(0,0,0,0.04);
      margin-bottom:16px;
    }
    #cartMainPlaceholder .title-row {
      display:flex; align-items:center; gap:12px;
    }
    .cart-icon-circle {
      width:56px; height:56px; border-radius:999px; display:flex; align-items:center; justify-content:center; background:var(--gh-salvia); color:#fff; flex:0 0 56px;
    }
    .cart-empty-note { color:var(--gh-muted); font-style:italic; margin-top:8px; }

    /* hide floating buttons while selecting store (JS toggles .hidden class) */
    .floating-btn { position: fixed; z-index:2200; border:none; background:var(--gh-salvia); color:#fff; width:56px; height:56px; border-radius:999px; display:flex; align-items:center; justify-content:center; box-shadow:0 12px 30px rgba(0,0,0,0.12); }
    .floating-left { left:18px; bottom:110px; }
    .floating-right { right:18px; bottom:110px; }
    .floating-btn.hidden { display:none !important; }

    /* Conferma: stato disabled (grigio) */
    #confirmStoreBtn:disabled,
    #confirmStoreBtn[aria-disabled="true"] {
      background: #f3f4f5 !important;
      color: #8a8f94 !important;
      border: 1px solid rgba(0,0,0,0.04) !important;
      cursor: not-allowed !important;
      box-shadow: none !important;
      opacity: 1 !important;
    }

    /* Drawer bottom-sheet centrato e responsive */
    .add-product-drawer {
      position:fixed !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      bottom: 16px !important;
      width: calc(100% - 32px) !important;
      max-width: 720px !important;
      border-top-left-radius: 12px !important;
      border-top-right-radius: 12px !important;
      box-shadow: 0 -12px 40px rgba(0,0,0,0.12) !important;
      padding: 12px !important;
      max-height: 78vh !important;
      overflow: auto !important;
      z-index: 3600 !important;
      pointer-events: auto !important;
      background: var(--panel);
    }
    .add-product-drawer .drawer-header { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:6px 6px 12px 6px; }
    .add-product-drawer .drawer-body { padding:4px 6px 12px 6px; }
    .menu-overlay.visible { display:block; opacity:1; }

    /* small table tweaks */
    #cartTable td, #cartTable th { padding:10px 8px; vertical-align:middle; }
    .cart-product-name { font-weight:600; }
    .cart-product-meta { color:var(--gh-muted); font-size:0.9rem; }
    .cart-remove-btn { background:transparent; border:none; color:var(--gh-danger); cursor:pointer; font-size:1rem; padding:6px; }
    .cart-thumb { width:48px; height:48px; object-fit:cover; border-radius:6px; border:1px solid rgba(0,0,0,0.04); }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="hamburger" id="menuToggle" aria-label="Apri menu" title="Apri menu">
      <i class="fa-solid fa-bars"></i>
    </div>

    <div class="title-wrap" role="banner">
      <div class="title-row" aria-hidden="true">
        <h1 class="groceryhub">Grocery<span class="hub">Hub</span></h1>
      </div>
      <div class="payoff">Controlla, risparmia, vivi meglio</div>
    </div>
  </header>

  <!-- Reduced side menu (niente supermercati/versione) -->
  <nav id="sideMenu" class="hidden" aria-hidden="true">
    <div class="menu-header">
      <div class="menu-logo">GH</div>
      <div>
        <div style="font-weight:800;">GroceryHub</div>
        <div style="font-size:0.9rem;color:var(--gh-muted)">La tua gestione spese</div>
      </div>
    </div>

    <div class="menu-section">
      <div style="font-size:0.95rem;font-weight:700;margin-bottom:8px;">Navigazione</div>
      <a href="index.html"><i class="fa-solid fa-house" style="width:18px;margin-right:8px;"></i> Dashboard</a>
      <a href="aggiungi.html"><i class="fa-solid fa-plus" style="width:18px;margin-right:8px;"></i> Aggiungi spesa</a>
      <a href="archivio.html"><i class="fa-solid fa-archive" style="width:18px;margin-right:8px;"></i> Archivio</a>
      <a href="impostazioni.html"><i class="fa-solid fa-gear" style="width:18px;margin-right:8px;"></i> Impostazioni</a>
    </div>
  </nav>

  <!-- overlay for side menu & drawer -->
  <div id="menuOverlay" class="menu-overlay" tabindex="-1" aria-hidden="true"></div>

  <main class="dashboard add-expense" role="main" aria-live="polite">
    <!-- STORE CHOICE CARD -->
    <section id="storeChoiceCard" class="panel store-choice-card" aria-labelledby="storeChoiceTitle">
      <div class="section-header">
        <span class="icon-circle" aria-hidden="true"><i class="fa-solid fa-store"></i></span>
        <div class="title-lines">
          <h2 id="storeChoiceTitle">Aggiungi nuova spesa</h2>
          <div class="subtitle">Scegli il supermercato per iniziare</div>
        </div>
      </div>

      <div id="storeListGrid" class="store-list-grid" role="list" aria-label="Elenco supermercati">
        <!-- JS popola le store-card qui -->
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
        <button id="confirmStoreBtn" class="btn" disabled aria-disabled="true">✔️ Conferma</button>
      </div>
    </section>

    <!-- After confirm: empty cart placeholder (visible only after confirm and when cart empty) -->
    <section id="cartMainPlaceholder" aria-hidden="true">
      <div class="title-row">
        <div class="cart-icon-circle" aria-hidden="true"><i class="fa-solid fa-cart-shopping" style="font-size:20px"></i></div>
        <div>
          <div style="font-weight:700;font-size:1.06rem;">Il tuo carrello</div>
          <div class="cart-empty-note"><em>Nessun prodotto nel carrello</em></div>
        </div>
      </div>
    </section>

    <!-- Hidden original form and cart (will appear when user adds product) -->
    <form id="expenseForm" class="expense-form hidden" novalidate>
      <!-- detailed form as before (kept hidden until products exist) -->
      <section class="form-section panel" aria-labelledby="info-header">
        <div class="section-header" id="info-header">
          <span class="icon-circle" aria-hidden="true"><i class="fa-solid fa-store"></i></span>
          <div class="title-lines">
            <h2>Informazioni Generali</h2>
            <div class="subtitle">Dati della spesa</div>
          </div>
        </div>

        <div class="form-group">
          <label for="storeSelect">Supermercato</label>
          <select id="storeSelect" class="store-select" required></select>
        </div>

        <div class="form-group" id="customStoreGroup" aria-hidden="true" hidden>
          <label for="customStore">Nome supermercato</label>
          <input type="text" id="customStore" placeholder="Inserisci nome supermercato" />
        </div>

        <div class="form-group">
          <label for="expenseDate">Data</label>
          <input type="date" id="expenseDate" required />
        </div>
      </section>

      <!-- product area (we will show cartSection separately) -->
      <section class="cart-section panel hidden" id="cartSection" aria-hidden="true">
        <div class="section-header">
          <span style="width:44px;"></span>
          <div class="title-lines">
            <h2>Carrello</h2>
            <div class="subtitle">Riepilogo dei prodotti</div>
          </div>
        </div>

        <div class="cart-table-container">
          <table id="cartTable">
            <thead>
              <tr><th>Prodotto</th><th>Prezzo</th><th>Azioni</th></tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>
        </div>
        <div class="cart-total"><strong>Totale: <span id="cartTotal">€0.00</span></strong></div>
      </section>

      <section class="form-actions" style="margin-top:12px;display:flex;gap:10px;">
        <button type="submit" id="saveExpenseBtn" class="btn" disabled>💾 Salva Spesa Completa</button>
        <button type="button" id="clearCartBtn" class="btn btn-danger">🗑️ Svuota Carrello</button>
      </section>
    </form>
  </main>

  <!-- Drawer: add product (bottom sheet) -->
  <div id="drawerOverlay" class="menu-overlay" aria-hidden="true"></div>
  <div id="addProductDrawer" class="add-product-drawer hidden" role="dialog" aria-hidden="true" aria-labelledby="drawerTitle">
    <div class="drawer-header">
      <div id="drawerTitle" style="font-weight:700;font-size:1rem;">Aggiungi prodotto</div>
      <button id="closeDrawerBtn" class="btn btn-secondary" aria-label="Chiudi">Chiudi</button>
    </div>
    <div class="drawer-body">
      <div class="form-group">
        <label for="drawerProductName">Nome prodotto</label>
        <input id="drawerProductName" type="text" />
      </div>
      <div class="form-group">
        <label for="drawerProductCategory">Categoria</label>
        <select id="drawerProductCategory">
          <option value="">Seleziona tipologia</option>
          <option>Carne</option><option>Pesce</option><option>Verdura</option><option>Frutta</option>
          <option>Latticini</option><option>Pane</option><option>Bevande</option><option>Altro</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label for="drawerProductPrice">Prezzo (€)</label>
          <input id="drawerProductPrice" type="number" step="0.01" inputmode="decimal" />
        </div>
        <div class="form-group" style="flex:1">
          <label for="drawerProductPriceKg">Prezzo/kg (€)</label>
          <input id="drawerProductPriceKg" type="number" step="0.01" inputmode="decimal" />
        </div>
      </div>
      <div class="form-group">
        <label for="drawerProductNotes">Note</label>
        <input id="drawerProductNotes" type="text" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button id="drawerAddBtn" class="btn">Aggiungi al carrello</button>
      </div>
    </div>
  </div>

  <!-- Scanner modal -->
  <div id="scannerModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h3>📷 Scansione Codice a Barre</h3>
      <p class="scanner-instructions">Inquadra il codice a barre con la fotocamera. L'app proverà a recuperare i dati da Open Food Facts.</p>

      <div id="scannerContainer" aria-live="polite">
        <video id="scannerVideo" autoplay playsinline muted></video>
        <div id="scannerOverlay" aria-hidden="true">
          <div class="scan-line" aria-hidden="true"></div>
        </div>
      </div>

      <a class="openfood-link" href="https://world.openfoodfacts.org" target="_blank" rel="noopener">🔎 Cerca manualmente su Open Food Facts</a>

      <div class="scanner-actions">
        <div class="left">
          <div id="deviceLabel" class="device-label" aria-live="polite"></div>
        </div>
        <div class="right">
          <button id="switchCameraBtn" class="btn btn-secondary small-btn">🔁 Cambia Camera</button>
          <button id="scannerCancelBtn" class="btn btn-secondary">Annulla</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" aria-hidden="true"></div>

  <!-- app core -->
  <script src="app.js"></script>
  <!-- ZXing (scanner lib) -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>

  <!-- Minimal ZXing wrapper: openScannerModal / closeScannerModal / switchCamera (robust) -->
  <script>
  (function(){
    let codeReader = null;
    let availableVideoDevices = [];
    let currentDeviceIndex = -1;
    let isScannerOpen = false;
    let barcodeHandled = false;

    // find the correct global for ZXing Browser class
    function getZXingNamespace() {
      if (window.ZXingBrowser) return window.ZXingBrowser;
      if (window.ZXing) return window.ZXing;
      // UMD sometimes exposes BrowserMultiFormatReader directly
      if (window.BrowserMultiFormatReader) return { BrowserMultiFormatReader: window.BrowserMultiFormatReader };
      return null;
    }

    function updateDeviceLabel(text) {
      const lab = document.getElementById('deviceLabel');
      if (lab) lab.textContent = text || '';
    }

    async function stopScanner() {
      if (codeReader && typeof codeReader.reset === 'function') {
        try { await codeReader.reset(); } catch(e){ /* ignore */ }
      }
      const v = document.getElementById('scannerVideo');
      if (v && v.srcObject) {
        try {
          v.srcObject.getTracks().forEach(t => { try{ t.stop(); }catch(e){} });
        } catch(e){}
        v.srcObject = null;
      }
      try { if (v) v.pause(); } catch(e){}
      codeReader = null;
      isScannerOpen = false;
      barcodeHandled = false;
      updateDeviceLabel('');
    }

    async function prepareDevicesAndChoosePreferred() {
      // Try to request permission to populate device labels
      try {
        await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } })
          .then(s => { s.getTracks().forEach(t => t.stop()); })
          .catch(()=>{});
      } catch(e){}
      const devices = await navigator.mediaDevices.enumerateDevices();
      availableVideoDevices = devices.filter(d => d.kind === 'videoinput').map(d => ({ deviceId: d.deviceId, label: d.label || 'Camera' }));
      let idx = availableVideoDevices.findIndex(d => /back|rear|environment|posteriore/gi.test(d.label));
      if (idx === -1) idx = (availableVideoDevices.length > 0 ? 0 : -1);
      currentDeviceIndex = idx;
      return currentDeviceIndex;
    }

    async function openScannerModal() {
      const modal = document.getElementById('scannerModal');
      if (modal) { modal.classList.remove('hidden'); modal.removeAttribute('aria-hidden'); }
      isScannerOpen = true;
      barcodeHandled = false;

      const ns = getZXingNamespace();
      if (!ns || !ns.BrowserMultiFormatReader) {
        console.error('ZXing library not found');
        alert('Scanner non disponibile (libreria mancante).');
        closeScannerModal();
        return;
      }

      try {
        codeReader = new ns.BrowserMultiFormatReader();
      } catch (e) {
        console.error('ZXing init error', e);
        alert('Scanner non disponibile in questo dispositivo.');
        closeScannerModal();
        return;
      }

      try {
        const chosenIndex = await prepareDevicesAndChoosePreferred();
        if (chosenIndex === -1) { alert('Nessuna videocamera disponibile.'); closeScannerModal(); return; }
        const chosen = availableVideoDevices[chosenIndex];
        updateDeviceLabel('Camera: ' + (chosen.label || 'Sconosciuta'));

        const videoElem = document.getElementById('scannerVideo');
        await codeReader.decodeFromVideoDevice(chosen.deviceId, videoElem, (result, err) => {
          if (result && result.getText) {
            const code = (result.getText ? result.getText() : (result.text || '')).trim();
            handleBarcodeFound(code);
          }
        });
      } catch (err) {
        console.error('Camera/Scanner error', err);
        alert('Impossibile avviare lo scanner. Controlla i permessi o riprova.');
        closeScannerModal();
      }
    }

    async function closeScannerModal() {
      const modal = document.getElementById('scannerModal');
      try { await stopScanner(); } catch(e){}
      if (modal) { modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); }
    }

    async function switchCamera() {
      if (!isScannerOpen) return;
      if (!availableVideoDevices || availableVideoDevices.length <= 1) {
        alert('Nessun altra camera disponibile.');
        return;
      }
      try { await stopScanner(); } catch(e){}
      currentDeviceIndex = (currentDeviceIndex + 1) % availableVideoDevices.length;
      const chosen = availableVideoDevices[currentDeviceIndex];
      updateDeviceLabel('Camera: ' + (chosen.label || 'Sconosciuta'));
      try {
        const ns = getZXingNamespace();
        if (!ns || !ns.BrowserMultiFormatReader) { alert('Errore con la libreria scanner.'); return; }
        codeReader = new ns.BrowserMultiFormatReader();
        const videoElem = document.getElementById('scannerVideo');
        await codeReader.decodeFromVideoDevice(chosen.deviceId, videoElem, (result, err) => {
          if (result && result.getText) {
            const code = (result.getText ? result.getText() : (result.text || '')).trim();
            handleBarcodeFound(code);
          }
        });
      } catch (err) {
        console.error('Errore switching camera', err);
        alert('Errore cambio camera.');
        await stopScanner();
      }
    }

    async function handleBarcodeFound(barcode) {
      if (!barcode || barcodeHandled) return;
      barcodeHandled = true;
      const toast = document.getElementById('toast');
      if (toast) { toast.textContent = 'Codice rilevato: ' + barcode; toast.style.display = 'block'; setTimeout(()=>toast.style.display='none',1400); }

      try { if (window.app && typeof app.setLastScannedBarcode === 'function') app.setLastScannedBarcode(barcode); } catch(e){}

      try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(barcode)}.json`);
        if (res.ok) {
          const json = await res.json();
          if (json && json.status === 1 && json.product) {
            const p = json.product;
            const nameField = document.getElementById('drawerProductName') || document.getElementById('productName');
            const notesField = document.getElementById('drawerProductNotes') || document.getElementById('productNotes');
            const categoryField = document.getElementById('drawerProductCategory') || document.getElementById('productCategory');

            const prodName = p.product_name || p.generic_name || p.brands || '';
            if (nameField && prodName) nameField.value = prodName;

            let noteParts = [];
            if (p.brands) noteParts.push(p.brands);
            if (p.quantity) noteParts.push(p.quantity);
            if (p.categories) noteParts.push(p.categories.split(',').slice(0,2).join(' • '));
            if (notesField && noteParts.length) notesField.value = noteParts.join(' • ');

            if (categoryField && Array.isArray(p.categories_tags) && p.categories_tags.length) {
              const tag = p.categories_tags[0] || '';
              const human = (p.categories || '').split(',')[0] || tag.replace('en:', '').replace(/-/g,' ');
              Array.from(categoryField.options).forEach(o => {
                if (human && o.value && o.value.toLowerCase().includes(human.toLowerCase())) {
                  categoryField.value = o.value;
                }
              });
            }

            const imageCandidates = [p.image_front_small_url, p.image_front_thumb_url, p.image_small_url, p.image_url, p.image_front_url].filter(Boolean);
            const chosenImage = imageCandidates.length ? imageCandidates[0] : null;
            try { if (chosenImage && window.app && typeof app.setLastScannedImage === 'function') app.setLastScannedImage(chosenImage); } catch(e){}
          }
        }
      } catch (err) {
        console.warn('OFF fetch error', err);
      } finally {
        setTimeout(async ()=> { await closeScannerModal(); barcodeHandled = false; }, 700);
      }
    }

    // export globals
    window.openScannerModal = openScannerModal;
    window.closeScannerModal = closeScannerModal;
    window.switchCamera = switchCamera;
  })();
  </script>

  <!-- bottom navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a class="nav-item" href="index.html" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a class="nav-item nav-active" href="aggiungi.html" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a class="nav-item" href="archivio.html" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a class="nav-item" href="impostazioni.html" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <!-- floating action buttons -->
  <button id="floatingCameraBtn" class="floating-btn floating-left" aria-label="Apri fotocamera"><i class="fa-solid fa-camera"></i></button>
  <button id="floatingAddBtn" class="floating-btn floating-right" aria-label="Aggiungi prodotto"><i class="fa-solid fa-plus"></i></button>

  <!-- Script: behavior -->
  <script>
    // helper escape
    function escapeHtml(txt){ const d = document.createElement('div'); d.textContent = txt || ''; return d.innerHTML; }

    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const storeListGrid = document.getElementById('storeListGrid');
      const confirmBtn = document.getElementById('confirmStoreBtn');
      const storeChoiceCard = document.getElementById('storeChoiceCard');
      const expenseForm = document.getElementById('expenseForm');
      const cartMainPlaceholder = document.getElementById('cartMainPlaceholder');
      const floatingAddBtn = document.getElementById('floatingAddBtn');
      const floatingCameraBtn = document.getElementById('floatingCameraBtn');
      const drawer = document.getElementById('addProductDrawer');
      const drawerOverlay = document.getElementById('drawerOverlay');
      const closeDrawerBtn = document.getElementById('closeDrawerBtn');
      const drawerAddBtn = document.getElementById('drawerAddBtn');

      function hideFloating() {
        floatingAddBtn.classList.add('hidden');
        floatingCameraBtn.classList.add('hidden');
      }
      function showFloating() {
        floatingAddBtn.classList.remove('hidden');
        floatingCameraBtn.classList.remove('hidden');
      }

      // start with floating hidden because storeChoiceCard is visible
      hideFloating();

      const logoMap = {
        "Conad": "conad.it",
        "Coop": "coop.it",
        "Esselunga": "esselunga.it",
        "Eurospin": "eurospin.it",
        "Carrefour": "carrefour.it",
        "Lidl": "lidl.it",
        "MD": "mdspa.it",
        "Pam": "pam.it",
        "Simply": "simplymarket.it",
        "Iper": "iper.it"
      };

      const descriptions = {
        "Conad": "Catena presente capillarmente in Italia, ideale per prodotti freschi e offerte locali.",
        "Coop": "Coop punta su qualità e sostenibilità, con un'ampia selezione di prodotti biologici.",
        "Esselunga": "Esselunga offre grandi reparti freschi e numerose promozioni settimanali.",
        "Eurospin": "Discount concentrato sul prezzo: ottime offerte su prodotti essenziali.",
        "Carrefour": "Supermercati e ipermercati con vasta scelta e marchi internazionali.",
        "Lidl": "Discount europeo con prodotti a marchio e offerte settimanali competitive.",
        "MD": "Catena discount con assortimento conveniente e offerte locali frequenti.",
        "Pam": "Supermercati focalizzati su freschi e prodotti regionali, utile per la spesa quotidiana.",
        "Simply": "Punto vendita con offerta pratica per la spesa di tutti i giorni.",
        "Iper": "Ipermercati con grande assortimento e reparti specializzati."
      };

      let selectedStore = null;

      function placeholderSVG(name, diameter=64) {
        const initials = (name || '').split(' ').slice(0,2).map(s => s[0]?.toUpperCase()||'').join('');
        const bg = getComputedStyle(document.documentElement).getPropertyValue('--gh-salvia') || '#7aa986';
        const fg = '#fff';
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${diameter}" height="${diameter}"><rect width="100%" height="100%" rx="10" fill="${bg}"/><text x="50%" y="50%" font-family="Arial, Helvetica, sans-serif" font-size="${Math.round(diameter/2.6)}" fill="${fg}" dominant-baseline="middle" text-anchor="middle">${initials}</text></svg>`);
        return `data:image/svg+xml;utf8,${svg}`;
      }

      function describeFor(name) {
        return descriptions[name] || `Ampia scelta di prodotti e offerte presso ${name}.`;
      }

      function renderStoreCards() {
        storeListGrid.innerHTML = '';
        const stores = (typeof app?.getStores === 'function') ? app.getStores() : Object.keys(logoMap);
        const finalStores = (stores && stores.length) ? stores : Object.keys(logoMap);

        finalStores.forEach(sName => {
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'store-card';
          card.setAttribute('role','listitem');

          const domain = logoMap[sName] || '';
          const clearbitUrl = domain ? `https://logo.clearbit.com/${domain}?size=128` : '';
          const imgSrc = clearbitUrl || placeholderSVG(sName,64);

          card.innerHTML = `
            <div class="store-card-left">
              <img class="store-logo" src="${imgSrc}" alt="${escapeHtml(sName)} logo" />
            </div>
            <div class="store-card-body">
              <div class="store-card-title">${escapeHtml(sName)}</div>
              <div class="store-card-desc"><em>${escapeHtml(describeFor(sName))}</em></div>
            </div>
          `;

          const imgEl = card.querySelector('img.store-logo');
          if (imgEl) {
            imgEl.addEventListener('error', () => { imgEl.src = placeholderSVG(sName,64); });
          }

          card.addEventListener('click', () => {
            document.querySelectorAll('.store-card.selected').forEach(el => el.classList.remove('selected'));
            card.classList.add('selected');
            selectedStore = sName;
            confirmBtn.disabled = false;
            confirmBtn.removeAttribute('aria-disabled');
          });

          storeListGrid.appendChild(card);
        });
      }

      // call initially
      renderStoreCards();
      document.addEventListener('app:stores-changed', renderStoreCards);

      // ensure confirm starts disabled
      confirmBtn.disabled = true;
      confirmBtn.setAttribute('aria-disabled','true');

      if (confirmBtn) {
        const mo = new MutationObserver(() => {
          if (confirmBtn.disabled) confirmBtn.setAttribute('aria-disabled','true');
          else confirmBtn.removeAttribute('aria-disabled');
        });
        mo.observe(confirmBtn, { attributes: true, attributeFilter: ['disabled'] });
        if (confirmBtn.disabled) confirmBtn.setAttribute('aria-disabled','true');
      }

      // confirm selection behaviour
      confirmBtn?.addEventListener('click', () => {
        if (!selectedStore) return;
        try { app.populateAllStoreSelects(); } catch(e){}
        const storeSel = document.getElementById('storeSelect');
        if (storeSel) {
          const exists = Array.from(storeSel.options).some(o => o.value === selectedStore);
          if (!exists) {
            const opt = document.createElement('option'); opt.value = selectedStore; opt.textContent = selectedStore;
            storeSel.appendChild(opt);
          }
          storeSel.value = selectedStore;
          storeSel.dispatchEvent(new Event('change', { bubbles:true }));
        }

        // Hide store choice card
        storeChoiceCard.classList.add('hidden');

        // Show empty cart placeholder
        cartMainPlaceholder.style.display = 'flex';
        cartMainPlaceholder.removeAttribute('aria-hidden');

        // ensure floating buttons re-appear
        showFloating();

        // ensure expenseForm remains hidden until the user adds a product
        expenseForm.classList.add('hidden');

        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Drawer open/close
      function openDrawer() {
        if (!storeChoiceCard.classList.contains('hidden')) return;
        drawerOverlay.classList.add('visible');
        drawer.classList.remove('hidden');
        drawer.removeAttribute('aria-hidden');
        document.body.classList.add('no-scroll');

        // hide floating buttons to avoid overlap
        hideFloating();
      }
      function closeDrawer() {
        drawerOverlay.classList.remove('visible');
        drawer.classList.add('hidden');
        drawer.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');

        if (storeChoiceCard.classList.contains('hidden')) showFloating();
      }

      document.getElementById('floatingAddBtn')?.addEventListener('click', (e) => {
        e.preventDefault();
        openDrawer();
      });
      closeDrawerBtn?.addEventListener('click', closeDrawer);
      drawerOverlay?.addEventListener('click', closeDrawer);

      // Drawer: add product to cart
      drawerAddBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        const name = (document.getElementById('drawerProductName')?.value || '').trim();
        const cat = (document.getElementById('drawerProductCategory')?.value || '').trim();
        const priceRaw = (document.getElementById('drawerProductPrice')?.value || '').trim();
        const priceKgRaw = (document.getElementById('drawerProductPriceKg')?.value || '').trim();
        const notes = (document.getElementById('drawerProductNotes')?.value || '').trim();

        const price = parseFloat(priceRaw || 0);
        const priceKg = priceKgRaw ? parseFloat(priceKgRaw) : null;

        if (!name || !cat || !price || isNaN(price) || price <= 0) {
          alert('Compila nome, categoria e prezzo correttamente.');
          return;
        }

        // Create product object (do not include store here)
        const product = {
          id: app.generateId ? app.generateId() : ('p_'+Date.now()),
          name, category: cat, price, priceKg, notes
        };

        // If scanner provided an image, attach
        try {
          if (app && typeof app.getLastScannedImage === 'function') {
            const img = app.getLastScannedImage();
            if (img) product.image = img;
          }
        } catch(e){}

        // Add via app API if available
        if (app && typeof app.addProductToCart === 'function') {
          app.addProductToCart(product);
        } else {
          if (!app.currentCart) app.currentCart = [];
          app.currentCart.push(product);
          document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: app.currentCart }));
        }

        // After adding the first product: hide placeholder and show cartSection
        const cartSection = document.getElementById('cartSection');
        if (cartSection) {
          cartSection.classList.remove('hidden');
          cartSection.removeAttribute('aria-hidden');
        }
        cartMainPlaceholder.style.display = 'none';
        expenseForm.classList.remove('hidden');

        // explicit UI update
        try { if (typeof updateCartDisplay === 'function') updateCartDisplay(); } catch(e){ console.warn(e); }

        // reset drawer fields and close drawer
        document.getElementById('drawerProductName').value = '';
        document.getElementById('drawerProductCategory').value = '';
        document.getElementById('drawerProductPrice').value = '';
        document.getElementById('drawerProductPriceKg').value = '';
        document.getElementById('drawerProductNotes').value = '';

        // clear last scanned image to avoid reuse
        try { if (app && typeof app.setLastScannedImage === 'function') app.setLastScannedImage(null); } catch(e){}

        closeDrawer();
      });

      // Floating camera button opens scanner
      document.getElementById('floatingCameraBtn')?.addEventListener('click', async (e) => {
        e.preventDefault();
        if (!storeChoiceCard.classList.contains('hidden')) return;
        if (typeof openScannerModal === 'function') {
          try { await openScannerModal(); } catch (err) { console.warn(err); alert('Impossibile aprire la fotocamera.'); }
        } else {
          document.getElementById('scanBarcodeBtn')?.click();
        }
      });

      // wire scanner buttons inside modal
      document.getElementById('scannerCancelBtn')?.addEventListener('click', () => {
        if (typeof closeScannerModal === 'function') closeScannerModal();
      });
      document.getElementById('switchCameraBtn')?.addEventListener('click', async () => {
        if (typeof switchCamera === 'function') {
          try { await switchCamera(); } catch(e) { console.warn(e); }
        }
      });

      // populate selects if user skipped (or for confirm)
      try { app.populateAllStoreSelects(); } catch(e){}

      // when cart changed, update UI
      document.addEventListener('app:cart-changed', (ev) => {
        const cart = (app && app.currentCart) ? app.currentCart : (ev && ev.detail) ? ev.detail : [];
        if (!cart || cart.length === 0) {
          if (storeChoiceCard.classList.contains('hidden')) {
            cartMainPlaceholder.style.display = 'flex';
            document.getElementById('cartSection')?.classList.add('hidden');
            document.getElementById('expenseForm')?.classList.add('hidden');
          }
        } else {
          cartMainPlaceholder.style.display = 'none';
          document.getElementById('cartSection')?.classList.remove('hidden');
          document.getElementById('expenseForm')?.classList.remove('hidden');
        }
        if (storeChoiceCard.classList.contains('hidden')) showFloating();

        // update table
        try { if (typeof updateCartDisplay === 'function') updateCartDisplay(); } catch(e){ console.warn(e); }
      });

      // menu overlay open/close (side menu)
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuOverlay = document.getElementById('menuOverlay');
      function openMenu() {
        sideMenu.classList.remove('hidden'); sideMenu.classList.add('open'); sideMenu.removeAttribute('aria-hidden');
        menuOverlay.classList.add('visible'); document.body.classList.add('no-scroll');
      }
      function closeMenu() {
        sideMenu.classList.add('hidden'); sideMenu.classList.remove('open'); sideMenu.setAttribute('aria-hidden','true');
        menuOverlay.classList.remove('visible'); document.body.classList.remove('no-scroll');
      }
      menuToggle?.addEventListener('click', openMenu);
      menuOverlay?.addEventListener('click', () => { closeMenu(); closeDrawer(); });

      // Keep bottom padding for bottom-nav
      const bottomNav = document.querySelector('.bottom-nav');
      const main = document.querySelector('main');
      if (bottomNav && main) {
        const navH = bottomNav.offsetHeight || 0;
        const extra = 28;
        main.style.paddingBottom = (navH + extra) + 'px';
        document.body.style.paddingBottom = (navH + extra) + 'px';
      }
    }); // DOMContentLoaded
  </script>

  <!-- updateCartDisplay: popola #cartBody, aggiorna totale, abilita pulsanti -->
  <script>
    function updateCartDisplay() {
      try {
        const tbody = document.getElementById('cartBody');
        if (!tbody) return;
        // get cart from app (fallback to event detail)
        const cart = (window.app && Array.isArray(window.app.currentCart)) ? window.app.currentCart : [];
        tbody.innerHTML = '';

        if (!cart || cart.length === 0) {
          document.getElementById('cartTotal').textContent = (window.app && typeof app.formatCurrency === 'function') ? app.formatCurrency(0) : '€0.00';
          document.getElementById('saveExpenseBtn').disabled = true;
          return;
        }

        cart.forEach(item => {
          const tr = document.createElement('tr');

          // Product column: thumbnail + name + meta(category, notes)
          const tdProd = document.createElement('td');
          const prodWrap = document.createElement('div');
          prodWrap.style.display = 'flex';
          prodWrap.style.gap = '10px';
          prodWrap.style.alignItems = 'center';

          if (item.image) {
            const img = document.createElement('img');
            img.src = item.image;
            img.alt = item.name || 'img';
            img.className = 'cart-thumb';
            prodWrap.appendChild(img);
          } else {
            const placeholder = document.createElement('div');
            placeholder.style.width = '48px';
            placeholder.style.height = '48px';
            placeholder.style.borderRadius = '6px';
            placeholder.style.background = 'rgba(0,0,0,0.04)';
            prodWrap.appendChild(placeholder);
          }

          const info = document.createElement('div');
          const nameEl = document.createElement('div');
          nameEl.className = 'cart-product-name';
          nameEl.textContent = item.name || '';

          const metaEl = document.createElement('div');
          metaEl.className = 'cart-product-meta';
          const cat = item.category ? item.category : '';
          const notes = item.notes ? (' — ' + item.notes) : '';
          metaEl.textContent = cat + (item.priceKg ? (` • ${item.priceKg} €/kg`) : '') + (notes ? notes : '');

          info.appendChild(nameEl);
          info.appendChild(metaEl);
          prodWrap.appendChild(info);
          tdProd.appendChild(prodWrap);
          tr.appendChild(tdProd);

          // Price column
          const tdPrice = document.createElement('td');
          tdPrice.style.whiteSpace = 'nowrap';
          const priceText = (window.app && typeof app.formatCurrency === 'function') ? app.formatCurrency(parseFloat(item.price || 0)) : `€${Number(item.price||0).toFixed(2)}`;
          tdPrice.textContent = priceText;
          tr.appendChild(tdPrice);

          // Actions column: remove button
          const tdActions = document.createElement('td');
          const removeBtn = document.createElement('button');
          removeBtn.className = 'cart-remove-btn';
          removeBtn.type = 'button';
          removeBtn.title = 'Rimuovi';
          removeBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
          removeBtn.addEventListener('click', () => {
            try {
              if (window.app && typeof app.removeProductFromCart === 'function') {
                app.removeProductFromCart(item.id);
              } else {
                // fallback
                const idx = window.app.currentCart.findIndex(p => p.id === item.id);
                if (idx !== -1) { window.app.currentCart.splice(idx,1); document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: window.app.currentCart })); }
              }
            } catch (e) {
              console.error('remove from cart error', e);
            }
          });
          tdActions.appendChild(removeBtn);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });

        // update total & enable save button
        const total = (window.app && typeof app.getCartTotal === 'function') ? app.getCartTotal() : cart.reduce((s,i)=> s + (parseFloat(i.price)||0),0);
        document.getElementById('cartTotal').textContent = (window.app && typeof app.formatCurrency === 'function') ? app.formatCurrency(total) : `€${total.toFixed(2)}`;
        const saveBtn = document.getElementById('saveExpenseBtn');
        if (saveBtn) saveBtn.disabled = !(cart && cart.length > 0);

      } catch (err) {
        console.error('updateCartDisplay error', err);
      }
    }

    // initial render (in case there are items already)
    document.addEventListener('DOMContentLoaded', () => {
      try { updateCartDisplay(); } catch (e) { console.warn(e); }
    });

    // also listen to app:cart-changed if emitted elsewhere
    document.addEventListener('app:cart-changed', () => {
      try { updateCartDisplay(); } catch(e){ console.warn(e); }
    });
  </script>
</body>
</html>