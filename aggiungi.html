<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggiungi Spesa</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#1e1e1e" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Piccoli aggiustamenti locali per il modal scanner */
    .scanner-instructions { color: var(--text-secondary); margin-bottom:8px; font-size:0.95rem; }
    /* video ora contenuto in #scannerContainer */
    #scannerContainer { position: relative; width: 100%; height: 320px; max-height: 60vh; background: #000; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    #scannerVideo { width: 100%; height: 100%; object-fit: cover; background: #000; display: block; }
    /* Overlay di inquadratura: rettangolo centrale con resto scurito */
    #scannerOverlay {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 78%;
      height: 120px;
      transform: translate(-50%, -50%);
      border-radius: 10px;
      box-shadow:
        0 0 0 9999px rgba(0,0,0,0.45),
        inset 0 0 0 2px rgba(0,122,255,0.85);
      pointer-events: none;
      z-index: 40;
    }
    /* linea di scansione che attraversa l'overlay */
    #scannerOverlay .scan-line {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, rgba(0,122,255,0) 0%, rgba(0,122,255,0.9) 50%, rgba(0,122,255,0) 100%);
      animation: scanMove 1.6s linear infinite;
      border-radius: 1px;
    }
    @keyframes scanMove {
      0% { transform: translateY(-4px); opacity: 0; }
      10% { opacity: 1; }
      50% { transform: translateY(calc(100% - 2px)); opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-4px); opacity: 0; }
    }

    .scanner-actions { display:flex; gap:8px; margin-top:10px; justify-content: space-between; align-items:center; }
    .scanner-actions .left { display:flex; gap:8px; align-items:center; }
    .scanner-actions .right { display:flex; gap:8px; align-items:center; }
    .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 28px; background: rgba(0,0,0,0.7); color: #fff; padding: 8px 12px; border-radius: 10px; z-index: 2100; font-size: 0.95rem; display:none; }
    .device-label { font-size: 0.85rem; color: var(--text-secondary); }
    .small-btn { padding:8px 10px; border-radius:8px; font-size:0.9rem; }
    /* link ricerca manuale */
    .openfood-link { display:block; margin-top:10px; color: var(--accent); text-decoration: none; font-weight:600; }
    .openfood-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <h1>üõçÔ∏è Aggiungi Spesa</h1>
    <nav>
      <a href="index.html">Dashboard</a>
      <a href="aggiungi.html" class="nav-active">Aggiungi</a>
      <a href="archivio.html">Archivio</a>
      <a href="impostazioni.html">Impostazioni</a>
    </nav>
  </header>

  <main class="add-expense">
    <form id="expenseForm" class="expense-form" novalidate>
      <div class="form-section">
        <h2>üè™ Informazioni Generali</h2>

        <div class="form-group">
          <label for="storeSelect">Supermercato:</label>
          <!-- sar√† popolato dinamicamente; class store-select necessario -->
          <select id="storeSelect" class="store-select" required></select>
        </div>

        <div class="form-group" id="customStoreGroup" style="display:none;">
          <label for="customStore">Nome supermercato:</label>
          <input type="text" id="customStore" placeholder="Inserisci nome supermercato" />
        </div>

        <div class="form-group">
          <label for="expenseDate">Data:</label>
          <input type="date" id="expenseDate" required />
        </div>
      </div>

      <div class="form-section">
        <h2>üõí Aggiungi Prodotti</h2>

        <div class="product-form">
          <div class="form-row">
            <div class="form-group">
              <label for="productCategory">Tipologia:</label>
              <select id="productCategory" required>
                <option value="">Seleziona tipologia</option>
                <option value="Carne">ü•© Carne</option>
                <option value="Pesce">üêü Pesce</option>
                <option value="Verdura">ü•¨ Verdura</option>
                <option value="Frutta">üçé Frutta</option>
                <option value="Latticini">üßÄ Latticini</option>
                <option value="Pane">üçû Pane e Cereali</option>
                <option value="Bevande">ü•§ Bevande</option>
                <option value="Surgelati">üßä Surgelati</option>
                <option value="Dolci">üç∞ Dolci</option>
                <option value="Pulizia">üßΩ Prodotti Pulizia</option>
                <option value="Igiene">üß¥ Igiene Personale</option>
                <option value="Altro">üì¶ Altro</option>
              </select>
            </div>

            <div class="form-group">
              <label for="productName">Nome prodotto:</label>
              <input type="text" id="productName" placeholder="Es. Pomodori" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="productPrice">Prezzo (‚Ç¨):</label>
              <input type="number" id="productPrice" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
            </div>

            <div class="form-group">
              <label for="productPriceKg">Prezzo/kg (‚Ç¨):</label>
              <input type="number" id="productPriceKg" step="0.01" min="0" inputmode="decimal" placeholder="0.00" />
            </div>
          </div>

          <div class="form-group">
            <label for="productNotes">Note:</label>
            <input type="text" id="productNotes" placeholder="Note aggiuntive (opzionale)" />
          </div>

          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" id="scanBarcodeBtn" class="btn btn-secondary">üì∑ Scansiona codice a barre</button>
            <button type="button" id="addProductBtn" class="btn btn-primary">‚ûï Aggiungi Prodotto al Carrello</button>
          </div>

        </div>
      </div>

      <div class="cart-section" id="cartSection" style="display:none;">
        <h2>üõí Carrello</h2>
        <div class="cart-table-container">
          <table id="cartTable">
            <thead>
              <tr><th>Prodotto</th><th>Prezzo</th><th>Azioni</th></tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>
        </div>
        <div class="cart-total"><strong>Totale: <span id="cartTotal">‚Ç¨0.00</span></strong></div>
      </div>

      <div class="form-actions">
        <button type="submit" id="saveExpenseBtn" class="btn" disabled>üíæ Salva Spesa Completa</button>
        <button type="button" id="clearCartBtn" class="btn btn-danger">üóëÔ∏è Svuota Carrello</button>
      </div>
    </form>
  </main>

  <!-- Scanner modal -->
  <div id="scannerModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>üì∑ Scansione Codice a Barre</h3>
      <p class="scanner-instructions">Inquadra il codice a barre con la fotocamera. L'app prover√† a recuperare i dati da Open Food Facts.</p>

      <!-- container with video and overlay -->
      <div id="scannerContainer" aria-live="polite">
        <video id="scannerVideo" autoplay playsinline muted></video>

        <!-- overlay rettangolo + scan line -->
        <div id="scannerOverlay" aria-hidden="true">
          <div class="scan-line" aria-hidden="true"></div>
        </div>
      </div>

      <a class="openfood-link" href="https://world.openfoodfacts.org" target="_blank" rel="noopener">üîé Cerca manualmente su Open Food Facts</a>

      <div class="scanner-actions">
        <div class="left">
          <div id="deviceLabel" class="device-label" aria-live="polite"></div>
        </div>
        <div class="right">
          <button id="switchCameraBtn" class="btn btn-secondary small-btn">üîÅ Cambia Camera</button>
          <button id="scannerCancelBtn" class="btn btn-secondary">Annulla</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- app.js (la tua logica condivisa) -->
  <script src="app.js"></script>

  <!-- ZXing library (UMD build) -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>

  <script>
    // Helper toast
    function showToast(msg, duration = 2200) {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(t._timeout);
      t._timeout = setTimeout(() => { t.style.display = 'none'; }, duration);
    }

    // Scanner logic using ZXing BrowserMultiFormatReader
    let codeReader = null;
    let availableVideoDevices = []; // [{deviceId,label},...]
    let currentDeviceIndex = -1;
    let isScannerOpen = false;
    let barcodeHandled = false;

    // Utility: stop ZXing + any streams
    async function stopScanner() {
      if (codeReader) {
        try { await codeReader.reset(); } catch (e) { /* ignore */ }
        codeReader = null;
      }
      const video = document.getElementById('scannerVideo');
      if (video) {
        if (video.srcObject) {
          try {
            const tracks = video.srcObject.getTracks();
            tracks.forEach(t => t.stop());
          } catch (e) { /* ignore */ }
          video.srcObject = null;
        }
        try { video.pause(); } catch(e) {}
      }
      isScannerOpen = false;
      barcodeHandled = false;
      updateDeviceLabel('');
    }

    function updateDeviceLabel(text) {
      const lab = document.getElementById('deviceLabel');
      if (lab) lab.textContent = text || '';
    }

    // Choose preferred device: try to use environment/rear
    async function prepareDevicesAndChoosePreferred() {
      try {
        // small permission request to allow labels on some browsers
        const tmpStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
        tmpStream.getTracks().forEach(t => t.stop());
      } catch (e) {
        // continue anyway if permission not granted yet
      }

      const devices = await navigator.mediaDevices.enumerateDevices();
      availableVideoDevices = devices.filter(d => d.kind === 'videoinput').map(d => ({ deviceId: d.deviceId, label: d.label || 'Camera' }));
      // pick device with label containing back/rear/environment if possible
      let idx = availableVideoDevices.findIndex(d => /back|rear|environment|posteriore/gi.test(d.label));
      if (idx === -1) idx = (availableVideoDevices.length > 0 ? 0 : -1);
      currentDeviceIndex = idx;
      return currentDeviceIndex;
    }

    async function openScannerModal() {
      const modal = document.getElementById('scannerModal');
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden', 'false');

      isScannerOpen = true;
      barcodeHandled = false;

      try {
        codeReader = new ZXingBrowser.BrowserMultiFormatReader();
      } catch (e) {
        if (window.ZXing && window.ZXing.BrowserMultiFormatReader) {
          codeReader = new window.ZXing.BrowserMultiFormatReader();
        } else {
          console.error('ZXing load error', e);
          alert('Errore inizializzazione scanner. Controlla la connessione alla libreria.');
          await closeScannerModal();
          return;
        }
      }

      try {
        const chosenIndex = await prepareDevicesAndChoosePreferred();
        if (chosenIndex === -1) {
          alert('Nessuna videocamera disponibile sul dispositivo.');
          await closeScannerModal();
          return;
        }

        const chosen = availableVideoDevices[chosenIndex];
        updateDeviceLabel('Camera: ' + (chosen.label || 'Sconosciuta'));

        const videoElem = document.getElementById('scannerVideo');
        await codeReader.decodeFromVideoDevice(chosen.deviceId, videoElem, (result, err) => {
          if (result) {
            const code = (result.getText ? result.getText() : (result.text || '')).trim();
            handleBarcodeFound(code);
          }
        });
      } catch (err) {
        console.error('Camera/Scanner error', err);
        alert('Impossibile avviare lo scanner. Controlla i permessi o riprova.');
        await closeScannerModal();
      }
    }

    async function closeScannerModal() {
      const modal = document.getElementById('scannerModal');
      try {
        await stopScanner();
      } catch (e) { /* ignore */ }
      if (modal) {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
      }
    }

    // Switch camera: cycles through availableVideoDevices
    async function switchCamera() {
      if (!isScannerOpen) return;
      if (!availableVideoDevices || availableVideoDevices.length <= 1) {
        showToast('Nessun altra camera disponibile', 1600);
        return;
      }
      try { await stopScanner(); } catch (e) { /* ignore */ }

      currentDeviceIndex = (currentDeviceIndex + 1) % availableVideoDevices.length;
      const chosen = availableVideoDevices[currentDeviceIndex];
      updateDeviceLabel('Camera: ' + (chosen.label || 'Sconosciuta'));

      try {
        codeReader = new ZXingBrowser.BrowserMultiFormatReader();
        const videoElem = document.getElementById('scannerVideo');
        await codeReader.decodeFromVideoDevice(chosen.deviceId, videoElem, (result, err) => {
          if (result) {
            const code = (result.getText ? result.getText() : (result.text || '')).trim();
            handleBarcodeFound(code);
          }
        });
      } catch (err) {
        console.error('Errore switching camera', err);
        showToast('Errore nel cambiare camera', 1600);
        await stopScanner();
      }
    }

    async function handleBarcodeFound(barcode) {
      if (!barcode || barcodeHandled) return;
      barcodeHandled = true; // prevent double handling
      showToast('Codice rilevato: ' + barcode, 1500);

      // Fetch Open Food Facts
      try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${encodeURIComponent(barcode)}.json`);
        if (!res.ok) throw new Error('Network response not ok');
        const json = await res.json();

        if (json && json.status === 1 && json.product) {
          const p = json.product;
          const nameField = document.getElementById('productName');
          const notesField = document.getElementById('productNotes');
          const categoryField = document.getElementById('productCategory');

          const prodName = p.product_name || p.generic_name || p.brands || '';
          if (nameField && prodName) nameField.value = prodName;

          let noteParts = [];
          if (p.brands) noteParts.push(p.brands);
          if (p.quantity) noteParts.push(p.quantity);
          if (p.categories) noteParts.push(p.categories.split(',').slice(0,2).join(' ‚Ä¢ '));
          if (notesField && noteParts.length) notesField.value = noteParts.join(' ‚Ä¢ ');

          if (categoryField && Array.isArray(p.categories_tags) && p.categories_tags.length) {
            const tag = p.categories_tags[0] || '';
            const human = (p.categories || '').split(',')[0] || tag.replace('en:', '').replace(/-/g,' ');
            const opts = Array.from(categoryField.options).map(o => o.value);
            const found = opts.find(o => human && o && o.toLowerCase().includes(human.toLowerCase()));
            if (found) categoryField.value = found;
          }

          showToast('Dati trovati e compilati (verifica prima di aggiungere)', 2200);
        } else {
          const manual = confirm('Prodotto non trovato in Open Food Facts. Vuoi cercarlo manualmente sul sito?');
          if (manual) {
            window.open('https://world.openfoodfacts.org', '_blank', 'noopener');
          }
        }
      } catch (err) {
        console.error('OpenFoodFacts fetch error', err);
        alert('Errore nel recupero dei dati. Controlla la connessione o inserisci manualmente.');
      } finally {
        setTimeout(async () => {
          await closeScannerModal();
          barcodeHandled = false;
        }, 800);
      }
    }

    // Fallback manual code prompt (if user wants to input barcode manually)
    async function manualBarcodePrompt() {
      const code = prompt('Inserisci manualmente il codice a barre (EAN/UPC):');
      if (!code) return;
      barcodeHandled = false;
      handleBarcodeFound(code);
    }

    // --- Page logic integration with your existing functions ---
    document.addEventListener('DOMContentLoaded', () => {
      try { app.populateAllStoreSelects(); } catch(e){ /* ignore if not available */ }

      const dateEl = document.getElementById('expenseDate');
      if (dateEl) dateEl.value = new Date().toISOString().split('T')[0];

      document.getElementById('storeSelect')?.addEventListener('change', toggleCustomStore);
      document.getElementById('addProductBtn')?.addEventListener('click', e => { e.preventDefault(); addProductToCart(); });
      document.getElementById('clearCartBtn')?.addEventListener('click', e => { e.preventDefault(); clearCart(); });
      document.getElementById('saveExpenseBtn')?.addEventListener('click', e => { e.preventDefault(); saveExpense(); });
      document.getElementById('expenseForm')?.addEventListener('submit', e => { e.preventDefault(); saveExpense(); });

      document.getElementById('scanBarcodeBtn')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await openScannerModal();
        } catch (err) {
          console.warn('Scanner open failed', err);
          if (confirm('Impossibile aprire la fotocamera. Vuoi inserire manualmente il codice a barre?')) {
            manualBarcodePrompt();
          }
        }
      });

      document.getElementById('scannerCancelBtn')?.addEventListener('click', () => {
        closeScannerModal();
      });

      document.getElementById('switchCameraBtn')?.addEventListener('click', async () => {
        await switchCamera();
      });

      app.currentCart = app.currentCart || [];
      updateCartDisplay();
      toggleCustomStore();
    });

    // --- helper / existing functions (kept identical) ---
    function toggleCustomStore() {
      const storeSelect = document.getElementById('storeSelect');
      const customGroup = document.getElementById('customStoreGroup');
      const customInput = document.getElementById('customStore');
      if (!storeSelect) return;
      if (storeSelect.value === 'Altro') {
        customGroup.style.display = 'block';
        if (customInput) customInput.required = true;
      } else {
        customGroup.style.display = 'none';
        if (customInput) customInput.required = false;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function addProductToCart() {
      const categoryEl = document.getElementById('productCategory');
      const nameEl = document.getElementById('productName');
      const priceEl = document.getElementById('productPrice');
      const priceKgEl = document.getElementById('productPriceKg');
      const notesEl = document.getElementById('productNotes');

      if (!categoryEl || !nameEl || !priceEl) return;

      const category = categoryEl.value.trim();
      const name = nameEl.value.trim();
      const priceRaw = priceEl.value.trim();
      const price = parseFloat(priceRaw);
      const priceKg = priceKgEl && priceKgEl.value ? parseFloat(priceKgEl.value) : null;
      const notes = notesEl && notesEl.value ? notesEl.value.trim() : '';

      if (!category || !name || !priceRaw || isNaN(price) || price <= 0) {
        alert('Compila tutti i campi prodotto correttamente.');
        return;
      }

      const product = {
        id: app.generateId(),
        category,
        name,
        price,
        priceKg,
        notes
      };

      app.currentCart.push(product);
      updateCartDisplay();
      clearProductForm();
      nameEl.focus();

      const addBtn = document.getElementById('addProductBtn');
      if (addBtn) { addBtn.classList.add('pulse'); setTimeout(()=>addBtn.classList.remove('pulse'), 260); }
    }

    function updateCartDisplay() {
      const cartSection = document.getElementById('cartSection');
      const cartBody = document.getElementById('cartBody');
      const cartTotal = document.getElementById('cartTotal');
      const saveBtn = document.getElementById('saveExpenseBtn');
      if (!cartSection || !cartBody || !cartTotal || !saveBtn) return;

      if (!app.currentCart || app.currentCart.length === 0) {
        cartSection.style.display = 'none';
        saveBtn.disabled = true;
        cartBody.innerHTML = '';
        cartTotal.textContent = app.formatCurrency(0);
        return;
      }

      cartSection.style.display = 'block';
      saveBtn.disabled = false;

      cartBody.innerHTML = app.currentCart.map(p => `
        <tr>
          <td>
            <strong>${escapeHtml(p.name)}</strong>
            <div style="color: ${'#bfbfc4'}; font-size:0.85rem">${escapeHtml(p.category)}${p.notes ? ' ‚Ä¢ ' + escapeHtml(p.notes) : ''}</div>
          </td>
          <td><strong>${app.formatCurrency(p.price)}</strong></td>
          <td><button type="button" class="remove-btn" onclick="removeFromCart('${p.id}')">üóëÔ∏è</button></td>
        </tr>
      `).join('');

      const total = app.currentCart.reduce((s, it) => s + (parseFloat(it.price) || 0), 0);
      cartTotal.textContent = app.formatCurrency(total);
    }

    function clearProductForm() {
      ['productCategory','productName','productPrice','productPriceKg','productNotes'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
    }

    function removeFromCart(id) {
      app.currentCart = app.currentCart.filter(p => p.id !== id);
      updateCartDisplay();
    }

    function clearCart() {
      if (!app.currentCart || app.currentCart.length === 0) return;
      if (confirm('Svuotare il carrello?')) {
        app.currentCart = [];
        updateCartDisplay();
      }
    }

    function saveExpense() {
      const storeSelect = document.getElementById('storeSelect');
      const customStore = document.getElementById('customStore');
      const dateEl = document.getElementById('expenseDate');
      if (!storeSelect || !dateEl) return;

      const store = (storeSelect.value === 'Altro') ? (customStore ? customStore.value.trim() : '') : storeSelect.value;
      const date = dateEl.value;
      if (!store) { alert('Seleziona o inserisci un supermercato.'); return; }
      if (!date) { alert('Inserisci la data.'); return; }
      if (!app.currentCart || app.currentCart.length === 0) { alert('Aggiungi almeno un prodotto.'); return; }

      // check future date
      const today = new Date().toISOString().split('T')[0];
      if (date > today) { alert('La data non pu√≤ essere futura'); return; }

      try {
        app.addExpense(store, date, app.currentCart);
        // se store non era nella lista, aggiungilo
        try {
          const inList = app.getStores().some(s => s.toLowerCase() === store.toLowerCase());
          if (!inList && store !== 'Altro') app.addStore(store);
        } catch(e) { /* ignore */ }

        alert('Spesa salvata con successo');
        document.getElementById('expenseForm').reset();
        app.currentCart = [];
        updateCartDisplay();
        toggleCustomStore();
        dateEl.value = today;
      } catch (e) {
        console.error(e);
        alert('Errore salvataggio spesa');
      }
    }
  </script>
</body>
</html>