<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggiungi Spesa — GroceryHub</title>

  <!-- Manifest / PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#ffffff" />

  <!-- Font Awesome (icone) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">

  <!-- Stili unificati (tuo style.css "bellissima") -->
  <link rel="stylesheet" href="style.css?v=20250816" />

  <!-- Stili specifici per store-choice -->
  <style>
    /* Grid store cards */
    .store-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .store-card {
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: var(--panel);
      cursor: pointer;
      text-align:left;
      transition: transform .12s ease, box-shadow .14s ease, background .12s ease;
      box-shadow: 0 8px 20px rgba(0,0,0,0.04);
      width:100%;
    }
    .store-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.06); }
    .store-card.selected {
      background: var(--gh-salvia);
      color: #fff;
      border-color: rgba(0,0,0,0.04);
      box-shadow: 0 12px 38px rgba(122,169,134,0.14);
    }
    .store-card .store-logo {
      width:64px; height:64px; object-fit:contain; border-radius:8px; background:transparent;
      flex:0 0 64px;
      border: none;
    }
    .store-card .store-card-body { flex:1; min-width:0; }
    .store-card .store-card-title { font-weight:700; color:var(--gh-text-strong); }
    .store-card.selected .store-card-title { color: #fff; }
    .store-card .store-card-desc { color:var(--gh-muted); font-size:0.92rem; margin-top:4px; }
    .store-card.selected .store-card-desc { color: rgba(255,255,255,0.9); }

    /* ensure confirm button aligns on small screens */
    @media (max-width:560px) {
      .store-list-grid { grid-template-columns: 1fr; }
      #storeChoiceCard .section-header { gap:10px; }
    }
  </style>
</head>
<body>
  <!-- Header (identico a index) -->
  <header>
    <div class="hamburger" id="menuToggle" aria-label="Apri menu" title="Apri menu">
      <i class="fa-solid fa-bars"></i>
    </div>

    <div class="title-wrap" role="banner">
      <div class="title-row" aria-hidden="true">
        <h1 class="groceryhub">Grocery<span class="hub">Hub</span></h1>
      </div>
      <div class="payoff">Controlla, risparmia, vivi meglio</div>
    </div>
  </header>

  <!-- Off-canvas side menu (ridotto come richiesto in precedenza) -->
  <nav id="sideMenu" class="hidden" aria-hidden="true">
    <div class="menu-header">
      <div class="menu-logo">GH</div>
      <div>
        <div style="font-weight:800;">GroceryHub</div>
        <div style="font-size:0.9rem;color:var(--gh-muted)">La tua gestione spese</div>
      </div>
    </div>

    <div class="menu-section">
      <div style="font-size:0.95rem;font-weight:700;margin-bottom:8px;">Navigazione</div>
      <a href="index.html"><i class="fa-solid fa-house" style="width:18px;margin-right:8px;"></i> Dashboard</a>
      <a href="aggiungi.html"><i class="fa-solid fa-plus" style="width:18px;margin-right:8px;"></i> Aggiungi spesa</a>
      <a href="archivio.html"><i class="fa-solid fa-archive" style="width:18px;margin-right:8px;"></i> Archivio</a>
      <a href="impostazioni.html"><i class="fa-solid fa-gear" style="width:18px;margin-right:8px;"></i> Impostazioni</a>
    </div>
  </nav>

  <!-- overlay per side menu tappabile -->
  <div id="menuOverlay" class="menu-overlay" tabindex="-1" aria-hidden="true"></div>

  <!-- Main content -->
  <main class="dashboard add-expense" role="main" aria-live="polite">
    <!-- STORE CHOICE CARD: visibile all'apertura -->
    <section id="storeChoiceCard" class="panel store-choice-card" aria-labelledby="storeChoiceTitle">
      <div class="section-header">
        <span class="icon-circle" aria-hidden="true"><i class="fa-solid fa-store"></i></span>
        <div class="title-lines">
          <h2 id="storeChoiceTitle">Aggiungi nuova spesa</h2>
          <div class="subtitle">Scegli il supermercato per iniziare</div>
        </div>
      </div>

      <div id="storeListGrid" class="store-list-grid" role="list" aria-label="Elenco supermercati">
        <!-- JS popola le store-card qui -->
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
        <button id="skipStoreChoiceBtn" class="btn btn-secondary">Scegli manualmente</button>
        <button id="confirmStoreBtn" class="btn" disabled>✔️ Conferma</button>
      </div>
    </section>

    <!-- EXISTING FORM: inizialmente nascosto; verrà mostrato dopo conferma -->
    <form id="expenseForm" class="expense-form hidden" novalidate>
      <!-- SEZIONE 1: Informazioni Generali (in panel) -->
      <section class="form-section panel" aria-labelledby="info-header">
        <div class="section-header" id="info-header">
          <span class="icon-circle" aria-hidden="true"><i class="fa-solid fa-store"></i></span>
          <div class="title-lines">
            <h2>Informazioni Generali</h2>
            <div class="subtitle">Dati della spesa</div>
          </div>
        </div>

        <div class="form-group">
          <label for="storeSelect">Supermercato</label>
          <select id="storeSelect" class="store-select" required></select>
        </div>

        <div class="form-group" id="customStoreGroup" aria-hidden="true" hidden>
          <label for="customStore">Nome supermercato</label>
          <input type="text" id="customStore" placeholder="Inserisci nome supermercato" />
        </div>

        <div class="form-group">
          <label for="expenseDate">Data</label>
          <input type="date" id="expenseDate" required />
        </div>
      </section>

      <!-- SEZIONE 2: Aggiungi Prodotti (in panel) -->
      <section class="form-section panel" aria-labelledby="add-header">
        <div class="section-header" id="add-header">
          <span class="icon-circle" aria-hidden="true"><i class="fa-solid fa-plus"></i></span>
          <div class="title-lines">
            <h2 style="line-height:1;">Aggiungi</h2>
            <div class="subtitle">Prodotti</div>
          </div>
        </div>

        <div class="product-form">
          <div class="form-row">
            <div class="form-group">
              <label for="productCategory">Tipologia</label>
              <select id="productCategory" required>
                <option value="">Seleziona tipologia</option>
                <option value="Carne">Carne</option>
                <option value="Pesce">Pesce</option>
                <option value="Verdura">Verdura</option>
                <option value="Frutta">Frutta</option>
                <option value="Latticini">Latticini</option>
                <option value="Pane">Pane e Cereali</option>
                <option value="Bevande">Bevande</option>
                <option value="Surgelati">Surgelati</option>
                <option value="Dolci">Dolci</option>
                <option value="Pulizia">Prodotti Pulizia</option>
                <option value="Igiene">Igiene Personale</option>
                <option value="Altro">Altro</option>
              </select>
            </div>

            <div class="form-group suggestions">
              <label for="productName">Nome prodotto</label>
              <input type="text" id="productName" placeholder="Es. Pomodori" autocomplete="off" required />
              <!-- container per suggerimenti -->
              <div id="suggestions" aria-hidden="true" class="suggestions-list"></div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="productPrice">Prezzo (€)</label>
              <input type="number" id="productPrice" step="0.01" min="0" inputmode="decimal" placeholder="0.00" required />
              <div id="priceDiff" aria-live="polite"></div>
            </div>

            <div class="form-group">
              <label for="productPriceKg">Prezzo/kg (€)</label>
              <input type="number" id="productPriceKg" step="0.01" min="0" inputmode="decimal" placeholder="0.00" />
            </div>
          </div>

          <div class="form-group">
            <label for="productNotes">Note</label>
            <input type="text" id="productNotes" placeholder="Note aggiuntive (opzionale)" />
          </div>

          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            <button type="button" id="scanBarcodeBtn" class="btn btn-secondary">Scansiona codice a barre</button>
            <button type="button" id="addProductBtn" class="btn">Aggiungi Prodotto al Carrello</button>
          </div>
        </div>
      </section>

      <!-- SEZIONE 3: Carrello (visibile solo quando ci sono prodotti) -->
      <section class="cart-section panel hidden" id="cartSection" aria-hidden="true">
        <div class="section-header">
          <span style="width:44px;"></span>
          <div class="title-lines">
            <h2>Carrello</h2>
            <div class="subtitle">Riepilogo dei prodotti</div>
          </div>
        </div>

        <div class="cart-table-container">
          <table id="cartTable">
            <thead>
              <tr><th>Prodotto</th><th>Prezzo</th><th>Azioni</th></tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>
        </div>
        <div class="cart-total"><strong>Totale: <span id="cartTotal">€0.00</span></strong></div>
      </section>

      <!-- SEZIONE 4: Azioni finali -->
      <section class="form-actions" style="margin-top:12px;display:flex;gap:10px;">
        <button type="submit" id="saveExpenseBtn" class="btn" disabled>💾 Salva Spesa Completa</button>
        <button type="button" id="clearCartBtn" class="btn btn-danger">🗑️ Svuota Carrello</button>
      </section>
    </form>
  </main>

  <!-- Drawer per aggiungere prodotto (overlay bottom sheet) -->
  <div id="drawerOverlay" class="menu-overlay" aria-hidden="true"></div>
  <div id="addProductDrawer" class="add-product-drawer hidden" role="dialog" aria-hidden="true" aria-labelledby="drawerTitle">
    <div class="drawer-header">
      <div id="drawerTitle" style="font-weight:700;font-size:1rem;">Aggiungi prodotto</div>
      <button id="closeDrawerBtn" class="btn btn-secondary" aria-label="Chiudi">Chiudi</button>
    </div>
    <div class="drawer-body">
      <div class="form-group">
        <label for="drawerProductName">Nome prodotto</label>
        <input id="drawerProductName" type="text" />
      </div>
      <div class="form-group">
        <label for="drawerProductCategory">Categoria</label>
        <select id="drawerProductCategory">
          <option value="">Seleziona tipologia</option>
          <option>Carne</option><option>Pesce</option><option>Verdura</option><option>Frutta</option>
          <option>Latticini</option><option>Pane</option><option>Bevande</option><option>Altro</option>
        </select>
      </div>
      <div class="form-group">
        <label for="drawerProductPrice">Prezzo (€)</label>
        <input id="drawerProductPrice" type="number" step="0.01" min="0" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button id="drawerAddBtn" class="btn">Aggiungi al carrello</button>
      </div>
    </div>
  </div>

  <!-- Scanner modal (esistente) -->
  <div id="scannerModal" class="modal hidden" aria-hidden="true">
    <div class="modal-content">
      <h3>📷 Scansione Codice a Barre</h3>
      <p class="scanner-instructions">Inquadra il codice a barre con la fotocamera. L'app proverà a recuperare i dati da Open Food Facts.</p>

      <div id="scannerContainer" aria-live="polite">
        <video id="scannerVideo" autoplay playsinline muted></video>
        <div id="scannerOverlay" aria-hidden="true">
          <div class="scan-line" aria-hidden="true"></div>
        </div>
      </div>

      <a class="openfood-link" href="https://world.openfoodfacts.org" target="_blank" rel="noopener">🔎 Cerca manualmente su Open Food Facts</a>

      <div class="scanner-actions">
        <div class="left">
          <div id="deviceLabel" class="device-label" aria-live="polite"></div>
        </div>
        <div class="right">
          <button id="switchCameraBtn" class="btn btn-secondary small-btn">🔁 Cambia Camera</button>
          <button id="scannerCancelBtn" class="btn btn-secondary">Annulla</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" aria-hidden="true"></div>

  <!-- app.js (la tua logica condivisa) -->
  <script src="app.js"></script>
  <!-- ZXing library (UMD build) -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>

  <!-- bottom navigation -->
  <nav class="bottom-nav" role="navigation" aria-label="Barra di navigazione">
    <a class="nav-item" href="index.html" aria-label="Dashboard">
      <span class="icon-wrap"><i class="fa-solid fa-chart-pie"></i></span>
      <span class="label">Dashboard</span>
    </a>
    <a class="nav-item nav-active" href="aggiungi.html" aria-label="Aggiungi">
      <span class="icon-wrap"><i class="fa-solid fa-plus-circle"></i></span>
      <span class="label">Aggiungi</span>
    </a>
    <a class="nav-item" href="archivio.html" aria-label="Archivio">
      <span class="icon-wrap"><i class="fa-solid fa-box-archive"></i></span>
      <span class="label">Archivio</span>
    </a>
    <a class="nav-item" href="impostazioni.html" aria-label="Impostazioni">
      <span class="icon-wrap"><i class="fa-solid fa-gear"></i></span>
      <span class="label">Impostazioni</span>
    </a>
  </nav>

  <!-- pulsanti flottanti: fotocamera (sx) + aggiungi (dx) -->
  <button id="floatingCameraBtn" class="floating-btn floating-left" aria-label="Apri fotocamera"><i class="fa-solid fa-camera"></i></button>
  <button id="floatingAddBtn" class="floating-btn floating-right" aria-label="Aggiungi prodotto"><i class="fa-solid fa-plus"></i></button>

  <!-- sincronia bottom-nav active -->
  <script>
    (function () {
      const path = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.bottom-nav .nav-item').forEach(a => {
        const href = a.getAttribute('href') || '';
        a.classList.toggle('nav-active', href.endsWith(path));
      });
    })();
  </script>

  <!-- Script: menu handling + populate side menu stores + store choice flow + drawer + logos -->
  <script>
    /***** MENU OPEN/CLOSE WITH OVERLAY (tap outside to close) *****/
    document.addEventListener('DOMContentLoaded', () => {
      const menuToggle = document.getElementById('menuToggle');
      const sideMenu = document.getElementById('sideMenu');
      const menuOverlay = document.getElementById('menuOverlay');

      function openMenu() {
        sideMenu.classList.remove('hidden');
        sideMenu.classList.add('open');
        sideMenu.removeAttribute('aria-hidden');
        menuOverlay.classList.add('visible');
        document.body.classList.add('no-scroll');
      }
      function closeMenu() {
        sideMenu.classList.add('hidden');
        sideMenu.classList.remove('open');
        sideMenu.setAttribute('aria-hidden','true');
        menuOverlay.classList.remove('visible');
        document.body.classList.remove('no-scroll');
      }

      menuToggle?.addEventListener('click', openMenu);
      menuOverlay?.addEventListener('click', closeMenu);

      // populate menu stores list (if present)
      populateSideMenuStores();
      document.addEventListener('app:stores-changed', () => populateSideMenuStores());
    });

    /***** STORE CHOICE UI (first card) *****/
    (function() {
      const storeListGrid = document.getElementById('storeListGrid');
      const confirmBtn = document.getElementById('confirmStoreBtn');
      const skipBtn = document.getElementById('skipStoreChoiceBtn');
      const storeChoiceCard = document.getElementById('storeChoiceCard');
      const expenseForm = document.getElementById('expenseForm');

      let selectedStore = null;

      // Map: store name -> domain used to fetch logo via Clearbit
      // If Clearbit doesn't return an image, we fallback to generated SVG
      const logoMap = {
        "Conad": "conad.it",
        "Coop": "coop.it",
        "Esselunga": "esselunga.it",
        "Eurospin": "eurospin.it",
        "Carrefour": "carrefour.it",
        "Lidl": "lidl.it",
        "MD": "mdspa.it",
        "Pam": "pam.it",
        "Simply": "simplymarket.it",
        "Iper": "iper.it"
      };

      // generate a lightweight placeholder SVG avatar with initials (data URL)
      function placeholderSVG(name, diameter=64) {
        const initials = (name || '').split(' ').slice(0,2).map(s => s[0]?.toUpperCase()||'').join('');
        const bg = getComputedStyle(document.documentElement).getPropertyValue('--gh-salvia') || '#7aa986';
        const fg = '#fff';
        const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="${diameter}" height="${diameter}"><rect width="100%" height="100%" rx="10" fill="${bg}"/><text x="50%" y="50%" font-family="Arial, Helvetica, sans-serif" font-size="${Math.round(diameter/2.6)}" fill="${fg}" dominant-baseline="middle" text-anchor="middle">${initials}</text></svg>`);
        return `data:image/svg+xml;utf8,${svg}`;
      }

      function describeFor(name) {
        // short, neutral description in italic (2 lines or less)
        return `Sezione ${name}: ampia scelta, offerte e prodotti freschi. Controlla le promozioni locali.`;
      }

      function renderStoreCards() {
        if (!storeListGrid) return;
        storeListGrid.innerHTML = '';
        const stores = (typeof app?.getStores === 'function') ? app.getStores() : [];
        // fallback default if app not ready
        const defaultList = ["Conad","Coop","Esselunga","Eurospin","Carrefour","Lidl","MD","Pam","Simply","Iper"];
        const finalStores = (stores && stores.length) ? stores : defaultList;

        finalStores.forEach((sName) => {
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'store-card';
          card.setAttribute('role','listitem');
          // determine logo src (clearbit)
          const domain = logoMap[sName] || '';
          const clearbitUrl = domain ? `https://logo.clearbit.com/${domain}?size=128` : '';
          const imgSrc = clearbitUrl || placeholderSVG(sName,64);

          card.innerHTML = `
            <div class="store-card-left">
              <img class="store-logo" src="${imgSrc}" alt="${sName} logo" />
            </div>
            <div class="store-card-body">
              <div class="store-card-title">${escapeHtml(sName)}</div>
              <div class="store-card-desc"><em>${escapeHtml(describeFor(sName))}</em></div>
            </div>
          `;

          // if clearbit image fails, fallback to placeholder SVG
          const imgEl = card.querySelector('img.store-logo');
          if (imgEl) {
            imgEl.addEventListener('error', () => {
              imgEl.src = placeholderSVG(sName,64);
            });
            // provide a small onload check to ensure not broken (optional)
            imgEl.addEventListener('load', () => {
              // if the loaded image is tiny or generic, we still keep it; user can change later
            });
          }

          card.addEventListener('click', () => {
            // toggle selection (single select)
            document.querySelectorAll('.store-card.selected').forEach(el => el.classList.remove('selected'));
            card.classList.add('selected');
            selectedStore = sName;
            confirmBtn.disabled = false;
          });
          storeListGrid.appendChild(card);
        });
      }

      function escapeHtml(txt){ const d = document.createElement('div'); d.textContent = txt || ''; return d.innerHTML; }

      function confirmSelection() {
        if (!selectedStore) {
          alert('Seleziona un supermercato dalla lista (o premi "Scegli manualmente").');
          return;
        }
        // reveal main form
        storeChoiceCard.classList.add('hidden');
        expenseForm.classList.remove('hidden');
        // make sure storeSelect is populated
        try { app.populateAllStoreSelects(); } catch(e){}
        // set the select value
        const storeSel = document.getElementById('storeSelect');
        if (storeSel) {
          // if option exists, set; otherwise create it then set
          const exists = Array.from(storeSel.options).some(o => o.value === selectedStore);
          if (!exists) {
            const opt = document.createElement('option'); opt.value = selectedStore; opt.textContent = selectedStore;
            storeSel.appendChild(opt);
          }
          storeSel.value = selectedStore;
          // trigger change (to toggle custom store UI)
          storeSel.dispatchEvent(new Event('change', { bubbles:true }));
        }
        // scroll to top of main content
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Skip: show form anyway (user chooses manual)
      function skipChoice() {
        storeChoiceCard.classList.add('hidden');
        expenseForm.classList.remove('hidden');
        try { app.populateAllStoreSelects(); } catch(e){}
      }

      // wire buttons
      document.addEventListener('DOMContentLoaded', () => {
        renderStoreCards();
        document.getElementById('confirmStoreBtn')?.addEventListener('click', confirmSelection);
        document.getElementById('skipStoreChoiceBtn')?.addEventListener('click', skipChoice);
      });

      // re-render if stores change
      document.addEventListener('app:stores-changed', renderStoreCards);
    })();

    /***** Drawer (bottom sheet) behavior *****/
    (function(){
      const drawer = document.getElementById('addProductDrawer');
      const overlay = document.getElementById('drawerOverlay');
      const openBtn = document.getElementById('floatingAddBtn');
      const closeBtn = document.getElementById('closeDrawerBtn');
      const addBtn = document.getElementById('drawerAddBtn');

      function openDrawer() {
        overlay.classList.add('visible');
        drawer.classList.remove('hidden');
        drawer.setAttribute('aria-hidden','false');
        overlay.removeAttribute('aria-hidden');
        document.body.classList.add('no-scroll');
      }
      function closeDrawer() {
        overlay.classList.remove('visible');
        drawer.classList.add('hidden');
        drawer.setAttribute('aria-hidden','true');
        overlay.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
      }

      openBtn?.addEventListener('click', () => {
        // if the main form is hidden, show it first
        const expenseForm = document.getElementById('expenseForm');
        const storeChoice = document.getElementById('storeChoiceCard');
        if (storeChoice && !storeChoice.classList.contains('hidden')) {
          // force user to choose a store first
          alert('Seleziona prima un supermercato per iniziare (o premi "Scegli manualmente").');
          return;
        }
        openDrawer();
      });
      closeBtn?.addEventListener('click', closeDrawer);
      overlay?.addEventListener('click', closeDrawer);

      // add product from drawer
      addBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        const name = (document.getElementById('drawerProductName')?.value || '').trim();
        const cat = (document.getElementById('drawerProductCategory')?.value || '').trim();
        const price = parseFloat(document.getElementById('drawerProductPrice')?.value || 0);
        if (!name || !cat || !price || isNaN(price) || price <= 0) {
          alert('Compila nome, categoria e prezzo correttamente.');
          return;
        }
        const product = {
          id: app.generateId ? app.generateId() : ('p_' + Date.now()),
          name, category: cat, price
        };
        if (app && typeof app.addProductToCart === 'function') {
          app.addProductToCart(product);
        } else {
          // fallback local
          if (!app.currentCart) app.currentCart = [];
          app.currentCart.push(product);
          document.dispatchEvent(new CustomEvent('app:cart-changed', { detail: app.currentCart }));
        }
        // reset drawer
        document.getElementById('drawerProductName').value = '';
        document.getElementById('drawerProductCategory').value = '';
        document.getElementById('drawerProductPrice').value = '';
        closeDrawer();
      });
    })();

    /***** Floating camera button opens scanner modal (reuse existing functions) *****/
    document.addEventListener('DOMContentLoaded', () => {
      const camBtn = document.getElementById('floatingCameraBtn');
      camBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          // openScannerModal is defined earlier in the page script
          if (typeof openScannerModal === 'function') {
            await openScannerModal();
          } else {
            // fallback: trigger existing scan button
            document.getElementById('scanBarcodeBtn')?.click();
          }
        } catch (err) {
          console.warn('Impossibile aprire scanner', err);
          if (confirm('Impossibile aprire la fotocamera. Vuoi inserire manualmente il codice a barre?')) {
            manualBarcodePrompt();
          }
        }
      });
    });

    /***** Ensure cart display updates when app fires event (existing function updateCartDisplay is present) *****/
    document.addEventListener('app:cart-changed', (e) => {
      try { updateCartDisplay(); } catch (err) { console.warn('updateCartDisplay not available', err); }
    });

    // small helper to populate storeSelect when user skipped store choice
    document.addEventListener('DOMContentLoaded', () => {
      try { app.populateAllStoreSelects(); } catch (e) {}
      // wire scan buttons already in the original script
    });
  </script>

  <!-- Tutto il JS di aggiungi (scanner, cart, autocomplete) - mantenuto identico e collocato qui -->
</body>
</html>