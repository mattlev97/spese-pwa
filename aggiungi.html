<!DOCTYPE html>

<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggiungi Spesa</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#4CAF50">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üõçÔ∏è Aggiungi Spesa</h1>
        <nav>
            <a href="index.html">Dashboard</a>
            <a href="aggiungi.html" class="nav-active">Aggiungi</a>
            <a href="archivio.html">Archivio</a>
        </nav>
    </header>

```
<main class="add-expense">
    <form id="expenseForm" class="expense-form">
        <div class="form-section">
            <h2>üè™ Informazioni Generali</h2>
            
            <div class="form-group">
                <label for="storeSelect">Supermercato:</label>
                <select id="storeSelect" required>
                    <option value="">Seleziona supermercato</option>
                    <option value="Conad">Conad</option>
                    <option value="Coop">Coop</option>
                    <option value="Esselunga">Esselunga</option>
                    <option value="Eurospin">Eurospin</option>
                    <option value="Carrefour">Carrefour</option>
                    <option value="Lidl">Lidl</option>
                    <option value="MD">MD</option>
                    <option value="Pam">Pam</option>
                    <option value="Simply">Simply</option>
                    <option value="Iper">Iper</option>
                    <option value="Altro">Altro (specificare sotto)</option>
                </select>
            </div>

            <div class="form-group" id="customStoreGroup" style="display: none;">
                <label for="customStore">Nome supermercato:</label>
                <input type="text" id="customStore" placeholder="Inserisci nome supermercato">
            </div>

            <div class="form-group">
                <label for="expenseDate">Data:</label>
                <input type="date" id="expenseDate" required>
            </div>
        </div>

        <div class="form-section">
            <h2>üõí Aggiungi Prodotti</h2>
            
            <div class="product-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="productCategory">Tipologia:</label>
                        <select id="productCategory" required>
                            <option value="">Seleziona tipologia</option>
                            <option value="Carne">ü•© Carne</option>
                            <option value="Pesce">üêü Pesce</option>
                            <option value="Verdura">ü•¨ Verdura</option>
                            <option value="Frutta">üçé Frutta</option>
                            <option value="Latticini">üßÄ Latticini</option>
                            <option value="Pane">üçû Pane e Cereali</option>
                            <option value="Bevande">ü•§ Bevande</option>
                            <option value="Surgelati">üßä Surgelati</option>
                            <option value="Dolci">üç∞ Dolci</option>
                            <option value="Pulizia">üßΩ Prodotti Pulizia</option>
                            <option value="Igiene">üß¥ Igiene Personale</option>
                            <option value="Altro">üì¶ Altro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productName">Nome prodotto:</label>
                        <input type="text" id="productName" placeholder="Es. Pomodori" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productPrice">Prezzo (‚Ç¨):</label>
                        <input type="number" id="productPrice" step="0.01" min="0" placeholder="0.00" required>
                    </div>

                    <div class="form-group">
                        <label for="productPriceKg">Prezzo/kg (‚Ç¨):</label>
                        <input type="number" id="productPriceKg" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label for="productNotes">Note:</label>
                    <input type="text" id="productNotes" placeholder="Note aggiuntive (opzionale)">
                </div>

                <button type="button" id="addProductBtn" class="btn btn-secondary">
                    ‚ûï Aggiungi Prodotto al Carrello
                </button>
            </div>
        </div>

        <div class="cart-section" id="cartSection" style="display: none;">
            <h2>üõí Carrello</h2>
            <div class="cart-table-container">
                <table id="cartTable">
                    <thead>
                        <tr>
                            <th>Prodotto</th>
                            <th>Prezzo</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="cartBody">
                    </tbody>
                </table>
            </div>
            <div class="cart-total">
                <strong>Totale: ‚Ç¨<span id="cartTotal">0.00</span></strong>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" id="saveExpenseBtn" class="btn btn-primary" disabled>
                üíæ Salva Spesa Completa
            </button>
            <button type="button" id="clearCartBtn" class="btn btn-danger">
                üóëÔ∏è Svuota Carrello
            </button>
        </div>
    </form>
</main>

<!-- JavaScript incorporato -->
<script>
    // TEST INIZIALE
    alert('üîß JavaScript caricato! Versione incorporata.');
    
    // Gestione spese - App principale
    class ExpenseTracker {
        constructor() {
            this.expenses = this.loadExpenses();
            this.currentCart = [];
            this.deleteExpenseId = null;
        }

        loadExpenses() {
            const stored = localStorage.getItem('expenses');
            return stored ? JSON.parse(stored) : [];
        }

        saveExpenses() {
            localStorage.setItem('expenses', JSON.stringify(this.expenses));
        }

        generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        addExpense(store, date, products) {
            const expense = {
                id: this.generateId(),
                store,
                date,
                products: [...products],
                total: products.reduce((sum, p) => sum + parseFloat(p.price || 0), 0),
                createdAt: new Date().toISOString()
            };
            
            this.expenses.push(expense);
            this.saveExpenses();
            return expense;
        }

        formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount || 0);
        }
    }

    // Istanza globale
    const app = new ExpenseTracker();
    alert('‚úÖ App creata: ' + typeof app);

    // Funzione helper per escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    function addProductToCart() {
        alert('üõí INIZIO: Funzione addProductToCart chiamata');
        
        // Ottieni elementi
        const categoryEl = document.getElementById('productCategory');
        const nameEl = document.getElementById('productName');
        const priceEl = document.getElementById('productPrice');
        const priceKgEl = document.getElementById('productPriceKg');
        const notesEl = document.getElementById('productNotes');

        // Verifica che gli elementi esistano
        if (!categoryEl || !nameEl || !priceEl) {
            alert('‚ùå ERRORE: Elementi form non trovati!');
            return;
        }

        alert('‚úÖ ELEMENTI TROVATI: Tutti gli elementi del form esistono');

        // Ottieni valori
        const category = categoryEl.value ? categoryEl.value.trim() : '';
        const name = nameEl.value ? nameEl.value.trim() : '';
        const priceValue = priceEl.value ? priceEl.value.trim() : '';
        const price = parseFloat(priceValue);
        const priceKg = priceKgEl ? (parseFloat(priceKgEl.value) || null) : null;
        const notes = notesEl ? (notesEl.value ? notesEl.value.trim() : '') : '';

        alert('üìù VALORI:\nCategoria: "' + category + '"\nNome: "' + name + '"\nPrezzo: "' + priceValue + '" ‚Üí ' + price);

        // Validazione
        if (!category) {
            alert('‚ö†Ô∏è Seleziona una tipologia di prodotto');
            return;
        }

        if (!name) {
            alert('‚ö†Ô∏è Inserisci il nome del prodotto');
            return;
        }

        if (!priceValue || isNaN(price) || price <= 0) {
            alert('‚ö†Ô∏è Inserisci un prezzo valido maggiore di 0');
            return;
        }

        alert('‚úÖ VALIDAZIONE SUPERATA');

        // Crea prodotto
        const product = {
            id: app.generateId(),
            category,
            name,
            price: price,
            priceKg: priceKg,
            notes: notes
        };

        // Aggiungi al carrello
        const before = app.currentCart.length;
        app.currentCart.push(product);
        const after = app.currentCart.length;

        alert('üõí CARRELLO: ' + before + ' ‚Üí ' + after + ' prodotti');

        // Aggiorna display
        updateCartDisplay();
        clearProductForm();
        
        alert('üéâ PRODOTTO AGGIUNTO CON SUCCESSO!');
    }

    function updateCartDisplay() {
        alert('üîÑ Aggiornando display carrello...');
        
        const cartSection = document.getElementById('cartSection');
        const cartBody = document.getElementById('cartBody');
        const cartTotal = document.getElementById('cartTotal');
        const saveBtn = document.getElementById('saveExpenseBtn');

        if (!cartSection || !cartBody || !cartTotal || !saveBtn) {
            alert('‚ùå Elementi carrello mancanti!');
            return;
        }

        if (app.currentCart.length === 0) {
            cartSection.style.display = 'none';
            saveBtn.disabled = true;
            return;
        }

        cartSection.style.display = 'block';
        saveBtn.disabled = false;

        // Aggiorna tabella
        let htmlContent = '';
        app.currentCart.forEach((product) => {
            htmlContent += '<tr><td><strong>' + escapeHtml(product.name) + '</strong><br><small>' + escapeHtml(product.category) + '</small></td><td><strong>' + app.formatCurrency(product.price) + '</strong></td><td><button onclick="removeFromCart(\'' + product.id + '\')">üóëÔ∏è</button></td></tr>';
        });

        cartBody.innerHTML = htmlContent;

        // Totale
        const total = app.currentCart.reduce((sum, product) => sum + product.price, 0);
        cartTotal.textContent = app.formatCurrency(total);
        
        alert('‚úÖ Carrello mostrato: ' + app.currentCart.length + ' prodotti, totale ' + app.formatCurrency(total));
    }

    function clearProductForm() {
        document.getElementById('productCategory').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productPriceKg').value = '';
        document.getElementById('productNotes').value = '';
    }

    function removeFromCart(productId) {
        app.currentCart = app.currentCart.filter(product => product.id !== productId);
        updateCartDisplay();
    }

    function clearCart() {
        if (confirm('Svuotare il carrello?')) {
            app.currentCart = [];
            updateCartDisplay();
        }
    }

    function saveExpense() {
        const store = document.getElementById('storeSelect').value;
        const date = document.getElementById('expenseDate').value;

        if (!store || !date || app.currentCart.length === 0) {
            alert('Compila tutti i campi e aggiungi prodotti');
            return;
        }

        app.addExpense(store, date, app.currentCart);
        alert('‚úÖ Spesa salvata!');
        
        // Reset
        document.getElementById('expenseForm').reset();
        app.currentCart = [];
        updateCartDisplay();
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    }

    // Inizializzazione
    document.addEventListener('DOMContentLoaded', function() {
        alert('üì± DOM caricato, inizializzazione...');
        
        // Imposta data
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        
        // Event listeners
        document.getElementById('addProductBtn').addEventListener('click', function(e) {
            e.preventDefault();
            alert('üñ±Ô∏è CLICK BOTTONE RILEVATO!');
            addProductToCart();
        });

        document.getElementById('saveExpenseBtn').addEventListener('click', function(e) {
            e.preventDefault();
            saveExpense();
        });

        document.getElementById('clearCartBtn').addEventListener('click', function(e) {
            e.preventDefault();
            clearCart();
        });

        alert('üéâ Tutto pronto! Prova ad aggiungere un prodotto.');
    });
</script>
```

</body>
</html>